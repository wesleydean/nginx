<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- Content Security Policy for local development -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https://balanced-shiner-88.clerk.accounts.dev https://clerk.com https://*.clerk.com https://clerk-telemetry.com https://*.clerk-telemetry.com https://api.stripe.com https://*.js.stripe.com https://js.stripe.com https://maps.googleapis.com https://*.sentry-cdn.com https://*.sentry.io https://challenges.cloudflare.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com https://www.gstatic.com; media-src 'self' data:; worker-src 'self' blob:;">
    <title>Expense Tracker</title>
    
    <!-- Web App Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS specific meta tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Expenses">
    
    <!-- Capacitor and haptic feedback support -->
    <script src="capacitor.js"></script>
    <script src="haptics.js"></script>
    <script src="haptic-debug.js"></script>
    
    <!-- iOS icons -->
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icons/icon-167x167.png">
    
    <!-- iOS splash screens -->
    <link rel="apple-touch-startup-image" href="icons/apple-splash-2048-2732.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="icons/apple-splash-1668-2388.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="icons/apple-splash-1536-2048.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="icons/apple-splash-1125-2436.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="icons/apple-splash-1242-2688.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="icons/apple-splash-828-1792.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="icons/apple-splash-1242-2208.png" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="icons/apple-splash-750-1334.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="icons/apple-splash-640-1136.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    
    <!-- Theme color for browser chrome -->
    <meta name="theme-color" content="#3b82f6">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
     <script
        async
        crossorigin="anonymous"
        data-clerk-publishable-key="pk_test_YmFsYW5jZWQtc2hpbmVyLTg4LmNsZXJrLmFjY291bnRzLmRldiQ" 
        src="https://balanced-shiner-88.clerk.accounts.dev/npm/@clerk/clerk-js@5/dist/clerk.browser.js"
        type="text/javascript">
    </script>
    <script>
        // Initialize Lucide icons when the DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeLucideIcons();
            
            // Add additional retries with increasing delays
            setTimeout(initializeLucideIcons, 500);
            setTimeout(initializeLucideIcons, 1000);
        });
        
        function initializeLucideIcons() {
            if (window.lucide && typeof window.lucide.createIcons === 'function') {
                try {
                    window.lucide.createIcons();
                    console.log('Lucide icons initialized successfully');
                } catch (error) {
                    console.error('Error initializing Lucide icons:', error);
                }
            } else {
                console.warn('Lucide not loaded yet, retrying...');
                setTimeout(initializeLucideIcons, 100);
            }
        }
    </script>
    
    <style>
        
        #user-button {
            /* position: absolute; */
            z-index: 100;
            top: 15px;
            left: 15px;
        }
        /* shadcn/ui Design System */
        :root {
            /* Colors */
            --background: 0 0% 100%;
            --foreground: 222.2 84% 4.9%;
            --card: 0 0% 100%;
            --card-foreground: 222.2 84% 4.9%;
            --popover: 0 0% 100%;
            --popover-foreground: 222.2 84% 4.9%;
            --primary: 221.2 83.2% 53.3%;
            --primary-foreground: 210 40% 98%;
            --secondary: 210 40% 96%;
            --secondary-foreground: 222.2 84% 4.9%;
            --muted: 210 40% 96%;
            --muted-foreground: 215.4 16.3% 46.9%;
            --accent: 210 40% 96%;
            --accent-foreground: 222.2 84% 4.9%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 40% 98%;
            --border: 214.3 31.8% 91.4%;
            --input: 214.3 31.8% 91.4%;
            --ring: 221.2 83.2% 53.3%;
            --radius: 0.5rem;
            
            /* Success & Warning */
            --success: 142.1 76.2% 36.3%;
            --success-foreground: 210 40% 98%;
            --warning: 47.9 95.8% 53.1%;
            --warning-foreground: 26 83.3% 14.1%;
        }
        
        /* Dark Mode */
        @media (prefers-color-scheme: dark) {
            :root {
                --background: 222.2 84% 4.9%;
                --foreground: 210 40% 98%;
                --card: 222.2 84% 4.9%;
                --card-foreground: 210 40% 98%;
                --primary: 217.2 91.2% 59.8%;
                --primary-foreground: 222.2 84% 4.9%;
                --secondary: 217.2 32.6% 17.5%;
                --secondary-foreground: 210 40% 98%;
                --muted: 217.2 32.6% 17.5%;
                --muted-foreground: 215 20.2% 65.1%;
                --accent: 217.2 32.6% 17.5%;
                --accent-foreground: 210 40% 98%;
                --destructive: 0 62.8% 30.6%;
                --destructive-foreground: 210 40% 98%;
                --border: 217.2 32.6% 17.5%;
                --input: 217.2 32.6% 17.5%;
                --ring: 224.3 76.3% 94.1%;
            }
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            border-color: hsl(var(--border));
            /* Disable text selection and improve mobile touch behavior */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            /* Optimize touch behavior for mobile */
            -webkit-touch-callout: none;
            -webkit-touch-action: manipulation;
            touch-action: manipulation;
        }
        
        /* Allow text selection for specific elements that need it */
        input, textarea, [contenteditable="true"], .selectable-text {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        
        /* Prevent text selection on buttons and interactive elements */
        button, .btn, .swipe-container, .expense-item, .balance-item, .card {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-touch-action: manipulation;
            touch-action: manipulation;
        }
        
        /* Disable context menu on long press for mobile */
        * {
            -webkit-touch-callout: none;
        }
        
        /* Improve touch targets for mobile */
        .btn, button, .swipe-container, .expense-item, .balance-item {
            min-height: 44px; /* iOS recommended minimum touch target */
            min-width: 44px;
        }
        
        /* Ensure all form elements have minimum touch target size */
        input, select, textarea, .form-input, .date-input, .select-trigger, .date-picker-trigger, .datepicker-trigger {
            min-height: 44px; /* iOS recommended minimum touch target */
        }
        
        /* Disable hover effects on touch devices */
        @media (hover: none) and (pointer: coarse) {
            .btn:hover, button:hover, .swipe-action:hover {
                background-color: inherit;
            }
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            height: 100vh;
            overflow: hidden;
            font-feature-settings: "rlig" 1, "calt" 1;
        }
        
        /* Button Components */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 150ms ease;
            cursor: pointer;
            user-select: none;
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
            text-decoration: none;
        }
        
        .btn:disabled {
            pointer-events: none;
            opacity: 0.5;
        }
        
        .btn:focus-visible {
            outline: 2px solid hsl(var(--ring));
            outline-offset: 2px;
        }
        
        .btn-primary {
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
        }
        
        .btn-primary:hover {
            background-color: hsl(var(--primary) / 0.9);
        }
        
        .btn-secondary {
            background-color: hsl(var(--secondary));
            color: hsl(var(--secondary-foreground));
        }
        
        .btn-secondary:hover {
            background-color: hsl(var(--secondary) / 0.8);
        }
        
        .btn-outline {
            border: 1px solid hsl(var(--border));
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
        }
        
        .btn-outline:hover {
            background-color: hsl(var(--accent));
            color: hsl(var(--accent-foreground));
        }
        
        .btn-ghost {
            background-color: transparent;
            color: hsl(var(--foreground));
        }
        
        .btn-ghost:hover {
            background-color: hsl(var(--accent));
            color: hsl(var(--accent-foreground));
        }
        
        .btn-destructive {
            background-color: hsl(var(--destructive));
            color: hsl(var(--destructive-foreground));
        }
        
        .btn-destructive:hover {
            background-color: hsl(var(--destructive) / 0.9);
        }
        
        /* Button Sizes */
        .btn-sm {
            height: 2rem;
            padding: 0 0.75rem;
            font-size: 0.8rem;
        }
        
        .btn-md {
            height: 2.5rem;
            padding: 0 1rem;
        }
        
        .btn-lg {
            height: 2.75rem;
            padding: 0 2rem;
        }
        
        .btn-icon {
            height: 2.5rem;
            width: 2.5rem;
            padding: 0;
        }
        
        /* Card Components */
        .card {
            background-color: hsl(var(--card));
            color: hsl(var(--card-foreground));
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            padding: .2rem;
        }
        
        /* Today view: remove borders and shadows from main cards */
        .today-view .card {
            border: none;
            box-shadow: none;
            background-color: transparent;
        }
        
        /* Keep borders for specific cards in today view that need them */
        .today-view .expense-item {
            border: 1px solid hsl(var(--border));
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        
        .today-view .balance-item {
            border: 1px solid hsl(var(--border));
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        
        /* Month view: remove borders and shadows from main cards */
        .card {
            border: none;
            box-shadow: none;
            background-color: transparent;
        }
        
        /* Keep borders for specific cards that need them */
        .expense-item {
            display: flex;
            flex: 1;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            transition: transform 0.12s, background-color 0.16s;
            cursor: pointer;
        }
        
        .expense-item:active {
            transform: scale(0.98);
            background-color: hsl(var(--muted));
        }
        
        .balance-item {
            border: 1px solid hsl(var(--border));
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        
        /* Swipe to Delete Functionality */
        .swipe-container {
            position: relative;
            overflow: hidden;
            border-radius: var(--radius);
            margin-bottom: 0.5rem;
            background-color: hsl(var(--destructive));
            border: none;
        }
        
        .swipe-content {
            position: relative;
            background-color: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            box-shadow: none;
            transform: translateX(0);
            transition: transform 0.2s ease;
            z-index: 2;
            border-radius: var(--radius);
            width: 100%;
            will-change: transform;
        }
        
        /* .swipe-action {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 80px;
            background-color: hsl(var(--destructive));
            display: flex;
            align-items: center;
            justify-content: center;
            color: hsl(var(--destructive-foreground));
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            z-index: 0;
            border-radius: 0 var(--radius) var(--radius) 0;
            -webkit-tap-highlight-color: rgba(255,255,255,0.3);
            touch-action: manipulation;
        } */
         .swipe-action {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            background-color: hsl(var(--destructive));
            color: hsl(var(--destructive-foreground));
            width: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            z-index: 1;
            border-radius: 0 var(--radius) var(--radius) 0;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            z-index: 0;
            border-radius: 0 var(--radius) var(--radius) 0;
            -webkit-tap-highlight-color: rgba(255,255,255,0.3);
            touch-action: manipulation;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            z-index: 0; /* Higher z-index to ensure it's above other elements */
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            touch-action: none; /* Disable browser handling of all panning and zooming gestures */
        }
        
        .swipe-action:hover {
            background-color: hsl(var(--destructive) / 0.9);
        }
        
        .swipe-container.swiped .swipe-content {
            transform: translateX(-80px);
            border-right: none;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }
        
        .swipe-container.deleting {
            animation: fade-out 0.45s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            pointer-events: none;
            overflow: hidden;
        }
        
        .swipe-container.deleting .swipe-content {
            opacity: 0;
            transition: opacity 0.45s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes fade-out {
            0% {
                height: auto;
                margin-bottom: 0.5rem;
                opacity: 1;
            }
            70% {
                height: auto;
                margin-bottom: 0.5rem;
                opacity: 0;
            }
            100% {
                height: 0;
                margin-bottom: 0;
                opacity: 0;
            }
        }
        
        /* Hide original delete buttons when swipe is enabled */
        .swipe-container .delete-btn,
        .swipe-container .delete-balance-btn {
            display: none;
        }
        
        /* Items inside swipe containers should fill the container completely */
        .swipe-container .expense-item {
            border: none;
            box-shadow: none;
            background-color: hsl(var(--card));
            width: 100%;
            margin: 0;
            height: 100%;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
        }
        
        .swipe-container .balance-item {
            border: none;
            box-shadow: none;
            background-color: hsl(var(--card));
            width: 100%;
            margin: 0;
            height: 100%;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
        }
        
        /* Keep borders for slide-out content and modals */
        .slide-out-content .card,
        .modal-content .card,
        .account-management-content .card {
            border: 1px solid hsl(var(--border));
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            background-color: hsl(var(--card));
        }
        
        /* Give stat cards a subtle background for better visual separation */
        .stat-card {
            background-color: hsl(var(--muted) / 0.3);
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            text-align: left;
            align-items: flex-start;
            padding: 1rem;
        }
        .stat-card > div {
            text-align: left;
            margin-left: 0 !important;
            padding-left: 0 !important;
        }
        .stat-card .text-sm,
        .stat-card .text-2xl,
        .stat-card .stat-label,
        .stat-card .stat-value {
            text-align: left;
            margin-left: 0 !important;
            padding-left: 0 !important;
        }
        
        .card-header {
            position: sticky;
            display: flex;
            flex-direction: row;
            align-items: center;
            padding-bottom: 1rem;
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            line-height: 1;
            margin: 0;
            color: hsl(var(--foreground));
        }
        
        .card-description {
            font-size: 0.875rem;
            color: hsl(var(--muted-foreground));
            margin-top: 0.375rem;
        }
        
        .card-content {
            padding: 0;
        }
        
        /* Form Components */
        .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 0.75rem; /* consistent spacing */
        }
        
        .form-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: hsl(var(--foreground));
            margin-bottom: 0.5rem;
        }
        
        .form-input {
            display: flex;
            height: 2.5rem;
            min-height: 44px; /* iOS recommended minimum touch target */
            width: 100%;
            border-radius: var(--radius);
            border: 1px solid hsl(var(--border));
            background-color: hsl(var(--background));
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            transition: all 150ms ease;
            color: hsl(var(--foreground));
        }
        
        .form-input:focus {
            outline: 2px solid hsl(var(--ring));
            outline-offset: 2px;
            border-color: hsl(var(--ring));
        }
        
        .form-input[rows] {
            resize: vertical;
            min-height: 120px;
        }
        
        .form-input:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .form-input[readonly] {
            background-color: hsl(var(--muted));
            color: hsl(var(--muted-foreground));
            cursor: not-allowed;
        }
        
        .form-input::placeholder {
            color: hsl(var(--muted-foreground));
        }
        
        /* Custom Select Component */
        .select-container {
            position: relative;
        }
        
        .select-trigger {
            display: flex;
            height: 2.5rem;
            min-height: 44px; /* iOS recommended minimum touch target */
            width: 100%;
            align-items: center;
            justify-content: space-between;
            border-radius: var(--radius);
            border: 1px solid hsl(var(--border));
            background-color: hsl(var(--background));
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            color: hsl(var(--foreground));
            cursor: pointer;
            transition: all 150ms ease;
            user-select: none;
        }
        
        .select-trigger:hover {
            background-color: hsl(var(--accent));
        }
        
        .select-trigger:focus {
            outline: 2px solid hsl(var(--ring));
            outline-offset: 2px;
            border-color: hsl(var(--ring));
        }
        
        .select-trigger[aria-expanded="true"] {
            background-color: hsl(var(--accent));
            border-color: hsl(var(--ring));
        }
        
        .select-content {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 50;
            background-color: hsl(var(--popover));
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            margin-top: 0.25rem;
            max-height: 200px;
            overflow-y: auto;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 150ms ease;
            pointer-events: none;
        }
        
        .select-content.open {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        
        .select-item {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 150ms ease;
            color: hsl(var(--foreground));
        }
        
        .select-item:hover {
            background-color: hsl(var(--accent));
        }
        
        .select-item.selected {
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
        }
        
        .select-item:first-child {
            border-radius: var(--radius) var(--radius) 0 0;
        }
        
        .select-item:last-child {
            border-radius: 0 0 var(--radius) var(--radius);
        }
        
        /* Date Input Styling */
        .date-input {
            display: flex;
            height: 2.5rem;
            min-height: 44px; /* iOS recommended minimum touch target */
            width: 100%;
            border-radius: var(--radius);
            border: 1px solid hsl(var(--border));
            background-color: hsl(var(--background));
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            transition: all 150ms ease;
            color: hsl(var(--foreground));
            cursor: pointer;
        }
        
        .date-input:focus {
            outline: 2px solid hsl(var(--ring));
            outline-offset: 2px;
            border-color: hsl(var(--ring));
        }
        
        /* Hide native date picker styling */
        .date-input::-webkit-calendar-picker-indicator {
            background: transparent;
            bottom: 0;
            color: transparent;
            cursor: pointer;
            height: auto;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            width: auto;
        }
        
        .date-input::-webkit-inner-spin-button,
        .date-input::-webkit-clear-button {
            display: none;
        }
        
        /* Custom Date Picker Styles */
        .date-picker-container {
            position: relative;
        }

        .date-picker-trigger {
            display: flex;
            height: 2.5rem;
            min-height: 44px; /* iOS recommended minimum touch target */
            width: 100%;
            align-items: center;
            justify-content: space-between;
            border-radius: var(--radius);
            border: 1px solid hsl(var(--border));
            background-color: hsl(var(--background));
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            color: hsl(var(--foreground));
            cursor: pointer;
            transition: all 150ms ease;
            user-select: none;
        }

        .date-picker-trigger:hover {
            background-color: hsl(var(--accent));
        }

        .date-picker-trigger:focus {
            outline: 2px solid hsl(var(--ring));
            outline-offset: 2px;
            border-color: hsl(var(--ring));
        }

        .date-picker-trigger[aria-expanded="true"] {
            background-color: hsl(var(--accent));
            border-color: hsl(var(--ring));
        }

        .date-picker-content {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 50;
            background-color: hsl(var(--popover));
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            margin-top: 0.25rem;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 150ms ease;
            pointer-events: none;
            padding: 1rem;
            min-width: 280px;
        }

        .date-picker-content.open {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .date-picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .date-picker-nav {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .date-picker-nav-btn {
            background-color: transparent;
            border: none;
            width: 2rem;
            height: 2rem;
            border-radius: var(--radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            color: hsl(var(--foreground));
            transition: all 150ms ease;
        }

        .date-picker-nav-btn:hover {
            background-color: hsl(var(--accent));
        }

        .date-picker-nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .date-picker-month-year {
            font-size: 0.875rem;
            font-weight: 500;
            color: hsl(var(--foreground));
            min-width: 120px;
            text-align: center;
        }

        .date-picker-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.125rem;
        }

        .date-picker-day-header {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 2rem;
            font-size: 0.75rem;
            font-weight: 500;
            color: hsl(var(--muted-foreground));
        }

        .date-picker-day {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 2rem;
            font-size: 0.875rem;
            cursor: pointer;
            border-radius: var(--radius);
            transition: all 150ms ease;
            color: hsl(var(--foreground));
            background-color: transparent;
            border: none;
        }

        .date-picker-day:hover {
            background-color: hsl(var(--accent));
        }

        .date-picker-day.today {
            background-color: hsl(var(--accent));
            font-weight: 600;
        }

        .date-picker-day.selected {
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
        }

        .date-picker-day.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .date-picker-day.disabled:hover {
            background-color: transparent;
        }

        .date-picker-day.other-month {
            opacity: 0.5;
        }

        .date-picker-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid hsl(var(--border));
        }

        .date-picker-today-btn {
            background-color: hsl(var(--secondary));
            color: hsl(var(--secondary-foreground));
            border: none;
            padding: 0.375rem 0.75rem;
            border-radius: var(--radius);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 150ms ease;
        }

        .date-picker-today-btn:hover {
            background-color: hsl(var(--secondary) / 0.8);
        }

        .date-picker-clear-btn {
            background-color: transparent;
            color: hsl(var(--muted-foreground));
            border: none;
            padding: 0.375rem 0.75rem;
            border-radius: var(--radius);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 150ms ease;
        }

        .date-picker-clear-btn:hover {
            background-color: hsl(var(--accent));
            color: hsl(var(--foreground));
        }
        
        /* Period dropdown custom styling */
        .period-dropdown {
            display: none; /* Hide native select */
        }
        
        .period-select-container {
            position: relative;
            min-width: 120px;
        }
        
        .period-select-trigger {
            display: flex;
            height: 2rem;
            align-items: center;
            justify-content: space-between;
            border-radius: var(--radius);
            border: 1px solid hsl(var(--border));
            background-color: hsl(var(--background));
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: hsl(var(--foreground));
            cursor: pointer;
            transition: all 150ms ease;
            user-select: none;
            gap: 0.5rem;
        }
        
        .period-select-trigger:hover {
            background-color: hsl(var(--accent));
        }
        
        .period-select-trigger:focus {
            outline: 2px solid hsl(var(--ring));
            outline-offset: 2px;
            border-color: hsl(var(--ring));
        }
        
        .period-select-content {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 50;
            background-color: hsl(var(--popover));
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            margin-top: 0.25rem;
            max-height: 200px;
            overflow-y: auto;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 150ms ease;
            pointer-events: none;
        }
        
        .period-select-content.open {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        
        .period-select-item {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 150ms ease;
            color: hsl(var(--foreground));
        }
        
        .period-select-item:hover {
            background-color: hsl(var(--accent));
        }
        
        .period-select-item.selected {
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
        }
        
        /* Utility Classes */
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .text-base { font-size: 1rem; line-height: 1.5rem; }
        .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
        .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
        .text-2xl { font-size: 1.5rem; line-height: 2rem; }
        .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
        
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        
        /* Lucide Icon Fallbacks */
        [data-lucide] {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 1em;
            width: 1em;
            color: hsl(var(--foreground)); /* Set icons to use the foreground color by default */
        }
        
        /* Icon color handling for specific icons */
        @media (prefers-color-scheme: light) {
            [data-lucide="settings"] {
                color: #000; /* Black in light mode */
            }
        }
        
        @media (prefers-color-scheme: dark) {
            [data-lucide="settings"] {
                color: hsl(var(--foreground)); /* Light color in dark mode */
            }
        }
        
        /* Always make icons in dark buttons (like Add Expense) white */
        .quick-action-card [data-lucide],
        .expense-btn [data-lucide],
        .balance-btn [data-lucide],
        .add-btn [data-lucide] {
            color: #ffffff;
        }
        
        /* Fallback text for when icons don't load */
        [data-lucide]:empty::before {
            content: 'â€¢';
            font-size: 1.2em;
        }
        
        .text-foreground { color: hsl(var(--foreground)); }
        .text-muted-foreground { color: hsl(var(--muted-foreground)); }
        .text-primary { color: hsl(var(--primary)); }
        .text-success { color: hsl(var(--success)); }
        .text-destructive { color: hsl(var(--destructive)); }
        
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        
        .p-2 { padding: 0.5rem; }
        .p-4 { padding: 1rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-2 { padding: 0.5rem 0; }
        .py-3 { padding: 0.75rem 0; }
        
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mr-2 { margin-right: 0.5rem; }
        
        .rounded { border-radius: var(--radius); }
        .rounded-lg { border-radius: var(--radius); }
        .rounded-full { border-radius: 9999px; }
        
        /* Icon Styles */
        .w-4 { width: 1rem; }
        .h-4 { height: 1rem; }
        .w-5 { width: 1.25rem; }
        .h-5 { height: 1.25rem; }
        .w-6 { width: 1.5rem; }
        .h-6 { height: 1.5rem; }
        
        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            background-color: hsl(var(--background));
        }
        
        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            background: #fff;
            position: relative;
            z-index: 10;
        }
        
        .app-header h1 {
            font-size: 1.3rem;
            font-weight: 600;
            color: hsl(var(--foreground));
            margin-bottom: 0.25rem;
        }
        
        .date-display {
            font-size: 0.875rem;
            color: hsl(var(--muted-foreground));
        }
        
        .content-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background-color: hsl(var(--background));
        }
        
        .screens-wrapper {
            display: flex;
            height: 100%;
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            will-change: transform;
        }
        
        .screen {
            width: 100vw;
            flex-shrink: 0;
            overflow-y: auto;
            padding: 1rem;
            padding-top: 0;;
            background-color: hsl(var(--background));
        }
        
        /* Remove old daily-budget styles - now using card classes */
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            margin-bottom: 1.5rem;
            margin-top: 1.5rem;
            padding: 0 1.5rem;
        }
        
        .action-btn {
            flex: 1;
            max-width: 200px;
        }
        
        .expense-btn {
            background-color: hsl(220, 13%, 18%);
            color: #ffffff;
        }
        
        .expense-btn:hover {
            background-color: hsl(220, 13%, 28%);
        }
        
        .balance-btn {
            background-color: hsl(220, 13%, 18%);
            color: #ffffff;
        }
        
        .balance-btn:hover {
            background-color: hsl(220, 13%, 28%);
        }
        
        /* Remove old action-label styles - using shadcn button styling */
        
        @media (max-width: 480px) {
            .action-buttons {
                padding: 0px;
                gap: 10px;
            }
            
            .action-btn {
                padding: 14px 16px;
                max-width: none;
            }
            
            .action-label {
                font-size: 0.85rem;
            }
        }
        
        .expense-input {
            margin-bottom: 25px;
        }
        
        .input-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .input-group {
            flex: 1;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: hsl(var(--foreground));
            font-size: 0.9rem;
        }
        
        .input-group input, .input-group select {
            width: 100%;
            min-height: 44px; /* iOS recommended minimum touch target */
            padding: 14px 16px;
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            font-size: 1rem;
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            transition: all 0.3s ease;
        }
        
        .input-group input:focus, .input-group select:focus {
            outline: 2px solid hsl(var(--ring));
            outline-offset: 2px;
            border-color: hsl(var(--ring));
        }
        
        .add-btn {
            background-color: hsl(220, 13%, 18%);
            color: #ffffff;
            border: none;
            padding: 10px 16px;
            border-radius: var(--radius);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            display: block;
        }
        
        .add-btn:hover {
            background-color: hsl(220, 13%, 28%);
        }
        
        .add-btn:active {
            transform: translateY(1px);
        }
        
        /* Settings menu add-btn styling */
        .settings-menu-btn-item .add-btn {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 1rem;
            font-size: 0.95rem;
            font-weight: 600;
            padding: 10px 16px;
            margin: 0;
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .settings-menu-btn-item .add-btn:hover {
            background-color: hsl(var(--primary) / 0.9);
        }
        
        .settings-menu-btn-item .add-btn:active {
            transform: translateY(1px);
        }
        
        .settings-menu-btn-item .add-btn .settings-menu-icon {
            color: #fff;
        }
        
        .expenses-list {
            /* max-height: 300px; */
            overflow-y: auto;
        }
        
        .expense-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background-color: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
        }
        
        .expense-details {
            flex: 1;
        }
        
        .expense-description {
            font-weight: 600;
            color: hsl(var(--foreground));
            margin-bottom: 2px;
        }
        
        .expense-category {
            font-size: 0.8rem;
            color: hsl(var(--muted-foreground));
            text-transform: capitalize;
        }
        
        .expense-amount {
            font-size: 1.1rem;
            font-weight: 700;
            color: hsl(var(--destructive));
        }
        
        .delete-btn {
            background-color: hsl(0deg 0% 95.88%);
            color: hsl(0deg 0% 24.54%);
            border: none;
            padding: 6px 10px;
            border-radius: var(--radius);
            font-size: 0.8rem;
            cursor: pointer;
            margin-left: 10px;
            transition: all 150ms ease;
        }
        
        .delete-btn:hover {
            background-color: hsl(var(--destructive) / 0.9);
        }
        
        .chart-container {
            /* Use .card class instead of custom styling */
            height: 350px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        /* Remove margin-bottom from stat cards since we're using gap */
        .stats-grid .stat-card {
            margin-bottom: 0;
        }
        
        .stat-card {
            /* Use .card class instead of custom styling */
            text-align: center;
            padding: 1rem;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: hsl(var(--muted-foreground));
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: hsl(var(--foreground));
        }
        
        .stat-subtitle {
            font-size: 0.75rem;
            color: hsl(var(--muted-foreground));
            margin-top: 4px;
            font-weight: 400;
        }
        
        .stat-subtitle.positive {
            color: hsl(var(--success));
        }
        
        .stat-subtitle.positive {
            color: hsl(var(--success));
        }
        
        .stat-value.positive {
            color: hsl(var(--success));
        }
        
        .stat-value.negative {
            color: hsl(var(--destructive));
        }
        
        .stat-value.warning {
            color: hsl(var(--warning));
        }
        
        .bottom-nav {
            background-color: hsl(var(--card));
            border-top: 1px solid hsl(var(--border));
            padding: 1.25rem 0; /* Further increased padding for iOS swipe bar clearance */
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
            position: relative;
        }
        
        .nav-item {
            display: flex;
            top: -6px;
            align-items: center;
            padding: 0.5rem;
            margin: 0 1.5rem; /* Increased margin for better spacing */
            cursor: pointer;
            transition: all 150ms ease, transform 0.12s;
            border-radius: var(--radius);
            user-select: none;
            color: hsl(var(--muted-foreground) / 0.5); /* More grayed out for inactive items */
            position: relative;
            opacity: 0.6; /* Additional opacity to ensure graying out */
        }
        
        .nav-item.active {
            color: hsl(var(--foreground)); /* Darker color for active item */
            font-weight: 500; /* Slightly bolder to enhance visibility */
            opacity: 1; /* Full opacity for active item */
        }
        
        .nav-item:hover:not(.active) {
            color: hsl(var(--foreground) / 0.8); /* Slightly darker on hover */
        }
        
        .nav-item:active {
            transform: scale(0.92);
        }
        
        .nav-item .icon {
            font-size: 1.3rem;
            transition: all 150ms ease;
            color: inherit; /* Ensure icon inherits the parent's color */
        }
        
        /* Make icon size slightly bigger for active state */
        .nav-item.active .icon {
            transform: scale(1.10);
        }
        
        /* Hide labels as requested */
        .nav-item .label {
            display: none;
        }
        
        .screen::-webkit-scrollbar {
            display: none;
        }
        
        .screen {
            -ms-overflow-style: none;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-good { background-color: hsl(var(--success)); }
        .status-warning { background-color: hsl(var(--warning)); }
        .status-danger { background-color: hsl(var(--destructive)); }
        
        .weekly-summary {
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
            text-align: center;
            margin-bottom: 20px;
            border-radius: var(--radius);
            padding: 1.5rem;
        }
        
        .weekly-summary h3 {
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .weekly-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
        }
        
        .weekly-stat {
            text-align: center;
        }
        
        .weekly-stat-value {
            font-size: 1.2rem;
            font-weight: 700;
        }
        
        .weekly-stat-label {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        /* period-selector uses .card class for styling */

        .period-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .period-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin: 0;
            color: hsl(var(--foreground));
        }

        /* Icon-only toggle for day/month - styled like chart-period-selector-bottom */
        .period-icon-toggle {
            display: flex;
            align-items: center;
            background: hsl(var(--muted));
            border-radius: calc(var(--radius) * 2.5);
            padding: 4px;
            margin-left: auto;
        }
        
        .period-icon-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 30px;
            border: none;
            background: transparent;
            border-radius: calc(var(--radius) * 2);
            cursor: pointer;
            transition: all 0.2s ease;
            color: hsl(var(--muted-foreground));
            padding: 0;
        }
        button.period-icon-btn {
            min-height: 0;
        }
        
        .period-icon-btn.active {
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .period-icon-btn:hover:not(.active) {
            color: hsl(var(--foreground));
        }
        
        .period-icon-btn:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        }

        /* Original period switch (to be hidden/replaced) */
        .period-switch {
            display: none; /* Hide the original switch */
        }

        .period-switch button {
            background-color: transparent;
            border: none;
            color: hsl(var(--muted-foreground));
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: color 0.2s ease;
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
        }

        .period-switch button.active {
            color: hsl(var(--foreground));
            background-color: hsl(var(--muted));
        }

        .month-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .month-nav-btn {
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
            border: none;
            width: 32px;
            height: 32px;
            border-radius: var(--radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .month-nav-btn:hover {
            background-color: hsl(var(--primary) / 0.9);
        }

        .month-nav-btn:disabled {
            background-color: hsl(var(--muted));
            color: hsl(var(--muted-foreground));
            cursor: not-allowed;
        }

        .selected-month {
            font-size: 1rem;
            font-weight: 600;
            color: hsl(var(--foreground));
            text-align: center;
            min-width: 120px;
        }
        
        .chart-period-selector {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
            padding: 4px;
            background-color: hsl(var(--muted));
            border-radius: var(--radius);
        }

        .chart-period-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: calc(var(--radius) - 2px);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            color: hsl(var(--muted-foreground));
            min-width: 60px;
        }

        .chart-period-btn.active {
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
        }

        .chart-period-btn:hover:not(.active) {
            background-color: hsl(var(--accent));
            color: hsl(var(--accent-foreground));
        }
        
        /* chart-container-wrapper uses .card class for styling */
        
        /* Enhanced Wealthsimple-style chart header */
        .chart-container-wrapper {
            margin-top: 20px;
            padding-top: 10px;
        }
        
        .chart-header {
            margin-bottom: 24px;
            padding: 0 6px;
        }
        
        /* Chart row container for savings and spending */
        .chart-row {
            margin-bottom: 16px;
        }
        
        .chart-row:last-child {
            margin-bottom: 0;
        }
        
        /* Savings row styling (black) */
        .savings-row .chart-main-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: hsl(var(--foreground));
            margin-bottom: 4px;
            line-height: 1;
            letter-spacing: -0.02em;
        }
        
        .savings-row .chart-subtitle {
            font-size: 1rem;
            color: hsl(var(--muted-foreground));
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .savings-row .chart-growth {
            font-size: 0.95rem;
            font-weight: 500;
            padding: 4px 0;
            margin-bottom: 8px;
        }
        
        /* Spending row styling (gray) */
        .spending-row .chart-main-value {
            font-size: 2rem;
            font-weight: 600;
            color: #6B7280; /* Gray color for spending */
            margin-bottom: 4px;
            line-height: 1;
            letter-spacing: -0.02em;
        }
        
        .spending-row .chart-subtitle {
            font-size: 0.9rem;
            color: #9CA3AF; /* Lighter gray for subtitle */
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .spending-row .chart-growth {
            font-size: 0.85rem;
            font-weight: 500;
            padding: 4px 0;
            margin-bottom: 8px;
            color: #6B7280; /* Gray color for spending growth */
        }
        
        /* Legacy styles for backward compatibility */
        .chart-main-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: hsl(var(--foreground));
            margin-bottom: 4px;
            line-height: 1;
            letter-spacing: -0.02em;
        }
        
        .chart-subtitle {
            font-size: 1rem;
            color: hsl(var(--muted-foreground));
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .chart-growth {
            font-size: 0.95rem;
            font-weight: 500;
            padding: 4px 0;
        }
        
        .chart-growth.positive {
            color: #10B981; /* Green for positive growth */
        }
        
        .chart-growth.negative {
            color: #EF4444; /* Red for negative growth */
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
            transition: opacity 0.2s ease;
        }
        
        .chart-container.loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 5;
        }
        
        .chart-container.loading::before {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(16, 185, 129, 0.2);
            border-radius: 50%;
            border-top-color: #10B981;
            animation: spin 0.8s linear infinite;
            z-index: 6;
            top: 50%;
            left: 50%;
            margin-top: -15px;
            margin-left: -15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Bottom Period Selector for Chart (Wealthsimple Style) */
        .chart-period-selector-bottom {
            display: flex;
            justify-content: center;
            gap: 0;
            margin-top: 24px;
            background-color: hsl(var(--muted));
            border-radius: calc(var(--radius) * 2.5);
            padding: 4px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }
        
        /* Enhanced Wealthsimple-style period selector buttons */
        .chart-period-btn-wealthsimple {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: calc(var(--radius) * 2);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            color: hsl(var(--muted-foreground));
            min-width: 50px;
            letter-spacing: 0.02em;
            position: relative;
            z-index: 1;
            min-height: 0;
        }
        
        .chart-period-btn-wealthsimple.active {
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            font-weight: 600;
        }
        
        .chart-period-btn-wealthsimple:hover:not(.active) {
            color: hsl(var(--foreground));
        }
        
        .chart-period-btn-wealthsimple:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        }
        
        /* Animate period button transitions */
        .chart-period-selector-bottom {
            position: relative;
        }
        
        @media (prefers-reduced-motion: no-preference) {
            .chart-period-btn-wealthsimple.active {
                animation: scaleIn 0.2s ease forwards;
            }
            
            @keyframes scaleIn {
                0% { transform: scale(0.95); }
                100% { transform: scale(1); }
            }
        }
        
        /* Sticky Period Selector for Tracking Screen */
        .period-selector-sticky {
            position: sticky;
            top: 0;
            z-index: 100;
            background-color: #ffffffa1; /* Semi-transparent white */
            border-bottom: 1px solid hsl(var(--border));
            backdrop-filter: blur(10px);
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            border-radius: 0;
            margin-bottom: 20px;
            border-radius: 10px;
        }
        
        .period-selector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Compact Toggle - Full Width */
        .period-mode-toggle-compact {
            display: flex;
            background: hsl(210deg 33.58% 90.82% / 36%);
            backdrop-filter: blur(10px);
            border-radius: var(--radius);
            padding: 2px;
            gap: 0.5rem;
            width: 100%;
            justify-content: space-between;
            align-items: center;
        }
        
        .period-mode-btn-compact {
            padding: 0.375rem 0.75rem;
            border: none;
            background: transparent;
            border-radius: calc(var(--radius) - 2px);
            font-size: 0.875rem;
            font-weight: 500;
            color: hsl(var(--muted-foreground));
            cursor: pointer;
            transition: all 150ms ease;
            flex: 1;
            min-width: 0;
        }
        
        .period-mode-btn-compact.active {
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            box-shadow: 0 1px 3px 0 rgb(0, 0, 0 / 0.1);
        }
        
        .period-mode-btn-compact:hover:not(.active) {
            background-color: hsl(var(--accent));
        }
        
        /* Spacer Icons - Evenly Distributed */
        .toggle-spacer-icons {
            display: flex;
            justify-content: space-evenly;
            align-items: center;
            flex: 1;
            gap: 0.5rem;
            padding: 0 0.5rem;
        }
        
        .toggle-spacer-icons i {
            color: hsl(var(--muted-foreground));
            opacity: 0.6;
            transition: all 150ms ease;
        }
        
        .toggle-spacer-icons i:hover {
            opacity: 1;
            color: hsl(var(--foreground));
        }
        
        /* Enhanced Wealthsimple-style chart overlay */
        .chart-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.15s ease;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
            /* Add subtle border and shadow for Wealthsimple look */
            border-radius: var(--radius);
            overflow: hidden;
            touch-action: pan-y; /* Allow vertical scrolling */
        }
        
        #spendingChart {
            touch-action: pan-y; /* Allow vertical scrolling */
            cursor: crosshair;
            padding: 10px 0;
        }
        
        /* Make chart more responsive to touch on mobile devices */
        @media (hover: none) and (pointer: coarse) {
            #spendingChart {
                cursor: default;
                padding: 15px 0; /* More padding on mobile for better touch area */
                touch-action: pan-y; /* Ensure vertical scrolling works on mobile */
            }
        }
        
        .chart-crosshair {
            position: absolute;
            width: 2px;
            height: 100%;
            background: #222;
            opacity: 0;
            z-index: 20;
            pointer-events: none;
            transition: opacity 0.15s ease, left 0.05s linear;
        }
        .chart-overlay.visible {
            opacity: 1;
        }
        @media (hover: none) and (pointer: coarse) {
            .chart-crosshair {
                width: 3px;
                background: #222;
            }
        }
        
        .chart-overlay.visible .chart-tooltip {
            opacity: 1;
            transform: translateY(0);
        }
        
        .tooltip-date {
            font-size: 0.95rem;
            color: #111827;
            margin-bottom: 12px;
            font-weight: 600;
            border-bottom: 1px solid rgba(230, 230, 230, 0.5);
            padding-bottom: 10px;
        }
        
        .tooltip-values {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .tooltip-value {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .tooltip-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .tooltip-dot.savings {
            background: #10B981; /* Match the green line color */
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        }
        
        .tooltip-dot.spending {
            background: #6B7280; /* Match the gray line color */
            box-shadow: 0 0 0 2px rgba(107, 114, 128, 0.2);
        }
        
        .tooltip-label {
            font-size: 0.85rem;
            color: #666;
            flex: 1;
        }
        
        .tooltip-value:first-child .tooltip-amount {
            color: #10B981; /* Green for savings */
            font-weight: 600;
        }
        
        .tooltip-value:last-child .tooltip-amount {
            color: #6B7280; /* Gray for spending */
            font-weight: 600;
        }
        
        .tooltip-amount {
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        /* Savings/Account tracking styles */
        .savings-accounts-section {
            margin-bottom: 20px;
            margin-top: 20px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .manage-accounts-btn {
            background-color: hsl(var(--secondary));
            color: hsl(var(--secondary-foreground));
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 150ms ease;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .manage-accounts-btn:hover {
            background-color: hsl(var(--secondary) / 0.8);
        }
        
        /* Mobile responsive for section header */
        @media (max-width: 480px) {
            .section-header h3 {
                font-size: 1.1rem;
            }
            
            .manage-accounts-btn {
                padding: 10px 14px;
                font-size: 0.85rem;
                min-height: 44px; /* Better touch target */
            }
        }
        
        .account-balance-input {
            margin-bottom: 15px;
        }
        
        .account-balance-input h4 {
            margin-bottom: 15px;
            color: hsl(var(--foreground));
            font-size: 1.1rem;
        }
        
        .balance-input-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        
        .balance-input-row .input-group {
            flex: 1;
            min-width: 120px;
        }
        
        .balance-input-row select {
            width: 100%;
            min-height: 44px; /* iOS recommended minimum touch target */
            padding: 14px 16px;
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            font-size: 1rem;
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            transition: all 0.3s ease;
        }
        
        .balance-input-row select:focus {
            outline: 2px solid hsl(var(--ring));
            outline-offset: 2px;
            border-color: hsl(var(--ring));
        }
        
        .balance-add-btn {
            background-color: hsl(220, 13%, 18%);
            color: #ffffff;
            border: none;
            padding: 10px 16px;
            border-radius: var(--radius);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            display: block;
        }
        
        .balance-add-btn:hover {
            background-color: hsl(220, 13%, 28%);
        }
        
        /* Mobile responsiveness for balance input */
        @media (max-width: 480px) {
            .balance-input-row {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            
            .balance-input-row .input-group {
                min-width: 100%;
            }
            
            .balance-add-btn {
                width: 100%;
                margin-top: 5px;
            }
        }
        
        .balance-add-btn:active {
            transform: translateY(1px);
        }
        
        .account-balance-display {
            border: 1px solid hsl(var(--border));
            padding: 15px;
            border-radius: var(--radius);
            margin-bottom: 15px;
            text-align: center;
        }
        
        .current-balance {
            font-size: 1.5rem;
            font-weight: 700;
            color: hsl(var(--success));
            margin-bottom: 5px;
        }
        
        /* Mobile responsiveness for balance display */
        @media (max-width: 480px) {
            .account-balance-display {
                padding: 12px;
            }
            
            .current-balance {
                font-size: 1.3rem;
            }
        }
        
        .balance-change {
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .balance-change.positive {
            color: #27ae60;
        }
        
        .balance-change.negative {
            color: #e74c3c;
        }
        
        .balance-change.neutral {
            color: #666;
        }
        
        .balance-history {
            max-height: none !important;
            overflow-y: visible !important;
        }
        
        .balance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background-color: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
        }
        
        .balance-details {
            flex: 1;
        }
        
        .balance-date {
            font-weight: 600;
            color: hsl(var(--foreground));
            margin-bottom: 2px;
        }
        
        .balance-account {
            font-size: 0.8rem;
            color: hsl(var(--muted-foreground));
        }
        
        .balance-amount {
            font-size: 1.1rem;
            font-weight: 700;
            color: hsl(var(--foreground));
        }
        
        .delete-balance-btn {
            background-color: hsl(0deg 0% 95.88%);
    color: hsl(0deg 0% 24.54%);
            border: none;
            padding: 4px 8px;
            border-radius: var(--radius);
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 150ms ease;
        }
        
        .delete-account-btn:hover {
            background-color: hsl(var(--destructive) / 0.9);
        }
        
        .add-account-form {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .add-account-form input {
            flex: 1;
            min-height: 44px; /* iOS recommended minimum touch target */
            padding: 10px;
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            font-size: 0.9rem;
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
        }
        
        .add-account-form input:focus {
            outline: 2px solid hsl(var(--ring));
            outline-offset: 2px;
            border-color: hsl(var(--ring));
        }
        
        .add-account-form button {
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
            border: none;
            padding: 10px 15px;
            border-radius: var(--radius);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 150ms ease;
        }
        
        .add-account-form button:hover {
            background-color: hsl(var(--primary) / 0.9);
        }
        
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: hsl(var(--card));
            color: hsl(var(--card-foreground));
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            padding: 24px;
            margin: 20px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: hsl(var(--foreground));
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        
        .modal-close:hover {
            background: rgba(0,0,0,0.1);
        }
        
        .account-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(0,0,0,0.03);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .account-name {
            font-weight: 500;
            color: hsl(var(--foreground));
        }
        
        .delete-account-btn {
            background-color: hsl(0deg 0% 95.88%);
            color: hsl(0deg 0% 24.54%);
            border: none;
            padding: 6px 12px;
            border-radius: var(--radius);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 150ms ease;
        }
        
        .delete-account-btn:hover {
            background-color: hsl(var(--destructive) / 0.9);
        }
        
        .add-account-form {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid hsl(var(--border));
        }
        
        .add-account-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: all 0.2s ease;
        }
        
        .add-account-btn:hover {
            background: #219a52;
        }
        
        /* Slide-out overlays */
        .slide-out-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 2000;
        }
        
        .slide-out-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .slide-out-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 20px 20px 40px;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .slide-out-overlay.active .slide-out-content {
            transform: translateY(0);
        }
        
        .slide-out-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            position: relative;
        }
        
        .slide-out-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .slide-out-close {
            background-color: hsl(var(--muted));
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: hsl(var(--foreground));
            transition: all 150ms ease;
        }
        
        .slide-out-close:hover {
            background-color: hsl(var(--muted) / 0.8);
        }
        
        .slide-out-form {
            display: flex;
            flex-direction: column;
        }
        
        /* Handle bar for slide-out - removed */

        /* Account Management Slide-out Styles */
        .account-management-slide-out {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 2000;
        }
        
        .account-management-slide-out.active {
            opacity: 1;
            visibility: visible;
        }
        
        .account-management-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: hsl(var(--background));
            border-radius: 20px 20px 0 0;
            padding: 20px 20px 40px;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .account-management-slide-out.active .account-management-content {
            transform: translateY(0);
        }
        
        .account-management-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            position: relative;
        }
        
        .account-management-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: hsl(var(--foreground));
        }
        
        .account-management-close {
            background-color: hsl(var(--muted));
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: hsl(var(--foreground));
            transition: all 150ms ease;
        }
        
        .account-management-close:hover {
            background-color: hsl(var(--muted) / 0.8);
        }
        
        .account-management-handle {
            display: none;
        }
        
        .account-management-list {
            margin-bottom: 20px;
        }
        
        .account-management-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            margin-bottom: 8px;
        }
        
        .account-management-name {
            font-weight: 500;
            color: hsl(var(--foreground));
        }
        
        .account-management-delete-btn {
            background-color: hsl(var(--destructive));
            color: hsl(var(--destructive-foreground));
            border: none;
            padding: 6px 12px;
            border-radius: var(--radius);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 150ms ease;
            min-height: 32px;
            min-width: 60px;
        }
        
        .account-management-delete-btn:hover {
            background-color: hsl(var(--destructive) / 0.9);
        }
        
        .account-management-add-form {
            border-top: 1px solid hsl(var(--border));
            padding-top: 20px;
        }
        
        .account-management-add-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: hsl(var(--foreground));
            margin-bottom: 15px;
        }
        
        .account-management-input-group {
            margin-bottom: 15px;
        }
        
        .account-management-input {
            width: 100%;
            min-height: 44px;
            padding: 12px 16px;
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            font-size: 1rem;
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            transition: all 0.3s ease;
            box-sizing: border-box;
        }
        
        .account-management-input:focus {
            outline: 2px solid hsl(var(--ring));
            outline-offset: 2px;
            border-color: hsl(var(--ring));
        }
        
        .account-management-add-btn {
            background-color: hsl(220, 13%, 18%);
            color: #ffffff;
            border: none;
            padding: 12px 20px;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            min-height: 44px;
        }
        
        .account-management-add-btn:hover {
            background-color: hsl(220, 13%, 28%);
        }
        
        .account-management-add-btn:active {
            transform: translateY(1px);
        }
        
        /* Mobile responsive adjustments for account management */
        @media (max-width: 480px) {
            .account-management-content {
                padding: 16px 16px 32px;
            }
            
            .account-management-title {
                font-size: 1.2rem;
            }
            
            .account-management-list-item {
                padding: 10px 12px;
            }
            
            .account-management-delete-btn {
                padding: 8px 12px;
                font-size: 0.75rem;
                min-width: 50px;
            }
            
            .account-management-input {
                padding: 10px 14px;
                font-size: 0.95rem;
            }
            
            .account-management-add-btn {
                padding: 10px 16px;
                font-size: 0.95rem;
            }
        }

        /* Custom Datepicker Styles */
        .custom-datepicker {
            position: relative;
            width: 100%;
        }

        .datepicker-trigger {
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 44px; /* iOS recommended minimum touch target */
            padding: 8px 12px;
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            background-color: hsl(var(--background));
            cursor: pointer;
            transition: all 150ms ease;
            font-size: 0.875rem;
        }

        .datepicker-trigger:hover {
            border-color: hsl(var(--ring));
        }

        .datepicker-trigger:focus {
            outline: none;
            border-color: hsl(var(--ring));
            box-shadow: 0 0 0 2px hsl(var(--ring) / 0.2);
        }
        
        .datepicker-trigger:focus-visible {
            outline: 2px solid hsl(var(--ring));
            outline-offset: 2px;
        }

        .datepicker-value {
            color: hsl(var(--foreground));
            flex: 1;
        }

        .datepicker-trigger .w-4 {
            width: 16px;
            height: 16px;
            color: hsl(var(--muted-foreground));
        }

        .datepicker-popup {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1000;
            background-color: hsl(var(--popover));
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 16px;
            margin-top: 4px;
            display: none;
            min-width: 280px;
        }

        .datepicker-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .datepicker-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: var(--radius);
            transition: all 150ms ease;
        }

        .datepicker-nav:hover {
            background-color: hsl(var(--muted));
        }

        .datepicker-nav .w-4 {
            width: 16px;
            height: 16px;
            color: hsl(var(--foreground));
        }

        .datepicker-month-year {
            font-weight: 600;
            color: hsl(var(--foreground));
            font-size: 0.875rem;
        }

        .datepicker-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-bottom: 16px;
        }

        .datepicker-day-header {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 32px;
            font-size: 0.75rem;
            font-weight: 500;
            color: hsl(var(--muted-foreground));
        }

        .datepicker-day {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 32px;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 150ms ease;
            font-size: 0.875rem;
            color: hsl(var(--foreground));
        }

        .datepicker-day:hover {
            background-color: hsl(var(--muted));
        }

        .datepicker-day.empty {
            cursor: default;
        }

        .datepicker-day.empty:hover {
            background-color: transparent;
        }

        .datepicker-day.today {
            background-color: hsl(var(--muted));
            font-weight: 500;
        }

        .datepicker-day.selected {
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
        }

        .datepicker-day.selected:hover {
            background-color: hsl(var(--primary));
        }

        .datepicker-footer {
            display: flex;
            justify-content: space-between;
            gap: 8px;
        }

        .datepicker-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 150ms ease;
            border: 1px solid transparent;
            flex: 1;
        }

        .datepicker-btn-secondary {
            background-color: hsl(var(--secondary));
            color: hsl(var(--secondary-foreground));
            border-color: hsl(var(--border));
        }

        .datepicker-btn-secondary:hover {
            background-color: hsl(var(--secondary) / 0.8);
        }

        .datepicker-btn-primary {
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
        }

        .datepicker-btn-primary:hover {
            background-color: hsl(var(--primary) / 0.9);
        }

        /* Mobile responsive adjustments */
        @media (max-width: 480px) {
            .datepicker-popup {
                min-width: calc(100vw - 40px);
                left: 50%;
                transform: translateX(-50%);
            }
        }

        /* --- Slide-out form full-width fields --- */
        .slide-out-form .form-group {
            /* width: 100%; */
            box-sizing: border-box;
        }
        .slide-out-form .input-row {
            display: flex;
            flex-direction: row;
            gap: 0.5rem;
            /* width: 100%; */
            /* max-width: 100%; */
        }
        .slide-out-form .input-row .form-group,
        .slide-out-form .input-row .select-container {
            flex: 1 1 0;
            min-width: 0;
        }
        .slide-out-form input,
        .slide-out-form select,
        .slide-out-form .select-trigger {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        .slide-out-form .select-trigger {
            display: flex;
        }
        .slide-out-form .select-content {
            min-width: 100%;
        }
        @media (max-width: 600px) {
            .slide-out-form .input-row {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
        /* --- Slide-out form: Amount and Category side by side, override global input-group rules --- */
        .slide-out-form .input-row {
            display: flex;
            flex-direction: row;
            gap: 0.5rem;
        }
        .slide-out-form .input-row .form-group {
            flex: 1 1 0;
            min-width: 0;
            margin-bottom: 0;
        }
        .slide-out-form .input-row .form-group label,
        .slide-out-form .input-row .form-group input,
        .slide-out-form .input-row .form-group select,
        .slide-out-form .input-row .select-container {
            display: initial;
            width: 100%;
            margin-bottom: 0.5rem;
        }

        /* Floating Action Button (FAB) Styles */
        .fab-container {
            position: fixed;
            bottom: 80px; /* Above bottom nav */
            right: 20px;
            z-index: 1000;
        }

        .fab-primary {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        .fab-menu {
            position: absolute;
            bottom: 70px;
            right: 0;
            display: none;
            flex-direction: column;
            gap: 12px;
            align-items: flex-end;
        }

        .fab-menu.active {
            display: flex;
        }

        .fab-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            border-radius: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .fab-option:hover {
            background: hsl(var(--accent));
            transform: translateX(-4px);
        }

        .fab-option-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quick-action-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2em;
            height: 2em;
            background: #ffffff48;
            border-radius: 50%;
            color: hsl(var(--primary));
            font-size: 1.1em;
        }
        .quick-action-title {
            font-size: 1.08rem;
            font-weight: 500;
            margin: 0;
            padding: 0;
            color: #fff;
        }

        /* Hide old action buttons - now using Quick Action Cards */
        .action-buttons {
            display: none !important;
        }

        /* Hide FAB - now using Quick Action Cards */
        .fab-container {
            display: none !important;
        }

        /* Better spacing between card sections */
        .card {
            margin-bottom: 20px;
        }
        
        .expense-input {
            margin-bottom: 32px;
        }
        
        /* Quick actions spacing */
        .quick-actions {
            margin-bottom: 32px;
        }
        
        /* Savings section spacing */
        .savings-accounts-section {
            margin-top: 8px;
        }

        .quick-action-card {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 0.7em 1.6em;
            background: hsl(220, 13%, 18%);
            color: #ffffff;
            border: none;
            border-radius: 12px;
            font-size: 1.08rem;
            font-weight: 500;
            cursor: pointer;
            transition: 
                box-shadow 0.16s,
                background 0.16s,
                transform 0.12s;
            box-shadow: 0 2px 6px 0 rgba(0,0,0,0.2);
            margin: 0;
            min-height: 44px;
            outline: none;
        }
        .quick-action-card:hover,
        .quick-action-card:focus {
            background: hsl(220, 13%, 28%);
            box-shadow: 0 4px 12px 0 rgba(0,0,0,0.25);
        }
        .quick-action-card:active {
            background: hsl(220, 13%, 15%);
            transform: scale(0.98);
            color: #ffffff;
        }
        .quick-action-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 1.7em;
            height: 1.7em;
            background: none;
            border-radius: 50%;
            color: #ffffff;
            font-size: 1.1em;
            margin: 0;
        }
        .quick-action-title {
            font-size: 1.08rem;
            font-weight: 500;
            margin: 0;
            padding: 0;
            color: #ffffff;
            letter-spacing: 0.01em;
        }

        .fab-option:active {
            transform: translateY(2px);
        }

        .chart-overlay.visible .chart-tooltip {
            opacity: 1;
            transform: translateY(0);
        }
        
        .chart-overlay.visible .chart-crosshair {
            opacity: 1;
        }

        .fab-option:active {
            transform: translateY(2px);
        }

        /* Make form containers use grid for full-width buttons */
        .slide-out-form,
        .form-group:has(.add-btn),
        .form-group:has(.balance-add-btn),
        .form-group:has(.account-management-add-btn) {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }
        
        /* Ensure the button container takes full width */
        .slide-out-form > .add-btn,
        .slide-out-form > .balance-add-btn,
        .account-management-add-form > .account-management-add-btn {
            grid-column: 1 / -1;
            width: 100%;
            max-width: none;
        }
        
        /* Make main expense form use grid for full-width button */
        .expense-input {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }
        
        .expense-input > .add-btn {
            grid-column: 1 / -1;
            width: 100%;
            max-width: none;
        }

        .expense-amount.positive {
          color: hsl(var(--foreground));
        }

        .header-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: hsl(var(--foreground));
            flex: 1;
            text-align: center;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 18px;
        }

        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
        }

        /* Settings Screen Styles */
        .form-group {
            margin-bottom: 0.75rem; /* consistent spacing */
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: hsl(var(--foreground));
            margin-bottom: 0.5rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            font-size: 0.875rem;
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            transition: border-color 0.2s ease;
            min-height: 44px;
        }

        .form-input:focus {
            outline: none;
            border-color: hsl(var(--ring));
            box-shadow: 0 0 0 2px hsl(var(--ring) / 0.2);
        }

        .form-help {
            font-size: 0.75rem;
            color: hsl(var(--muted-foreground));
            margin-top: 0.25rem;
        }

        .budget-summary {
            display: grid;
            gap: 0.75rem; /* consistent spacing */
        }

        .budget-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background-color: hsl(var(--muted));
            border-radius: var(--radius);
        }

        .budget-label {
            font-size: 0.875rem;
            color: hsl(var(--muted-foreground));
        }

        .budget-value {
            font-size: 1rem;
            font-weight: 600;
            color: hsl(var(--foreground));
        }

        .budget-value.positive {
            color: hsl(var(--success));
        }

        .budget-value.negative {
            color: hsl(var(--destructive));
        }

        .budget-value.warning {
            color: hsl(var(--warning));
        }

        /* Tax Calculator Styles */
        .tax-calculator-section {
            margin-bottom: 1rem;
        }

        .tax-calculator-header {
            margin-bottom: 0.75rem;
        }

        .tax-calculator-inputs {
            display: grid;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .tax-calculator-inputs .form-group {
            margin-bottom: 0;
        }

        .calculate-btn {
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 150ms ease;
            width: 100%;
        }

        .calculate-btn:hover {
            background-color: hsl(var(--primary) / 0.9);
        }

        .tax-results {
            background-color: hsl(var(--muted));
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .tax-summary {
            display: grid;
            gap: 0.75rem;
        }

        .tax-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid hsl(var(--border));
        }

        .tax-item:last-child {
            border-bottom: none;
        }

        .tax-item.total {
            border-top: 2px solid hsl(var(--border));
            border-bottom: none;
            padding-top: 0.75rem;
            margin-top: 0.5rem;
            font-weight: 600;
        }

        .tax-label {
            font-size: 0.875rem;
            color: hsl(var(--muted-foreground));
        }

        .tax-value {
            font-size: 0.875rem;
            font-weight: 500;
            color: hsl(var(--foreground));
        }

        .tax-item.total .tax-label,
        .tax-item.total .tax-value {
            font-weight: 600;
            color: hsl(var(--foreground));
        }

        .form-divider {
            height: 1px;
            background-color: hsl(var(--border));
            margin: 1rem 0;
        }

        .manual-override-section {
            margin-top: 1rem;
        }

        /* Accordion Styles */
        .accordion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: hsl(var(--muted));
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 150ms ease;
            user-select: none;
        }

        .accordion-header:hover {
            background-color: hsl(var(--muted) / 0.8);
        }

        .accordion-header h4 {
            margin: 0;
        }

        .accordion-icon {
            width: 1.25rem;
            height: 1.25rem;
            transition: transform 150ms ease;
            color: hsl(var(--muted-foreground));
        }

        .accordion-header.expanded .accordion-icon {
            transform: rotate(180deg);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 150ms ease;
        }

        .accordion-content.expanded {
            max-height: 1000px;
            padding-top: 1rem;
        }

        /* Settings Slide-out Panel */
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .settings-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .settings-panel {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            height: 100%;
            background-color: hsl(var(--background));
            z-index: 1001;
            overflow-y: auto;
            transition: right 0.3s ease, transform 0.3s ease;
            box-sizing: border-box;
        }

        .settings-panel.active {
            right: 0;
        }

        /* Budget panel transition */
        .budget-panel {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            height: 100%;
            background-color: hsl(var(--background));
            z-index: 1002;
            overflow-y: auto;
            transition: right 0.3s ease;
            box-sizing: border-box;
        }

        .budget-panel.active {
            right: 0;
        }

        /* Settings panel slide transition when budget is open */
        .settings-panel.budget-open {
            transform: translateX(-10px);
        }

        /* Main content slide transition */
        .app-container {
            transition: transform 0.3s ease;
        }

        .app-container.settings-open {
            transform: translateX(-10px);
        }

        .settings-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid hsl(var(--border));
            background-color: hsl(var(--background));
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .settings-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: hsl(var(--foreground));
            flex: 1;
            text-align: center;
        }

        .settings-back {
            background: none;
            border: none;
            color: hsl(var(--muted-foreground));
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-back:hover {
            background-color: hsl(var(--muted));
        }

        .settings-content {
            padding: 1rem;
        }

        @media (min-width: 768px) {
            .settings-panel {
                width: 400px;
            }
            .budget-panel {
                width: 400px;
            }
        }

        .card-content > *:not(:last-child) {
            margin-bottom: 0.75rem; /* consistent spacing between groups in a card */
        }

        .card {
            margin-bottom: 1.25rem; /* consistent spacing between cards */
        }

        .settings-menu-list {
  list-style: none;
  padding: 0;
  margin: 0;
}
.settings-menu-item {
  display: flex;
  align-items: center;
  padding: 2rem 0.5rem;
  border-bottom: 1px solid #eee;
  cursor: pointer;
  color: #111;
  font-size: 1.08rem;
  font-weight: 500;
  background: none;
}
.settings-menu-item:last-child {
  border-bottom: none;
}
.settings-menu-icon {
  margin-right: 1rem;
  display: flex;
  align-items: center;
  color: #111;
}
.settings-menu-arrow {
  margin-left: auto;
  color: #111;
  display: flex;
  align-items: center;
}
.settings-menu-btn-item {
  padding: 1rem 0.5rem 0rem 0.5rem;
  border-bottom: none;
}
.settings-menu-btn {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: flex-start;
  gap: 1rem;
  font-size: 1.08rem;
  font-weight: 500;
  background: hsl(var(--primary));
  color: hsl(var(--primary-foreground));
  border: none;
  border-radius: var(--radius);
  padding: 0.75rem 1.5rem;
  cursor: pointer;
  margin: 0;
}
.settings-menu-btn .settings-menu-icon {
  color: #fff;
}

.account-accordion {
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  margin-bottom: 1.2rem;
  background: #fff;
  box-shadow: 0 1px 2px rgba(0,0,0,0.02);
}
.account-accordion-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1rem 1.5rem;
  cursor: pointer;
  font-weight: bold;
  background: #fff;
  border-bottom: 1px solid #f3f4f6;
  border-radius: 12px 12px 0 0;
}
.account-accordion-title {
  font-size: 1.1rem;
  font-weight: 600;
}
.account-accordion-value {
  font-size: 1.1rem;
  font-weight: 700;
  color: hsl(var(--success));
  margin-left: auto;
}
.account-accordion-chevron {
  font-size: 1.2rem;
  margin-left: 0.5rem;
  color: #888;
}
.account-accordion-body {
  padding: 0.5rem 1.5rem 1rem 1.5rem;
  background: #fafbfc;
  border-radius: 0 0 12px 12px;
}
.account-accordion-updates {
  margin: 0;
  padding: 0;
}
.account-update-row {
  display: flex;
  align-items: flex-end;
  justify-content: space-between;
  padding: 0.5rem 0;
  border-bottom: 1px solid #eee;
  font-size: 1rem;
}
.account-update-row:last-child {
  border-bottom: none;
}
.account-update-date {
  font-size: 1rem;
  color: #333;
  font-weight: 500;
}
.account-update-diff {
  font-size: 1.1rem;
  font-weight: 600;
  margin-left: 1rem;
}
.account-update-percent {
  font-size: 0.95rem;
  margin-left: 1rem;
  margin-top: 0.1rem;
  color: #888;
}
.account-update-percent.positive {
  color: #27ae60;
}
.account-update-percent.negative {
  color: #e74c3c;
}
.account-update-percent.neutral {
  color: #888;
}

/* Modern Wealthsimple-style Account Accordion Styles */
.modern-account-accordion {
    border: none;
    border-radius: 18px;
    background: #fff;
    box-shadow: none;
    transition: none;
    margin-bottom: 0.8rem;
}
.modern-account-accordion-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1rem 0;
  cursor: pointer;
  border-radius: 18px 18px 0 0;
  background: #fff;
  transition: none;
  box-shadow: none;
}

.modern-account-header-left {
  flex: 1 1 auto;
  display: flex;
  flex-direction: column;
  justify-content: center;
}
.modern-account-title {
 font-size: 0.9rem;
text-transform: uppercase;
font-weight: 800;
color: #787878;
letter-spacing: 0.04em;
}
.modern-account-header-right {
  display: flex;
margin-right: 0.5rem;   
  flex-direction: column;
  align-items: flex-end;
  margin-left: 1.2rem;
  font-size: 0.98rem;
  transition: opacity 0.2s;
}
.modern-account-accordion-header.expanded .modern-account-header-right {
  display: none;
}
.modern-account-balance {
  font-size: 1.2rem;
  font-weight: 800;
  color: #222;
  line-height: 1.1;
}
.modern-account-percent {
  font-size: 1.02rem;
  font-weight: 600;
  margin-top: 0.18rem;
  color: #27ae60;
}
.modern-account-percent.negative {
  color: #e74c3c;
}
.account-chevron {
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 20px;
    width: 30px;
    height: 30px;
    box-shadow: none;
    background-color: rgb(187 187 187 / 20%);
}
.modern-account-chevron {
    font-size: 1.45rem;
    display: flex;
    color: #bbb;
    align-self: center;
    align-items: center;
    justify-content: center;
    transition: transform 0.3s cubic-bezier(0.4,0,0.2,1);
    background: none !important;
    border-radius: 0 !important;
    width: 18px;
    box-shadow: none;
}
.modern-account-accordion-header.expanded .modern-account-chevron {
  transform: rotate(180deg);
  background: none;
}
.modern-account-accordion-body {
  padding: 0;
  background: none;
  border-radius: 0 0 18px 18px;
  box-shadow: none;
  max-height: 0;
  overflow: hidden;
  opacity: 0;
  transition: max-height 0.35s cubic-bezier(0.4,0,0.2,1), opacity 0.25s cubic-bezier(0.4,0,0.2,1);
}
.modern-account-accordion-body.expanded {
  max-height: 1000px;
  opacity: 1;
  transition: max-height 0.45s cubic-bezier(0.4,0,0.2,1), opacity 0.25s cubic-bezier(0.4,0,0.2,1);
}
.modern-account-updates {
  margin: 0;
  padding: 0;
}
.modern-account-update-row {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  padding: 1rem;
  margin-bottom: 0.2rem;
  background: #fff;
  border-radius: 0;
  box-shadow: none;
  font-size: 1.08rem;
  width: 100%;
}
.modern-account-update-row:last-child {
  margin-bottom: 0;
}
.modern-update-date {
  font-size: 1.01rem;
  color: #444;
  font-weight: 600;
  flex: 1 1 40%;
  align-self: center;
}
.modern-update-amount-stack {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  flex: 1 1 60%;
  min-width: 0;
}
.modern-update-diff {
  font-size: 1.08rem;
  font-weight: 700;
  color: #222;
  margin-left: 0;
  margin-bottom: 0.15rem;
}
.modern-update-percent {
  font-size: 1.01rem;
  color: #27ae60;
  font-weight: 600;
  margin-left: 0;
}
.modern-update-percent.negative {
  color: #e74c3c;
}
.modern-update-percent.neutral {
  color: #888;
}

        

    
        /* Modern Balance Card Styling */
        .modern-balance-card {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            /* align-items: center; */
            padding: 20px;
            /* background-color: white; */
            border-radius: 16px;
            /* box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); */
            margin-bottom: 20px;
        }
        
        .balance-date-modern {
            font-size: 1rem;
            font-weight: 500;
            color: hsl(var(--muted-foreground));
        }
        
        .balance-right-stack {
            display: flex;
            flex-direction: column;
        }
        
        .current-balance-modern {
            font-size: 1.8rem;
            font-weight: 700;
            color: hsl(var(--foreground));
            margin-bottom: 4px;
        }
        
        .balance-change-modern {
            font-size: 0.9rem;
            font-weight: 500;
            color: hsl(var(--muted-foreground));
        }
        
        .balance-change-modern.positive {
            color: #27ae60;
        }
        
        .balance-change-modern.negative {
            color: #e74c3c;
        }
        
        /* Mobile responsiveness for modern balance card */
        @media (max-width: 480px) {
            .modern-balance-card {
                padding: 15px;
            }
            
            .current-balance-modern {
                font-size: 1.5rem;
            }
            
            .balance-date-modern {
                font-size: 0.9rem;
            }
        }

        /* Swipe to delete functionality */
        .swipe-container {
            position: relative;
            overflow: hidden;
            width: 100%;
            border-radius: 8px;
            margin-bottom: 8px;
            touch-action: pan-y; /* Change to pan-y to enable horizontal swiping */
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        .swipe-content {
            position: relative;
            z-index: 1;
            background: white;
            transition: transform 0.2s ease;
            width: 100%;
            will-change: transform;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

       

        .swipe-container.swiped .swipe-content {
            transform: translateX(-80px);
        }

        .swipe-container.deleting {
            animation: slide-out 0.3s ease-out forwards;
            height: 0;
            margin: 0;
            padding: 0;
            opacity: 0;
            pointer-events: none;
            overflow: hidden;
            transition: all 0.3s ease-out;
        }
        .swipe-container.deleting .swipe-content {
            transform: translateX(-100%);
            transition: transform 0.3s ease-out;
            opacity: 0;
        }

        @keyframes slide-out {
            0% {
                transform: translateX(0);
                opacity: 1;
                max-height: 100px;
                margin-bottom: 8px;
            }
            75% {
                transform: translateX(-100%);
                opacity: 0;
                max-height: 100px;
            }
            100% {
                transform: translateX(-100%);
                opacity: 0;
                max-height: 0px;
                margin: 0;
                padding: 0;
            }
        }
        
        /* Make sure balance items have the same swipe styling as expense items */
        .swipe-container .balance-item,
        .swipe-container .modern-balance-history-item {
            border: none;
            box-shadow: none;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
        }

        .modern-balance-history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .balance-history-date {
            font-weight: 600;
            color: hsl(var(--foreground));
        }

        .balance-history-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .balance-history-amount {
            font-size: 1.1rem;
            font-weight: 700;
            color: hsl(var(--foreground));
        }

        .balance-history-percent {
            font-size: 0.8rem;
            display: flex;
            align-items: center;
        }

        .balance-history-percent.positive {
            color: #27ae60;
        }

        .balance-history-percent.negative {
            color: #e74c3c;
        }

        .balance-history-percent.neutral {
            color: #888;
        }

        .balance-arrow {
            margin-right: 4px;
        }

    
    </style>
</head>
<body>
    <div id="app" class="app-container">
       

        <!-- Add this just above the screens wrapper -->
        <div class="app-header">
            <div id="user-avatar"></div>
            <div class="header-title" id="headerTitle">Spend</div>
            <div class="header-actions">
                <button class="icon-btn" id="settingsButton" onclick="openSettings()" aria-label="Settings">
                    <i data-lucide="settings" class="w-6 h-6"></i>
                </button>
            </div>
        </div>
        
        <div class="content-container">
            <div class="screens-wrapper" id="screensWrapper">
                <!-- Screen 1: Tracking -->
                <div class="screen">
                    <!-- Daily Budget Display -->
                    <div class="card" id="budgetDisplay">
                        <div class="card-header" style="text-align:center;">
                            <div id="budgetTitleContainer" style="text-align:left;"></div>
                            <!-- Icon-only Today/Month Toggle - Only this is included -->
                            <div class="period-icon-toggle">
                                <button onclick="setPeriodMode('today')" class="period-icon-btn active" id="todayBtnIcon" title="Today View">
                                    <i data-lucide="sun" class="w-4 h-4"></i>
                                </button>
                                <button onclick="setPeriodMode('month')" class="period-icon-btn" id="monthBtnIcon" title="Month View">
                                    <i data-lucide="calendar" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="flex items-center justify-between p-4 rounded-lg mb-2 stat-card">
                                <div>
                                    <div class="text-sm text-muted-foreground">Discretionary Budget</div>
                                    <div class="text-2xl font-semibold" id="budgetAmount">$41.30</div>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between p-4 rounded-lg remaining-budget-section" style="background-color: hsl(var(--muted)); position: relative;">
                                <div>
                                    <div class="text-sm text-muted-foreground" id="remainingLabel">Remaining Today</div>
                                    <div class="text-2xl font-semibold" id="remainingBudget">$41.30</div>
                                </div>
                                <div class="status-label" id="budgetStatusText" style="position: absolute; bottom: 8px; right: 8px; padding: 4px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: 500; color: white; background-color: hsl(156.06deg 40% 40%);">On Track</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Floating Action Button (FAB) -->
                    <div class="fab-container">
                        <button class="fab-primary" onclick="toggleFabMenu()" id="fabMain">
                            <i data-lucide="plus" class="w-6 h-6"></i>
                        </button>
                        
                        <div class="fab-menu" id="fabMenu">
                            <div class="fab-option" onclick="showExpenseSlideOut(); hideFabMenu();">
                                <div class="fab-option-icon">
                                    <i data-lucide="minus" class="w-4 h-4"></i>
                                </div>
                                <span>Add Expense</span>
                            </div>
                            
                            <div class="fab-option" onclick="showBalanceSlideOut(); hideFabMenu();" id="fabBalanceOption" style="display: none;">
                                <div class="fab-option-icon">
                                    <i data-lucide="hand-coins" class="w-6 h-6"></i>
                                </div>
                                <span>Add Balance</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Action Cards -->
                    <div class="quick-actions">
                        <div class="quick-action-card" onclick="showExpenseSlideOut()">
                            <div class="quick-action-icon">
                                <i data-lucide="dollar-sign" class="w-6 h-6"></i>
                            </div>
                            <div class="quick-action-title">Add Expense</div>
                        </div>
                    </div>
                    
                    <!-- Add Expense -->
                    <div class="card expense-input" id="expenseInput" style="display: none;">
                        <h3 class="card-title mb-4" id="expenseInputTitle">Add Expense</h3>
                        
                        <!-- Date picker for month mode -->
                        <div class="form-group" id="datePickerGroup" style="display: none;">
                            <label class="form-label" for="expenseDate">Date</label>
                            <input type="date" id="expenseDate" class="form-input">
                        </div>
                        <div class="input-row">
                            <div class="form-group">
                                <label class="form-label" for="expenseAmount">Amount ($)</label>
                                <input type="number" id="expenseAmount" class="form-input" placeholder="0.00" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="expenseCategory">Category</label>
                                <select id="expenseCategory" class="form-input">
                                    <option value="groceries">Groceries</option>
                                    <option value="transportation">Transportation</option>
                                    <option value="dining">Dining Out</option>
                                    <option value="entertainment">Entertainment</option>
                                    <option value="personal">Personal Care</option>
                                    <option value="clothing">Clothing</option>
                                    <option value="health">Health/Fitness</option>
                                    <option value="subscriptions">Subscriptions</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="expenseDescription">Description (optional)</label>
                            <input type="text" id="expenseDescription" class="form-input" placeholder="What did you buy?">
                        </div>
                        
                        <button class="add-btn" onclick="addExpense()">Add Expense</button>
                    </div>
                    
                    <!-- Period Expenses -->
                    <div class="card">
                        <h3 class="card-title mb-4" id="expensesListTitle">Today's Expenses</h3>
                        <div class="expenses-list" id="expensesList">
                            <div style="text-align: center; color: #7f8c8d; padding: 20px;">
                                No expenses recorded today
                            </div>
                        </div>
                    </div>
                    
                    <!-- Savings Accounts Section - Moved to Save Screen -->
                    <!-- <div class="card savings-accounts-section" id="savingsSection" style="display: none;">
                        <div class="section-header">
                            <h3 class="text-lg font-semibold">Account Balances</h3>
                            <button class="btn btn-outline btn-sm" onclick="showAccountManagementModal()">
                                <i data-lucide="settings" class="w-4 h-4 mr-2"></i>
                                Accounts
                            </button>
                        </div>
                        
                        <div class="account-balance-display stat-card">
                            <div class="current-balance" id="totalAccountBalance">$0.00</div>
                            <div class="balance-change" id="totalBalanceChange">Total across all accounts this month</div>
                        </div>
                        
                        <div class="balance-history" id="balanceHistory">
                            <div style="text-align: center; color: #7f8c8d; padding: 20px;">
                                No balance records this month
                            </div>
                        </div>
                    </div> -->
                </div>
                
                <!-- Screen 2: Save -->
                <div class="screen">
                    <!-- Sticky Period Selector for Save Screen -->
                    <div class="period-selector-sticky" id="savePeriodSelectorSticky" style="display: none;">
                        <!-- Period Selector Header with Toggle on Left, Dropdowns on Right -->
                        <div class="period-selector-header">
                            <div class="card-header" style="flex-direction: row; align-items: center; justify-content: space-between; padding-bottom: 0;">
                                <div class="period-title">July 2025</div>
                                
                                <!-- Icon-only Today/Month Toggle - Only this is included -->
                                <div class="period-icon-toggle">
                                    <button onclick="setSavePeriodMode('today')" class="period-icon-btn active" id="saveTodayBtnIcon" title="Today View">
                                        <i data-lucide="sun" class="w-4 h-4"></i>
                                    </button>
                                    <button onclick="setSavePeriodMode('month')" class="period-icon-btn" id="saveMonthBtnIcon" title="Month View">
                                        <i data-lucide="calendar" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Original Toggle (Hidden) -->
                            <div class="period-mode-toggle-compact" style="display: none;">
                                <button onclick="setSavePeriodMode('today')" class="btn btn-ghost btn-sm period-mode-btn-compact active" id="saveTodayBtnCompact" title="Today View">
                                    <i data-lucide="sun" class="w-4 h-4 mr-2"></i>
                                    <span>Today</span>
                                </button>
                                <button onclick="setSavePeriodMode('month')" class="btn btn-ghost btn-sm period-mode-btn-compact" id="saveMonthBtnCompact" title="Month View">
                                    <i data-lucide="calendar" class="w-4 h-4 mr-2"></i>
                                    <span>Month</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Daily/Monthly Saving Target Display -->
                    <div class="card" id="saveTargetDisplay">
                        <div class="card-header" style="text-align:center;">
                            <div id="saveTargetTitleContainer" style="text-align:left;"></div>
                        </div>
                        <div class="card-content">
                            <div class="flex items-center justify-between p-4 rounded-lg mb-2 stat-card">
                                <div>
                                    <div class="text-sm text-muted-foreground">Saving Target</div>
                                    <div class="text-2xl font-semibold" id="saveTargetAmount">$144.43</div>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between p-4 rounded-lg remaining-budget-section" style="background-color: hsl(var(--muted)); position: relative;">
                                <div>
                                    <div class="text-sm text-muted-foreground" id="saveProgressLabel">Progress This Month</div>
                                    <div class="text-2xl font-semibold" id="saveProgressAmount">$0.00</div>
                                </div>
                                <div class="status-label" id="saveStatusText" style="position: absolute; bottom: 8px; right: 8px; padding: 4px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: 500; color: white; background-color: hsl(156.06deg 40% 40%);">On Track</div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Action Cards for Save Screen -->
                    <div class="quick-actions">
                        <div class="quick-action-card" onclick="showBalanceSlideOut()" id="saveBalanceActionCard">
                            <div class="quick-action-icon">
                                <i data-lucide="hand-coins" class="w-6 h-6"></i>
                            </div>
                            <div class="quick-action-title">Add Balance</div>
                        </div>
                    </div>
                    
                    <!-- Savings Accounts Section -->
                    <div class="card savings-accounts-section" id="saveSavingsSection">
                        <div class="section-header">
                            <h3 class="text-lg font-semibold">Account Balances</h3>
                            <button class="btn btn-outline btn-sm" onclick="showAccountManagementModal()">
                                <i data-lucide="settings" class="w-4 h-4 mr-2"></i>
                                Accounts
                            </button>
                        </div>
                        
                        <!-- Total Balance Display -->
                        <div class="account-balance-display stat-card modern-balance-card">
                            <div class="balance-right-stack">
                                <div class="current-balance-modern" id="saveTotalAccountBalance">$0.00</div>
                                <div class="balance-change-modern" id="saveTotalBalanceChange">Total Balance</div>
                            </div>
                        </div>
                        
                        <!-- Balance History -->
                        <div class="balance-history" id="saveBalanceHistory">
                            <div style="text-align: center; color: #7f8c8d; padding: 20px;">
                                No balance records this month
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Screen 3: Reports -->
                <div class="screen">
                    <!-- Weekly Summary -->
                    <div class="card weekly-summary">
                        <h3>This Week's Financial Health</h3>
                        <div class="weekly-stats">
                            <div class="weekly-stat">
                                <div class="weekly-stat-value" id="weeklySpent">$0</div>
                                <div class="weekly-stat-label">Spent</div>
                            </div>
                            <div class="weekly-stat">
                                <div class="weekly-stat-value" id="weeklyRemaining">$286</div>
                                <div class="weekly-stat-label">Remaining</div>
                            </div>
                            <div class="weekly-stat">
                                <div class="weekly-stat-value" id="projectedMonthlySavings">$0</div>
                                <div class="weekly-stat-label">Projected Savings</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Monthly Stats -->
                    <div class="stats-grid">
                        <div class="card stat-card">
                            <div class="stat-label" id="monthSpentLabel">July Spent</div>
                            <div class="stat-value" id="monthlySpent">$0</div>
                            <div class="stat-subtitle" id="monthSpentSubtitle">of $1,239 budget</div>
                        </div>
                        <div class="card stat-card">
                            <div class="stat-label">Daily Burn Rate</div>
                            <div class="stat-value" id="dailyBurnRate">$0</div>
                            <div class="stat-subtitle" id="burnRateStatus">vs $41.30 target</div>
                        </div>
                        <div class="card stat-card">
                            <div class="stat-label">Days Left in Budget</div>
                            <div class="stat-value" id="daysRemaining">--</div>
                            <div class="stat-subtitle" id="daysRemainingSubtitle">at current pace</div>
                        </div>
                        <div class="card stat-card">
                            <div class="stat-label">Savings Rate</div>
                            <div class="stat-value positive" id="savingsRate">--%</div>
                            <div class="stat-subtitle" id="savingsRateSubtitle">of income saved</div>
                        </div>
                    </div>
                    
                    <!-- Wealthsimple-Style Chart -->
                    <div class="chart-container-wrapper">
                        <!-- Chart Header with Two Rows: Savings and Spending -->
                        <div class="chart-header">
                            <!-- Savings Row (Black) -->
                            <div class="chart-row savings-row">
                                <div class="chart-subtitle" id="chartSubtitle">Total Savings</div>
                                <div class="chart-main-value" id="chartMainValue">$0.00</div>
                                <div class="chart-growth" id="chartGrowth">+$0.00 (+0%)</div>
                            </div>
                            
                            <!-- Spending Row (Gray) -->
                            <div class="chart-row spending-row">
                                <div class="chart-subtitle spending" id="chartSpendingSubtitle">Total Spending</div>
                                <div class="chart-main-value spending" id="chartSpendingValue">$0.00</div>
                                <div class="chart-growth spending" id="chartSpendingGrowth">+$0.00 (+0%)</div>
                            </div>
                        </div>
                        
                        <!-- Chart with Overlay -->
                        <div class="card chart-container">
                            <canvas id="spendingChart"></canvas>
                            <div class="chart-overlay" id="chartOverlay">
                                <div class="chart-crosshair" id="chartCrosshair"></div>
                            </div>
                        </div>
                        
                        <!-- Chart Period Selector at Bottom -->
                        <div class="chart-period-selector-bottom">
                            <button class="chart-period-btn-wealthsimple" onclick="setChartPeriod('1M')" id="period1M">1M</button>
                            <button class="chart-period-btn-wealthsimple" onclick="setChartPeriod('3M')" id="period3M">3M</button>
                            <button class="chart-period-btn-wealthsimple" onclick="setChartPeriod('6M')" id="period6M">6M</button>
                            <button class="chart-period-btn-wealthsimple active" onclick="setChartPeriod('YTD')" id="periodYTD">YTD</button>
                            <button class="chart-period-btn-wealthsimple" onclick="setChartPeriod('1Y')" id="period1Y">1Y</button>
                            <button class="chart-period-btn-wealthsimple" onclick="setChartPeriod('ALL')" id="periodALL">ALL</button>
                        </div>
                    </div>
                </div>
                

            </div>
        </div>
        
        <div class="bottom-nav">
            <div class="nav-item active" onclick="goToScreen(0)">
                <div class="icon">
                    <i data-lucide="wallet" class="w-6 h-6"></i>
                </div>
                <div class="label">Spend</div>
            </div>
            <div class="nav-item" onclick="goToScreen(1)">
                <div class="icon">
                    <i data-lucide="hand-coins" class="w-6 h-6"></i>
                </div>
                <div class="label">Save</div>
            </div>
            <div class="nav-item" onclick="goToScreen(2)">
                <div class="icon">
                    <i data-lucide="bar-chart-3" class="w-6 h-6"></i>
                </div>
                <div class="label">Reports</div>
            </div>
        </div>
    </div>

     <!-- Settings Slide-out Panel -->
     <div class="settings-overlay" id="settingsOverlay">
        <div class="settings-panel" id="settingsPanel">
            <div class="settings-header">
                <button class="settings-back" onclick="closeSettings()" aria-label="Back">
                    <i data-lucide="arrow-left" class="w-6 h-6"></i>
                </button>
                <h2 class="settings-title">Settings</h2>
                <div style="width: 40px;"></div> <!-- Spacer for centering -->
            </div>

            <div class="settings-content" id="settingsMenu">
                <ul class="settings-menu-list">
                    <li class="settings-menu-item" onclick="openBudgetSetup()">
                      <span class="settings-menu-icon"><i data-lucide="wallet" class="w-5 h-5"></i></span>
                      <span class="settings-menu-label">Setup Budget</span>
                      <span class="settings-menu-arrow"><i data-lucide="chevron-right" class="w-5 h-5"></i></span>
                    </li>
                    <li class="settings-menu-item" onclick="openSupport()">
                        <span class="settings-menu-icon"><i data-lucide="headphones" class="w-5 h-5"></i></span>
                        <span class="settings-menu-label">Support</span>
                        <span class="settings-menu-arrow"><i data-lucide="chevron-right" class="w-5 h-5"></i></span>
                    </li>
                    <li class="settings-menu-item settings-menu-btn-item">
                      <div class="quick-action-card" style="width:100%;box-sizing:border-box;" onclick="loadSampleBudget()">
                        <span class="quick-action-icon"><i data-lucide="database" class="w-5 h-5"></i></span>
                        <span class="quick-action-title">Load Sample Budget</span>
                      </div>
                    </li>
                    <li class="settings-menu-item settings-menu-btn-item">
                      <div class="quick-action-card" style="width:100%;box-sizing:border-box;" onclick="clearAllData()">
                        <span class="quick-action-icon"><i data-lucide="trash-2" class="w-5 h-5"></i></span>
                        <span class="quick-action-title">Clear All Data</span>
                      </div>
                    </li>
                  </ul>
            </div>
            <div class="settings-content" id="settingsForm" style="display:none;">
                <p class="text-center text-muted-foreground">Budget setup has been moved to its own page. Click "Setup Budget" to access it.</p>
            </div>

        </div>
    </div>
    
    <!-- Budget Setup Slide-out -->
    <div class="settings-overlay" id="budgetOverlay">
        <div class="budget-panel" id="budgetPanel">
            <div class="settings-header">
                <button class="settings-back" onclick="closeBudgetSetup()" aria-label="Back">
                    <i data-lucide="arrow-left" class="w-6 h-6"></i>
                </button>
                <h2 class="settings-title">Budget Setup</h2>
                <div style="width: 40px;"></div> <!-- Spacer for centering -->
            </div>

            <div class="settings-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="text-lg font-semibold">Income & Taxes</h3>
                    </div>
                    <div class="card-content">
                        <!-- Tax Calculator Section -->
                        <div class="tax-calculator-section">
                            <div class="tax-calculator-header">
                                <h4 class="text-md font-semibold mb-3">Tax Calculator</h4>
                                <p class="text-sm text-muted-foreground mb-4">Enter your gross yearly income and province to auto-calculate taxes (2024 rates)</p>
                            </div>
                            
                            <div class="tax-calculator-inputs">
                                <div class="form-group">
                                    <label class="form-label" for="budgetGrossYearlyIncome">Gross Yearly Income</label>
                                    <input type="number" class="form-input" id="budgetGrossYearlyIncome" placeholder="140000" min="0" step="1000">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label" for="budgetProvinceSelect">Province/Territory</label>
                                    <div class="select-container">
                                        <div class="select-trigger" onclick="toggleSlideOutSelect('budgetProvince')" id="budgetProvinceTrigger">
                                            <span id="budgetProvinceValue">Ontario</span>
                                            <i data-lucide="chevron-down" class="w-4 h-4"></i>
                                        </div>
                                        <div class="select-content" id="budgetProvinceContent">
                                            <div class="select-item selected" data-value="ON">Ontario</div>
                                            <div class="select-item" data-value="BC">British Columbia</div>
                                            <div class="select-item" data-value="AB">Alberta</div>
                                            <div class="select-item" data-value="SK">Saskatchewan</div>
                                            <div class="select-item" data-value="MB">Manitoba</div>
                                            <div class="select-item" data-value="QC">Quebec</div>
                                            <div class="select-item" data-value="NB">New Brunswick</div>
                                            <div class="select-item" data-value="NS">Nova Scotia</div>
                                            <div class="select-item" data-value="PE">Prince Edward Island</div>
                                            <div class="select-item" data-value="NL">Newfoundland and Labrador</div>
                                            <div class="select-item" data-value="NT">Northwest Territories</div>
                                            <div class="select-item" data-value="NU">Nunavut</div>
                                            <div class="select-item" data-value="YT">Yukon</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <button type="button" class="calculate-btn" onclick="calculateBudgetTaxes()">Calculate Taxes</button>
                            </div>
                            
                            <!-- Manual Override Section -->
                            <div class="manual-override-section">
                                <div class="accordion-header" onclick="toggleAccordion('budgetManualOverride')">
                                    <h4 class="text-md font-semibold">Manual Override (Optional)</h4>
                                    <i data-lucide="chevron-down" class="accordion-icon" id="budgetManualOverrideIcon"></i>
                                </div>
                                <div class="accordion-content" id="budgetManualOverrideContent">
                                    <p class="text-sm text-muted-foreground mb-4">You can manually adjust the calculated values below if needed</p>
                                    
                                    <div class="form-group">
                                        <label class="form-label" for="budgetGrossIncome">Gross Monthly Income</label>
                                        <input type="number" class="form-input" id="budgetGrossIncome" placeholder="11667" min="0" step="0.01">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="budgetFederalTax">Federal Tax</label>
                                        <input type="number" class="form-input" id="budgetFederalTax" placeholder="2500" min="0" step="0.01">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="budgetProvincialTax">Provincial Tax</label>
                                        <input type="number" class="form-input" id="budgetProvincialTax" placeholder="750" min="0" step="0.01">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="budgetCppEi">CPP/EI</label>
                                        <input type="number" class="form-input" id="budgetCppEi" placeholder="333" min="0" step="0.01">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="budgetNetIncome">Net Monthly Income</label>
                                        <input type="number" class="form-input" id="budgetNetIncome" placeholder="8084" min="0" step="0.01">
                                        <div class="form-help">Auto-calculated, but you can override if needed.</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-divider"></div>
                            
                            <div class="tax-results" id="budgetTaxResults" style="display: none;">
                                <div class="tax-summary">
                                    <div class="tax-item">
                                        <div class="tax-label">Monthly Gross Income</div>
                                        <div class="tax-value" id="budgetMonthlyGrossResult">$0.00</div>
                                    </div>
                                    <div class="tax-item">
                                        <div class="tax-label">Federal Tax (Monthly)</div>
                                        <div class="tax-value" id="budgetFederalTaxResult">$0.00</div>
                                    </div>
                                    <div class="tax-item">
                                        <div class="tax-label">Provincial Tax (Monthly)</div>
                                        <div class="tax-value" id="budgetProvincialTaxResult">$0.00</div>
                                    </div>
                                    <div class="tax-item">
                                        <div class="tax-label">CPP/EI (Monthly)</div>
                                        <div class="tax-value" id="budgetCppEiResult">$0.00</div>
                                    </div>
                                    <div class="tax-item total">
                                        <div class="tax-label">Net Monthly Income</div>
                                        <div class="tax-value" id="budgetNetIncomeResult">$0.00</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="text-lg font-semibold">Savings Goal</h3>
                    </div>
                    <div class="card-content">
                        <div class="form-group">
                            <label class="form-label" for="budgetAnnualSavingsGoal">Annual Savings Goal</label>
                            <input type="number" class="form-input" id="budgetAnnualSavingsGoal" placeholder="52000" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="budgetMonthlySavingsTarget">Monthly Savings Target</label>
                            <input type="number" class="form-input" id="budgetMonthlySavingsTarget" placeholder="4333" min="0" step="0.01" readonly>
                            <div class="form-help">Auto-calculated from annual savings goal.</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="text-lg font-semibold">Expenses</h3>
                    </div>
                    <div class="card-content">
                        <div class="form-group">
                            <label class="form-label" for="budgetFixedExpenses">Monthly Fixed Expenses</label>
                            <input type="number" class="form-input" id="budgetFixedExpenses" placeholder="2450" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="budgetEssentialExpenses">Monthly Essential Expenses</label>
                            <input type="number" class="form-input" id="budgetEssentialExpenses" placeholder="750" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="budgetDiscretionaryExpenses">Monthly Discretionary Expenses</label>
                            <input type="number" class="form-input" id="budgetDiscretionaryExpenses" placeholder="501" min="0" step="0.01">
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="text-lg font-semibold">Budget Summary</h3>
                    </div>
                    <div class="card-content">
                        <div class="budget-summary">
                            <div class="budget-item">
                                <div class="budget-label">Remaining Budget</div>
                                <div class="budget-value" id="budgetRemainingBudgetSummary">$0.00</div>
                            </div>
                            <div class="budget-item">
                                <div class="budget-label">Savings Rate</div>
                                <div class="budget-value" id="budgetSavingsRateSummary">0%</div>
                            </div>
                            <div class="budget-item">
                                <div class="budget-label">Validation</div>
                                <div class="budget-value" id="budgetValidationSummary">-</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button type="button" class="add-btn" onclick="saveBudgetSettings()">Save Budget</button>
            </div>
        </div>
    </div>
    
    <!-- Support Page Slide-out -->
    <div class="settings-overlay" id="supportOverlay">
        <div class="budget-panel" id="supportPanel">
            <div class="settings-header">
                <button class="settings-back" onclick="closeSupport()" aria-label="Back">
                    <i data-lucide="arrow-left" class="w-6 h-6"></i>
                </button>
                <h2 class="settings-title">Support</h2>
                <div style="width: 40px;"></div> <!-- Spacer for centering -->
            </div>

            <div class="settings-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="text-lg font-semibold">Contact Us</h3>
                    </div>
                    <div class="card-content">
                        <p class="text-sm text-muted-foreground mb-4">Need help? Send us a message and we'll get back to you as soon as possible.</p>
                        
                        <div class="form-group">
                            <label class="form-label" for="supportTitle">Subject</label>
                            <input type="text" class="form-input" id="supportTitle" placeholder="Brief description of your issue">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="supportDescription">Message</label>
                            <textarea class="form-input" id="supportDescription" rows="6" placeholder="Please describe your issue or question in detail..."></textarea>
                        </div>
                        
                        <button type="button" class="add-btn" onclick="sendSupportEmail()">Send Message</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Expense Slide-out -->
    <div class="slide-out-overlay" id="expenseSlideOut">
        <div class="slide-out-content">
            <div class="slide-out-header">
                <h3 class="slide-out-title">Add Expense</h3>
                <button class="slide-out-close" onclick="hideExpenseSlideOut()">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="slide-out-form">
                <!-- Date picker for month mode -->
                <div class="form-group" id="slideOutDatePickerGroup" style="display: none;">
                    <label class="form-label" for="slideOutExpenseDate">Date</label>
                    <div class="custom-datepicker" id="expenseCustomDatepicker">
                        <div class="datepicker-trigger" onclick="toggleDatepicker('expenseCustomDatepicker')" 
                             role="button" tabindex="0" aria-label="Select date" aria-expanded="false">
                            <span class="datepicker-value" id="expenseCustomDatepickerValue">Select date</span>
                            <i data-lucide="calendar" class="w-4 h-4"></i>
                        </div>
                        <div class="datepicker-popup" id="expenseCustomDatepickerPopup">
                            <div class="datepicker-header">
                                <button type="button" class="datepicker-nav" onclick="navigateMonth('expenseCustomDatepicker', -1)">
                                    <i data-lucide="chevron-left" class="w-4 h-4"></i>
                                </button>
                                <div class="datepicker-month-year" id="expenseCustomDatepickerMonthYear">
                                    December 2024
                                </div>
                                <button type="button" class="datepicker-nav" onclick="navigateMonth('expenseCustomDatepicker', 1)">
                                    <i data-lucide="chevron-right" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <div class="datepicker-grid" id="expenseCustomDatepickerGrid">
                                <!-- Calendar grid will be populated by JavaScript -->
                            </div>
                            <div class="datepicker-footer">
                                <button type="button" class="datepicker-btn datepicker-btn-secondary" onclick="clearDate('expenseCustomDatepicker')">
                                    Clear
                                </button>
                                <button type="button" class="datepicker-btn datepicker-btn-primary" onclick="selectToday('expenseCustomDatepicker')">
                                    Today
                                </button>
                            </div>
                        </div>
                        <input type="hidden" id="slideOutExpenseDate" name="slideOutExpenseDate">
                    </div>
                </div>
                
                <!-- Amount and Category side by side -->
                <div class="input-row">
                  <div class="form-group">
                    <label class="form-label" for="slideOutExpenseAmount">Amount ($)</label>
                    <input type="number" class="form-input" id="slideOutExpenseAmount" placeholder="0.00" step="0.01">
                  </div>
                  <div class="form-group">
                    <label class="form-label" for="slideOutExpenseCategory">Category</label>
                    <div class="select-container">
                      <div class="select-trigger" onclick="toggleSlideOutSelect('expenseCategory')" id="expenseCategoryTrigger">
                        <span id="expenseCategoryValue">Groceries</span>
                        <i data-lucide="chevron-down" class="w-4 h-4"></i>
                      </div>
                      <div class="select-content" id="expenseCategoryContent">
                        <div class="select-item selected" data-value="groceries">Groceries</div>
                        <div class="select-item" data-value="transportation">Transportation</div>
                        <div class="select-item" data-value="dining">Dining Out</div>
                        <div class="select-item" data-value="entertainment">Entertainment</div>
                        <div class="select-item" data-value="personal">Personal Care</div>
                        <div class="select-item" data-value="clothing">Clothing</div>
                        <div class="select-item" data-value="health">Health/Fitness</div>
                        <div class="select-item" data-value="subscriptions">Subscriptions</div>
                        <div class="select-item" data-value="other">Other</div>
                      </div>
                    </div>
                    <!-- Hidden native select for compatibility -->
                    <select id="slideOutExpenseCategory" style="display: none;">
                      <option value="groceries">Groceries</option>
                      <option value="transportation">Transportation</option>
                      <option value="dining">Dining Out</option>
                      <option value="entertainment">Entertainment</option>
                      <option value="personal">Personal Care</option>
                      <option value="clothing">Clothing</option>
                      <option value="health">Health/Fitness</option>
                      <option value="subscriptions">Subscriptions</option>
                      <option value="other">Other</option>
                    </select>
                  </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="slideOutExpenseDescription">Description (optional)</label>
                    <input type="text" class="form-input" id="slideOutExpenseDescription" placeholder="What did you buy?">
                </div>
                
                <button type="button" class="add-btn" onclick="addExpenseFromSlideOut()">Add Expense</button>
            </div>
        </div>
    </div>
    
    <!-- Balance Slide-out -->
    <div class="slide-out-overlay" id="balanceSlideOut">
        <div class="slide-out-content">
            <div class="slide-out-header">
                <h3 class="slide-out-title">Record Balance</h3>
                <button class="slide-out-close" onclick="hideBalanceSlideOut()">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="slide-out-form">
                <!-- Date field above -->
                <div class="form-group">
                  <label class="form-label" for="slideOutBalanceDate">Date</label>
                  <div class="custom-datepicker" id="balanceCustomDatepicker">
                    <div class="datepicker-trigger" onclick="toggleDatepicker('balanceCustomDatepicker')"
                         role="button" tabindex="0" aria-label="Select date" aria-expanded="false">
                      <span class="datepicker-value" id="balanceCustomDatepickerValue">Select date</span>
                      <i data-lucide="calendar" class="w-4 h-4"></i>
                    </div>
                    <div class="datepicker-popup" id="balanceCustomDatepickerPopup">
                      <div class="datepicker-header">
                        <button type="button" class="datepicker-nav" onclick="navigateMonth('balanceCustomDatepicker', -1)">
                          <i data-lucide="chevron-left" class="w-4 h-4"></i>
                        </button>
                        <div class="datepicker-month-year" id="balanceCustomDatepickerMonthYear">
                          December 2024
                        </div>
                        <button type="button" class="datepicker-nav" onclick="navigateMonth('balanceCustomDatepicker', 1)">
                          <i data-lucide="chevron-right" class="w-4 h-4"></i>
                        </button>
                      </div>
                      <div class="datepicker-grid" id="balanceCustomDatepickerGrid">
                        <!-- Calendar grid will be populated by JavaScript -->
                      </div>
                      <div class="datepicker-footer">
                        <button type="button" class="datepicker-btn datepicker-btn-secondary" onclick="clearDate('balanceCustomDatepicker')">
                          Clear
                        </button>
                        <button type="button" class="datepicker-btn datepicker-btn-primary" onclick="selectToday('balanceCustomDatepicker')">
                          Today
                        </button>
                      </div>
                    </div>
                    <input type="hidden" id="slideOutBalanceDate" name="slideOutBalanceDate">
                  </div>
                </div>
                <!-- Account and Balance side by side -->
                <div class="input-row">
                  <div class="form-group">
                    <label class="form-label" for="slideOutBalanceAccount">Account</label>
                    <div class="select-container">
                      <div class="select-trigger" onclick="toggleSlideOutSelect('balanceAccount')" id="balanceAccountTrigger">
                        <span id="balanceAccountValue">Checking</span>
                        <i data-lucide="chevron-down" class="w-4 h-4"></i>
                      </div>
                      <div class="select-content" id="balanceAccountContent">
                        <!-- Options will be populated by JavaScript -->
                      </div>
                    </div>
                    <!-- Hidden native select for compatibility -->
                    <select id="slideOutBalanceAccount" style="display: none;">
                      <!-- Options will be populated by JavaScript -->
                    </select>
                  </div>
                  <div class="form-group">
                    <label class="form-label" for="slideOutBalanceAmount">Balance ($)</label>
                    <input type="number" class="form-input" id="slideOutBalanceAmount" placeholder="0.00" step="0.01">
                  </div>
                </div>
                
                <button type="button" class="balance-add-btn" onclick="addBalanceFromSlideOut()">Add Balance</button>
            </div>
        </div>
    </div>
    
    <!-- Account Management Slide-out -->
    <div class="account-management-slide-out" id="accountManagementSlideOut">
        <div class="account-management-content">
            <div class="account-management-header">
                <h3 class="account-management-title">Manage Accounts</h3>
                <button class="account-management-close" onclick="hideAccountManagementSlideOut()">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="account-management-list" id="accountManagementList">
                <!-- Account list will be populated by JavaScript -->
            </div>
            
            <div class="account-management-add-form">
                <h4 class="account-management-add-title">Add New Account</h4>
                <div class="account-management-input-group">
                    <input type="text" class="account-management-input" id="newAccountNameSlideOut" placeholder="e.g., Emergency Fund">
                </div>
                <button class="account-management-add-btn" onclick="addNewAccountFromSlideOut()">Add Account</button>
            </div>
        </div>
    </div>
    
    <!-- Legacy Account Management Modal (hidden for backwards compatibility) -->
    <div class="modal-overlay" id="accountManagementModal" style="display: none !important;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Manage Accounts</h3>
                <button class="modal-close" onclick="hideAccountManagementModal()">Ã—</button>
            </div>
            
            <div class="account-list" id="accountList">
                <!-- Account list will be populated by JavaScript -->
            </div>
            
            <div class="add-account-form">
                <h4 class="text-lg font-semibold mb-4">Add New Account</h4>
                <div class="form-group">
                    <label class="form-label" for="newAccountName">Account Name</label>
                    <input type="text" id="newAccountName" class="form-input" placeholder="e.g., Emergency Fund">
                </div>
                <button class="add-account-btn" onclick="addNewAccount()">Add Account</button>
            </div>
        </div>
    </div>
    
    <!-- Month/Year Slide-out -->
    <div class="slide-out-overlay" id="monthYearSlideOut">
        <div class="slide-out-content">
            <div class="slide-out-handle"></div>
            <div class="slide-out-header">
                <h3 class="slide-out-title">Select Month & Year</h3>
                <button class="slide-out-close" onclick="hideMonthYearSlideOut()">Ã—</button>
            </div>
            <div class="slide-out-form">
                <div class="form-group">
                    <label class="form-label" for="monthInput">Month</label>
                    <div class="select-container">
                        <div class="select-trigger" onclick="toggleSlideOutSelect('monthSelect')" id="monthSelectTrigger">
                            <span id="monthSelectValue">January</span>
                            <i data-lucide="chevron-down" class="w-4 h-4"></i>
                        </div>
                        <div class="select-content" id="monthSelectContent">
                            <div class="select-item" data-value="0">January</div>
                            <div class="select-item" data-value="1">February</div>
                            <div class="select-item" data-value="2">March</div>
                            <div class="select-item" data-value="3">April</div>
                            <div class="select-item" data-value="4">May</div>
                            <div class="select-item" data-value="5">June</div>
                            <div class="select-item" data-value="6">July</div>
                            <div class="select-item" data-value="7">August</div>
                            <div class="select-item" data-value="8">September</div>
                            <div class="select-item" data-value="9">October</div>
                            <div class="select-item" data-value="10">November</div>
                            <div class="select-item" data-value="11">December</div>
                        </div>
                    </div>
                    <!-- Hidden native select for compatibility -->
                    <select class="form-input" id="monthInput" style="display: none;">
                        <option value="0">January</option>
                        <option value="1">February</option>
                        <option value="2">March</option>
                        <option value="3">April</option>
                        <option value="4">May</option>
                        <option value="5">June</option>
                        <option value="6">July</option>
                        <option value="7">August</option>
                        <option value="8">September</option>
                        <option value="9">October</option>
                        <option value="10">November</div>
                        <option value="11">December</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="yearInput">Year</label>
                    <div class="select-container">
                        <div class="select-trigger" onclick="toggleSlideOutSelect('monthYear')" id="monthYearTrigger">
                            <span id="monthYearValue">2024</span>
                            <i data-lucide="chevron-down" class="w-4 h-4"></i>
                        </div>
                        <div class="select-content" id="monthYearContent">
                            <!-- Year options will be populated by JavaScript -->
                        </div>
                    </div>
                    <!-- Hidden native select for compatibility -->
                    <select id="yearInput" style="display: none;">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                <button type="button" class="add-btn" id="applyMonthYearBtn" style="margin-top:1rem;">Apply</button>
            </div>
        </div>
    </div>
    
      <!-- Clerk -->
  <script>
  window.addEventListener('load', async function () {
    await Clerk.load()

    if (Clerk.user) {
      
      const userButton = document.createElement('div');
      userButton.setAttribute('id', 'user-button');
      const app = document.querySelector('#user-avatar');
      if (!app) {
        console.error('App element not found');
        return;
      } else {
        app.appendChild(userButton);
      }
        
      const userButtonDiv = document.getElementById('user-button')

      Clerk.mountUserButton(userButtonDiv)
    } else {
      document.getElementById('app').innerHTML = `
        <div id="sign-in"></div>
      `

      const signInDiv = document.getElementById('sign-in')

      Clerk.mountSignIn(signInDiv)
    }
  })
</script>

    <script>
        // Firebase configuration (add your actual config)
        const firebaseConfig = {
            // Replace with your Firebase config
            apiKey: "your-api-key",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "your-app-id"
        };

        // Initialize Firebase (uncomment when you have real config)
        // firebase.initializeApp(firebaseConfig);
        // const db = firebase.firestore();

        // Period tracking variables
        let currentPeriodMode = 'month'; // 'today' or 'month'
        let currentSavePeriodMode = 'month'; // 'today' or 'month' for save screen
        let selectedMonthDate = new Date();
        let selectedSaveMonthDate = new Date(); // Separate month date for save screen
        let currentChartPeriod = 'ALL'; // '1M', '3M', '6M', 'YTD', '1Y', 'ALL' - Changed from YTD to ALL to show all balance data
        
        let currentScreen = 0;
        let spendingChart;
        
        // Storage keys
        const EXPENSES_KEY = 'dailyExpenses';
        const MONTHLY_DATA_KEY = 'monthlyData';
        const SAVINGS_ACCOUNTS_KEY = 'savingsAccounts';
        const ACCOUNT_BALANCES_KEY = 'accountBalances';
        
        // Budget functions that get values from settings
        function getDailyBudget() {
            const settings = getSimpleBudgetSettings();
            const discretionaryBudget = settings.discretionaryExpenses || 501;
            const dailyBudget = discretionaryBudget / 30; // Daily discretionary budget
            console.log('Daily budget calculated:', dailyBudget, 'from discretionary:', discretionaryBudget);
            return dailyBudget;
        }
        
        function getWeeklyBudget() {
            return getDailyBudget() * 7;
        }
        
        function getMonthlyBudget() {
            const settings = getSimpleBudgetSettings();
            const budget = (settings.essentialExpenses || 750) + (settings.discretionaryExpenses || 501);
            console.log('Monthly budget calculated:', budget, 'from settings:', settings);
            return budget;
        }
        
        function getMonthlySavingsTarget() {
            const settings = getSimpleBudgetSettings();
            return settings.monthlySavingsTarget || 4333;
        }
        
        function getSimpleBudgetSettings() {
            const savedSettings = localStorage.getItem('simpleBudgetSettings');
            if (savedSettings) {
                return JSON.parse(savedSettings);
            }
            // Return default values if no settings saved
            return {
                grossIncome: 11667,
                federalTax: 2500,
                provincialTax: 750,
                cppEi: 333,
                netIncome: 8084,
                annualSavingsGoal: 52000,
                monthlySavingsTarget: 4333,
                fixedExpenses: 2450,
                essentialExpenses: 750,
                discretionaryExpenses: 501
            };
        }
        
        // Savings tracking variables
        savingsAccounts = [];
        
        // Default accounts
        const defaultAccounts = [
            { id: 'checking', name: 'Checking', type: 'checking' },
            { id: 'savings', name: 'Savings', type: 'savings' },
            { id: 'investment', name: 'Investment', type: 'investment' }
        ];
        
        function goToScreen(screenIndex) {
            currentScreen = screenIndex;
            const wrapper = document.getElementById('screensWrapper');
            wrapper.style.transform = `translateX(-${screenIndex * 100}vw)`;
            
            // Update nav items
            document.querySelectorAll('.nav-item').forEach((item, index) => {
                item.classList.toggle('active', index === screenIndex);
            });
            
            if (screenIndex === 2) {
                updateReports();
                setTimeout(updateChart, 300);
            } else if (screenIndex === 0) {
                // Ensure today mode is set when navigating to tracking screen
                setPeriodMode('today');
            } else if (screenIndex === 1) {
                // Save screen - currently blank, ready for future functionality
                console.log('Save screen loaded');
                // Set month mode as default for save screen
                setSavePeriodMode('month');
                updateSaveScreen();
            }
        }
        
        
        function getCurrentDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function loadAccountBalances() {
            const balances = localStorage.getItem('accountBalances');
            return balances ? JSON.parse(balances) : {};
        }
        
        function saveAccountBalances(balances) {
            localStorage.setItem('accountBalances', JSON.stringify(balances));
        }
        
        function updatePeriodView() {
            updateBudgetDisplay();
            updateExpensesList();
            updateTotalSavingsDisplay(); // Always update, regardless of mode
            updateSaveScreen(); // Update save screen as well
        }
        
        function updateBudgetDisplay() {
            const expenses = loadExpenses();
            let totalSpent = 0;
            let periodLabel = '';
            let description = '';
            
            if (currentPeriodMode === 'today') {
                const today = getCurrentDate();
                const todayExpenses = expenses[today] || [];
                totalSpent = todayExpenses.reduce((sum, expense) => sum + expense.amount, 0);
                periodLabel = 'Daily Budget';
                description = 'for all variable expenses';
                
                const remainingLabel = document.getElementById('remainingLabel');
                if (remainingLabel) {
                    remainingLabel.textContent = 'Remaining Today';
                }
            } else {
                // Month mode
                const monthKey = getCurrentPeriodKey();
                Object.keys(expenses).forEach(date => {
                    if (date.startsWith(monthKey)) {
                        const dayExpenses = expenses[date] || [];
                        totalSpent += dayExpenses.reduce((sum, expense) => sum + expense.amount, 0);
                    }
                });
                
                const monthName = selectedMonthDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                periodLabel = `${monthName} Budget`;
                description = 'monthly spending budget';
                
                const remainingLabel = document.getElementById('remainingLabel');
                if (remainingLabel) {
                    remainingLabel.textContent = 'Remaining This Month';
                }
            }
            
            const budget = currentPeriodMode === 'today' ? getDailyBudget() : getMonthlyBudget();
            const remaining = budget - totalSpent;
            
            // Update display elements if they exist
            const budgetPeriodLabel = document.getElementById('budgetPeriodLabel');
            const budgetAmount = document.getElementById('budgetAmount');
            const remainingBudget = document.getElementById('remainingBudget');
            
            if (budgetPeriodLabel) {
                budgetPeriodLabel.textContent = periodLabel;
            }
            if (budgetAmount) {
                budgetAmount.textContent = formatCurrency(budget);
            }
            if (remainingBudget) {
                remainingBudget.textContent = formatCurrency(remaining);
            }
            
            // Update budget status
            if (document.getElementById('budgetStatusText')) {
                const percentUsed = (totalSpent / budget) * 100;
                let statusText = '';
                let statusColor = '';
                let cardBackgroundColor = '';
                let amountColor = '';
                
                if (percentUsed >= 90) {
                    statusText = 'Over Budget';
                    statusColor = 'hsl(0deg 84% 60%)'; // Red
                    cardBackgroundColor = 'hsl(0deg 84% 96%)'; // Light red background
                    amountColor = 'hsl(0deg 84% 20%)'; // Dark red text
                } else if (percentUsed >= 75) {
                    statusText = 'Warning';
                    statusColor = 'hsl(38deg 92% 50%)'; // Orange
                    cardBackgroundColor = 'hsl(38deg 92% 96%)'; // Light orange background
                    amountColor = 'hsl(38deg 92% 20%)'; // Dark orange text
                } else {
                    statusText = 'On Track';
                    statusColor = 'hsl(156.06deg 40% 40%)'; // Green
                    cardBackgroundColor = 'hsl(156.06deg 40% 96%)'; // Light green background
                    amountColor = 'hsl(156.06deg 40% 20%)'; // Dark green text
                }
                
                document.getElementById('budgetStatusText').textContent = statusText;
                document.getElementById('budgetStatusText').style.backgroundColor = statusColor;
                
                // Update remaining budget card background and text color
                const remainingBudgetContainer = document.querySelector('.remaining-budget-section');
                const remainingBudgetAmount = document.getElementById('remainingBudget');
                
                if (remainingBudgetContainer && remainingBudgetAmount) {
                    remainingBudgetContainer.style.backgroundColor = cardBackgroundColor;
                    remainingBudgetAmount.style.color = amountColor;
                }
            }
        }
        
        function updateExpensesList() {
            const expenses = loadExpenses();
            const listContainer = document.getElementById('expensesList');
            const titleElement = document.getElementById('expensesListTitle');
            
            if (!listContainer) return;
            
            let periodExpenses = [];
            
            if (currentPeriodMode === 'today') {
                const today = getCurrentDate();
                periodExpenses = expenses[today] || [];
                // Add the date to each expense for consistent handling
                periodExpenses = periodExpenses.map(expense => ({
                    ...expense,
                    date: today
                }));
                if (titleElement) titleElement.textContent = "Today's Expenses";
            } else {
                // Month mode: gather all expenses for the selected month
                const monthKey = getCurrentPeriodKey();
                Object.keys(expenses).forEach(date => {
                    if (date.startsWith(monthKey)) {
                        const dayExpenses = expenses[date] || [];
                        dayExpenses.forEach(expense => {
                            periodExpenses.push({
                                ...expense,
                                date: date
                            });
                        });
                    }
                });
                
                // Sort: by date (desc), then by created (asc), then by timestamp for stability
                periodExpenses.sort((a, b) => {
                    if (a.date !== b.date) {
                        return new Date(b.date) - new Date(a.date); // latest date first
                    }
                    // If same date, sort by created descending (newest first)
                    const createdA = a.created || a.timestamp;
                    const createdB = b.created || b.timestamp;
                    if (createdA !== createdB) {
                        return createdB - createdA; // Reversed order
                    }
                    // If created timestamps are the same, use timestamp for stable ordering
                    return b.timestamp - a.timestamp; // Reversed order
                });
                
                const monthName = selectedMonthDate.toLocaleDateString('en-US', { month: 'long' });
                if (titleElement) titleElement.textContent = `${monthName} Expenses`;
            }
            
            if (periodExpenses.length === 0) {
                const noExpensesText = currentPeriodMode === 'today' ? 'No expenses recorded today' : 'No expenses recorded this month';
                listContainer.innerHTML = `<div style="text-align: center; color: #7f8c8d; padding: 20px;">${noExpensesText}</div>`;
            } else {
                listContainer.innerHTML = periodExpenses.map((expense, index) => {
                    let displayDate = '';
                    if (currentPeriodMode === 'month') {
                        // Parse date manually to avoid timezone issues
                        const dateParts = expense.date.split('-').map(Number);
                        const dateObj = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
                        displayDate = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' â€¢ ';
                    }
                    
                    return `
                        <div class="swipe-container" data-type="expense" data-date="${expense.date}" data-timestamp="${expense.timestamp}">
                            <div class="swipe-content">
                                <div class="expense-item">
                                    <div class="expense-details">
                                        ${expense.description ? `<div class="expense-description">${expense.description}</div>` : ''}
                                        <div class="expense-category">${displayDate}${expense.category}</div>
                                    </div>
                                    <div class="expense-amount">${formatCurrency(expense.amount)}</div>
                                </div>
                            </div>
                            <div class="swipe-action" onclick="handleExpenseDelete(this); event.stopPropagation(); return false;"><i data-lucide="x" class="w-5 h-5"></i></div>
                        </div>
                    `;
                }).join('');
            }
        }
        
        function deleteExpense(date, timestamp) {
            console.log('âš ï¸ deleteExpense function called with date:', date, 'and timestamp:', timestamp);
            timestamp = parseInt(timestamp, 10); // Ensure timestamp is a number
            
            if (!date || isNaN(timestamp)) {
                console.error('Invalid date or timestamp:', { date, timestamp });
                alert('Invalid date or timestamp. Cannot delete expense.');
                return;
            }
            
            try {
                const expenses = loadExpenses();
                console.log('Current expenses for date:', date, expenses[date]);
                
                // Handle the case where date might be undefined for today mode
                const targetDate = date || getCurrentDate();
                console.log('Target date for deletion:', targetDate);
                
                if (expenses[targetDate]) {
                    console.log('Found expenses for target date:', expenses[targetDate].length);
                    console.log('Expense timestamps:', expenses[targetDate].map(e => e.timestamp));
                    
                    // Filter out the expense with the matching timestamp
                    const originalLength = expenses[targetDate].length;
                    expenses[targetDate] = expenses[targetDate].filter(expense => {
                        const match = expense.timestamp !== timestamp;
                        console.log(`Comparing ${expense.timestamp} with ${timestamp}: ${match ? 'keep' : 'remove'}`);
                        return expense.timestamp !== timestamp;
                    });
                    
                    // Check if the expense was actually removed
                    if (expenses[targetDate].length === originalLength) {
                        console.error('âš ï¸ Expense not found with timestamp:', timestamp);
                        alert('Could not find expense to delete. Please refresh and try again.');
                        
                        // Remove the 'deleting' class from the element to restore it
                        const swipeContainer = document.querySelector(`.swipe-container[data-timestamp="${timestamp}"]`);
                        if (swipeContainer) {
                            swipeContainer.classList.remove('deleting');
                        }
                        
                        return;
                    }
                    
                    console.log('After filtering, expenses length:', expenses[targetDate].length);
                    
                    // Remove the date entry if no expenses left for that date
                    if (expenses[targetDate].length === 0) {
                        console.log('No expenses left for date, removing date entry');
                        delete expenses[targetDate];
                    }
                    
                    // Save the updated expenses
                    console.log('Saving updated expenses');
                    saveExpenses(expenses);
                    
                    // Force refresh UI
                    const listContainer = document.getElementById('expensesList');
                    if (listContainer) {
                        console.log('Forcing expense list refresh');
                        updateExpensesList();
                    }
                    
                    // Update the rest of the display
                    console.log('Updating UI after deletion');
                    updatePeriodView();
                    updateChart();
                    
                    console.log('âœ… Expense deleted successfully');
             
                } else {
                    console.error('No expenses found for date:', targetDate);
                    alert('Could not find expenses for this date. Please refresh and try again.');
                    
                    // Remove the 'deleting' class from the element to restore it
                    const swipeContainer = document.querySelector(`.swipe-container[data-timestamp="${timestamp}"]`);
                    if (swipeContainer) {
                        swipeContainer.classList.remove('deleting');
                    }
                }
            } catch (error) {
                console.error('Error in deleteExpense function:', error);
                alert('An error occurred while deleting the expense. Please try again.');
                
                // Remove the 'deleting' class from the element to restore it
                const swipeContainer = document.querySelector(`.swipe-container[data-timestamp="${timestamp}"]`);
                if (swipeContainer) {
                    swipeContainer.classList.remove('deleting');
                }
            }
        }
        
        function updateReports() {
            // Update weekly and monthly stats
            const expenses = loadExpenses();
            const today = new Date();
            const dayOfMonth = today.getDate();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            const remainingDaysInMonth = daysInMonth - dayOfMonth;

            // Calculate weekly spending
            let weeklySpent = 0;
            let monthlySpent = 0; // <-- Add this missing declaration
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                const dayExpenses = expenses[dateKey] || [];
                weeklySpent += dayExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            }

            // Calculate monthly spending
            Object.keys(expenses).forEach(date => {
                if (date.startsWith(getCurrentMonth())) {
                    const dayExpenses = expenses[date] || [];
                    monthlySpent += dayExpenses.reduce((sum, expense) => sum + expense.amount, 0);
                }
            });

            // Calculate daily burn rate (average spent per day)
            const dailyBurnRate = monthlySpent / dayOfMonth;
            
            // Calculate projected spending for the rest of the month
            const projectedAdditionalSpending = dailyBurnRate * remainingDaysInMonth;
            const projectedTotalSpending = monthlySpent + projectedAdditionalSpending;
            
            // Calculate projected monthly savings
            const projectedMonthlySavings = Math.max(0, getMonthlyBudget() - projectedTotalSpending);
            
            // Calculate days left in budget (at current burn rate)
            const remainingBudget = getMonthlyBudget() - monthlySpent;
            const daysLeftInBudget = dailyBurnRate > 0 ? Math.floor(remainingBudget / dailyBurnRate) : remainingDaysInMonth;
            
            // Calculate savings rate (assuming budget = income - required savings)
            // This is an approximation - in reality, we'd need income data
            const assumedIncome = getMonthlyBudget() + getMonthlySavingsTarget();
            const projectedSavings = assumedIncome - projectedTotalSpending;
            const savingsRate = (projectedSavings / assumedIncome) * 100;
            
            // Update weekly metrics
            const weeklySpentEl = document.getElementById('weeklySpent');
            const weeklyRemainingEl = document.getElementById('weeklyRemaining');
            const projectedMonthlySavingsEl = document.getElementById('projectedMonthlySavings');
            
            if (weeklySpentEl) weeklySpentEl.textContent = formatCurrencyWhole(weeklySpent);
            if (weeklyRemainingEl) weeklyRemainingEl.textContent = formatCurrencyWhole(Math.max(0, getWeeklyBudget() - weeklySpent));
            if (projectedMonthlySavingsEl) projectedMonthlySavingsEl.textContent = formatCurrencyWhole(projectedMonthlySavings);
            
            // Update monthly stats
            const monthlySpentEl = document.getElementById('monthlySpent');
            const monthSpentSubtitleEl = document.getElementById('monthSpentSubtitle');
            const dailyBurnRateEl = document.getElementById('dailyBurnRate');
            const burnRateStatusEl = document.getElementById('burnRateStatus');
            const daysRemainingEl = document.getElementById('daysRemaining');
            const daysRemainingSubtitleEl = document.getElementById('daysRemainingSubtitle');
            const savingsRateEl = document.getElementById('savingsRate');
            const savingsRateSubtitleEl = document.getElementById('savingsRateSubtitle');
            
            // Update month spent with percentage indicator
            if (monthlySpentEl) monthlySpentEl.textContent = formatCurrencyWhole(monthlySpent);
            if (monthSpentSubtitleEl) {
                            const percentUsed = (monthlySpent / getMonthlyBudget()) * 100;
            monthSpentSubtitleEl.textContent = `${percentUsed.toFixed(0)}% of ${formatCurrency(getMonthlyBudget())} budget`;
            }
            
            // Update daily burn rate with status
            if (dailyBurnRateEl) dailyBurnRateEl.textContent = formatCurrencyWhole(dailyBurnRate);
            if (burnRateStatusEl) {
                const dailyTarget = getMonthlyBudget() / daysInMonth;
                const difference = dailyTarget - dailyBurnRate;
                let burnRateStatus = '';
                
                if (difference > 0) {
                    burnRateStatus = `${formatCurrencyWhole(difference)} under target`;
                    burnRateStatusEl.className = 'stat-subtitle positive';
                } else if (difference < 0) {
                    burnRateStatus = `${formatCurrencyWhole(Math.abs(difference))} over target`;
                    burnRateStatusEl.className = 'stat-subtitle negative';
                } else {
                    burnRateStatus = 'right on target';
                    burnRateStatusEl.className = 'stat-subtitle';
                }
                
                burnRateStatusEl.textContent = burnRateStatus;
            }
            
            // Update days left in budget
            if (daysRemainingEl) {
                if (daysLeftInBudget >= remainingDaysInMonth) {
                    daysRemainingEl.textContent = remainingDaysInMonth;
                    daysRemainingEl.className = 'stat-value positive';
                } else if (daysLeftInBudget <= 0) {
                    daysRemainingEl.textContent = '0';
                    daysRemainingEl.className = 'stat-value negative';
                } else {
                    daysRemainingEl.textContent = daysLeftInBudget;
                    if (daysLeftInBudget < 7) {
                        daysRemainingEl.className = 'stat-value warning';
                    } else {
                        daysRemainingEl.className = 'stat-value';
                    }
                }
            }
            
            if (daysRemainingSubtitleEl) {
                const daysMessage = daysLeftInBudget >= remainingDaysInMonth ? 
                    'on track' : `${remainingDaysInMonth - daysLeftInBudget} days short`;
                daysRemainingSubtitleEl.textContent = daysMessage;
            }
            
            // Update savings rate
            if (savingsRateEl) {
                savingsRateEl.textContent = `${Math.max(0, savingsRate).toFixed(0)}%`;
                
                // Styling based on savings goal
                const targetSavingsRate = (getMonthlySavingsTarget() / assumedIncome) * 100;
                if (savingsRate >= targetSavingsRate) {
                    savingsRateEl.className = 'stat-value positive';
                } else if (savingsRate >= targetSavingsRate * 0.7) {
                    savingsRateEl.className = 'stat-value warning';
                } else {
                    savingsRateEl.className = 'stat-value negative';
                }
            }
            
            if (savingsRateSubtitleEl) {
                savingsRateSubtitleEl.textContent = `vs ${(getMonthlySavingsTarget() / assumedIncome * 100).toFixed(0)}% target`;
            }
            
            // Update month name in labels
            updateMonthLabel();
        }
        
        function updateMonthLabel() {
            const monthName = new Date().toLocaleDateString('en-US', { month: 'long' });
            const monthSpentLabelEl = document.getElementById('monthSpentLabel');
            
            if (monthSpentLabelEl) {
                monthSpentLabelEl.textContent = `${monthName} Spent`;
            }
        }
        
        function setChartPeriod(period) {
            // If it's the same period, don't do anything
            if (currentChartPeriod === period) return;
            
            // Store the previous period for animation
            const previousPeriod = currentChartPeriod;
            currentChartPeriod = period;
            
            // Update button states with smooth transition
            document.querySelectorAll('.chart-period-btn-wealthsimple').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const periodBtn = document.getElementById('period' + period);
            if (periodBtn) {
                // Small delay for visual feedback
                setTimeout(() => {
                    periodBtn.classList.add('active');
                }, 10);
            }
            
            // Add loading indicator if needed for longer data sets
            const chartContainer = document.querySelector('.chart-container');
            if (period === 'ALL') {
                chartContainer.classList.add('loading');
            }
            
            // Slight delay for animation
            setTimeout(() => {
                updateChart();
                chartContainer.classList.remove('loading');
            }, 100);
        }
        
        function updateChart() {
            // Get expenses and balances
            const expenses = loadExpenses();
            const balances = loadAccountBalances();
            
            // Get chart canvas
            const ctx = document.getElementById('spendingChart').getContext('2d');
            
            // Calculate date range based on selected period
            const endDate = new Date();
            let startDate;

             // Helper to find the nearest data index from x coordinate
            function getNearestIndex(x) {
                const chartArea = spendingChart.chartArea;
                if (!chartArea) return savingsData.length - 1;
                const xScale = spendingChart.scales.x;
                let minDist = Infinity;
                let nearest = 0;
                for (let i = 0; i < labels.length; i++) {
                    const px = xScale.getPixelForValue(i);
                    const dist = Math.abs(px - x);
                    if (dist < minDist) {
                        minDist = dist;
                        nearest = i;
                    }
                }
                return nearest;
            }
            
            switch (currentChartPeriod) {
                case '1M':
                    startDate = new Date();
                    startDate.setMonth(startDate.getMonth() - 1);
                    break;
                case '3M':
                    startDate = new Date();
                    startDate.setMonth(startDate.getMonth() - 3);
                    break;
                case '6M':
                    startDate = new Date();
                    startDate.setMonth(startDate.getMonth() - 6);
                    break;
                case 'YTD':
                    startDate = new Date(endDate.getFullYear(), 0, 1); // Jan 1st of current year
                    break;
                case '1Y':
                    startDate = new Date();
                    startDate.setFullYear(startDate.getFullYear() - 1);
                    break;
                case 'ALL':
                default:
                    // For 'ALL', go back 2 years or to the first record, whichever is earlier
                    startDate = new Date();
                    startDate.setFullYear(startDate.getFullYear() - 2);
                    break;
            }
            
            // Generate dates between start and end date
            const dates = [];
            const currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                dates.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Format dates for labels and lookup
            const labels = dates.map(date => {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            
            const dateKeys = dates.map(date => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            });
            
            // Calculate cumulative spending
            const spendingData = [];
            let cumulativeSpending = 0;
            
            dateKeys.forEach(dateKey => {
                const dayExpenses = expenses[dateKey] || [];
                const dayTotal = dayExpenses.reduce((sum, expense) => sum + expense.amount, 0);
                cumulativeSpending += dayTotal;
                spendingData.push(cumulativeSpending);
            });
            
            // Calculate account balances over time
            const savingsData = new Array(dates.length).fill(null);
            
            // Get all balance records and sort by date
            const balanceRecords = [];
            console.log('=== CHART BALANCE DEBUGGING ===');
            console.log('Chart period:', currentChartPeriod);
            console.log('Date range:', dateKeys[0], 'to', dateKeys[dateKeys.length - 1]);
            console.log('All balances from localStorage:', balances);
            
            // Create a map to sum up all account balances for each date
            const dateBalanceMap = new Map();
            
            Object.keys(balances).forEach(accountId => {
                const accountBalances = balances[accountId] || {};
                console.log(`Account ${accountId} balances:`, accountBalances);
                Object.keys(accountBalances).forEach(date => {
                    console.log(`Checking balance date: ${date} (in range: ${date >= dateKeys[0] && date <= dateKeys[dateKeys.length - 1]})`);
                    if (date >= dateKeys[0] && date <= dateKeys[dateKeys.length - 1]) {
                        const currentBalance = dateBalanceMap.get(date) || 0;
                        const accountBalance = accountBalances[date];
                        const newTotal = currentBalance + accountBalance;
                        dateBalanceMap.set(date, newTotal);
                        console.log(`âœ“ Added balance for ${date}: $${accountBalance} (account: ${accountId}) â†’ Total: $${newTotal}`);
                    } else {
                        console.log(`âœ— Skipped balance record: ${date} = $${accountBalances[date]} (outside date range)`);
                    }
                });
            });
            
            // Convert the map to balance records array
            dateBalanceMap.forEach((totalAmount, date) => {
                balanceRecords.push({
                    date: date,
                    amount: totalAmount
                });
            });
            
            console.log('Final balance records for chart (summed by date):', balanceRecords);
            console.log('=== END CHART BALANCE DEBUGGING ===');
            
            // Sort balance records by date
            balanceRecords.sort((a, b) => a.date.localeCompare(b.date));
            
            // Calculate total balance for each date
            let lastKnownBalance = 0;
            balanceRecords.forEach(record => {
                const dateIndex = dateKeys.indexOf(record.date);
                if (dateIndex !== -1) {
                    lastKnownBalance = record.amount;
                    savingsData[dateIndex] = lastKnownBalance;
                }
            });
            
            // Fill in missing balance data using last known balance
            for (let i = 0; i < savingsData.length; i++) {
                if (savingsData[i] === null) {
                    if (i > 0 && savingsData[i-1] !== null) {
                        savingsData[i] = savingsData[i-1];
                    } else {
                        savingsData[i] = 0; // Default if no previous balance
                    }
                }
            }
            
            // Calculate total savings and growth
            const initialSavings = savingsData[0] || 0;
            const finalSavings = savingsData[savingsData.length - 1] || 0;
            const savingsGrowth = finalSavings - initialSavings;
            const savingsGrowthPercent = initialSavings > 0 ? (savingsGrowth / initialSavings) * 100 : 0;

            // Calculate total spending and growth
            const initialSpending = spendingData[0] || 0;
            const finalSpending = spendingData[spendingData.length - 1] || 0;
            const spendingGrowth = finalSpending - initialSpending;
            const spendingGrowthPercent = initialSpending > 0 ? (spendingGrowth / initialSpending) * 100 : 0;

            // Chart header DOM elements for both rows
            const chartMainValue = document.getElementById('chartMainValue');
            const chartSubtitle = document.getElementById('chartSubtitle');
            const chartGrowth = document.getElementById('chartGrowth');
            const chartSpendingValue = document.getElementById('chartSpendingValue');
            const chartSpendingSubtitle = document.getElementById('chartSpendingSubtitle');
            const chartSpendingGrowth = document.getElementById('chartSpendingGrowth');

            /**
             * Updates chart header for a given index showing both savings and spending values.
             * @param {number} index - The data index to display.
             */
            function updateChartHeader(index) {
                if (!chartMainValue || !chartSubtitle || !chartGrowth || 
                    !chartSpendingValue || !chartSpendingSubtitle || !chartSpendingGrowth) return;
                
                const saved = savingsData[index];
                const spent = spendingData[index];
                const dateLabel = labels[index];
                
                // Update savings row
                chartMainValue.textContent = formatCurrency(saved);
                chartSubtitle.textContent = `${dateLabel} â€¢ Total Savings`;
                
                // Calculate savings growth from start to this point
                const savingsGrowthToDate = saved - initialSavings;
                const savingsGrowthPercentToDate = initialSavings > 0 ? (savingsGrowthToDate / initialSavings) * 100 : 0;
                const savingsGrowthPrefix = savingsGrowthToDate >= 0 ? '+' : '';
                chartGrowth.textContent = `${savingsGrowthPrefix}${formatCurrency(savingsGrowthToDate)} (${savingsGrowthPrefix}${savingsGrowthPercentToDate.toFixed(1)}%)`;
                chartGrowth.className = 'chart-growth ' + (savingsGrowthToDate >= 0 ? 'positive' : 'negative');
                
                // Update spending row
                chartSpendingValue.textContent = formatCurrency(spent);
                chartSpendingSubtitle.textContent = `${dateLabel} â€¢ Total Spending`;
                
                // Calculate spending growth from start to this point
                const spendingGrowthToDate = spent - initialSpending;
                const spendingGrowthPercentToDate = initialSpending > 0 ? (spendingGrowthToDate / initialSpending) * 100 : 0;
                const spendingGrowthPrefix = spendingGrowthToDate >= 0 ? '+' : '';
                chartSpendingGrowth.textContent = `${spendingGrowthPrefix}${formatCurrency(spendingGrowthToDate)} (${spendingGrowthPrefix}${spendingGrowthPercentToDate.toFixed(1)}%)`;
                chartSpendingGrowth.className = 'chart-growth spending ' + (spendingGrowthToDate >= 0 ? 'positive' : 'negative');
            }

            /**
             * Resets chart header to show latest total values for both savings and spending.
             */
            function resetChartHeader() {
                if (!chartMainValue || !chartSubtitle || !chartGrowth || 
                    !chartSpendingValue || !chartSpendingSubtitle || !chartSpendingGrowth) return;
                
                // Update savings row with final values
                chartMainValue.textContent = formatCurrency(finalSavings);
                chartSubtitle.textContent = 'Total Savings';
                const savingsGrowthPrefix = savingsGrowth >= 0 ? '+' : '';
                chartGrowth.textContent = `${savingsGrowthPrefix}${formatCurrency(savingsGrowth)} (${savingsGrowthPrefix}${savingsGrowthPercent.toFixed(1)}%)`;
                chartGrowth.className = 'chart-growth ' + (savingsGrowth >= 0 ? 'positive' : 'negative');
                
                // Update spending row with final values
                chartSpendingValue.textContent = formatCurrency(finalSpending);
                chartSpendingSubtitle.textContent = 'Total Spending';
                const spendingGrowthPrefix = spendingGrowth >= 0 ? '+' : '';
                chartSpendingGrowth.textContent = `${spendingGrowthPrefix}${formatCurrency(spendingGrowth)} (${spendingGrowthPrefix}${spendingGrowthPercent.toFixed(1)}%)`;
                chartSpendingGrowth.className = 'chart-growth spending ' + (spendingGrowth >= 0 ? 'positive' : 'negative');
            }

            // Set default header
            resetChartHeader();

            // Destroy previous chart instance if it exists
            if (spendingChart) {
                // Clean up any existing interaction state
                hideChartInteraction();
                spendingChart.destroy();
            }
            
            // Create enhanced gradient for savings (Wealthsimple style)
            const savingsGradient = ctx.createLinearGradient(0, 0, 0, 400);
            savingsGradient.addColorStop(0, 'rgba(16, 185, 129, 0.25)'); // Green with transparency
            savingsGradient.addColorStop(0.6, 'rgba(16, 185, 129, 0.05)');
            savingsGradient.addColorStop(1, 'rgba(16, 185, 129, 0)');
            
            spendingChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total Savings',
                            data: savingsData,
                            borderColor: 'rgb(16, 185, 129)',
                            backgroundColor: savingsGradient,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 0,
                            borderWidth: 3,
                            z: 10,
                            pointHitRadius: 20,
                            pointBackgroundColor: 'transparent',
                            pointBorderColor: 'transparent',
                            pointBorderWidth: 0
                        },
                        {
                            label: 'Cumulative Spending',
                            data: spendingData,
                            borderColor: 'rgb(107, 114, 128)', // Gray
                            backgroundColor: 'transparent', // No fill
                            tension: 0.4,
                            fill: false, // No fill for spending
                            borderDash: [4, 4], // Dotted line
                            pointRadius: 0,
                            borderWidth: 2.5,
                            z: 5,
                            pointHitRadius: 15,
                            pointBackgroundColor: 'transparent',
                            pointBorderColor: 'transparent',
                            pointBorderWidth: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: {
                                display: false // Hide x-axis labels
                            },
                            border: { display: false }
                        },
                        y: {
                            grid: { display: false }, // Remove all horizontal grid lines
                            border: { display: false },
                            ticks: {
                                display: false // Hide y-axis labels
                            }
                        }
                    },
                    interaction: { intersect: false, mode: 'nearest' },
                    hover: { intersect: false, mode: 'nearest', enabled: false },
                    elements: {
                        point: {
                            hitRadius: 30,
                            hoverRadius: 0,
                            radius: 0,
                            hoverBackgroundColor: 'transparent',
                            hoverBorderColor: 'transparent',
                            hoverBorderWidth: 0
                        },
                        line: { tension: 0.4 }
                    }
                }
            });

            // --- INTERACTION: LONG PRESS THEN DRAG ---
            let interactionEnabled = false;
            let longPressTimeout = null;
            let lastActiveIndex = null;

            /**
             * Enables chart interaction and shows crosshair/tooltip at the given x position.
             * @param {number} x - The x coordinate relative to the chart canvas.
             */
            function enableChartInteraction(x) {
                interactionEnabled = true;
                const index = getNearestIndex(x);
                updateChartHeader(index);
                showChartInteraction(index);
                lastActiveIndex = index;
            }

            /**
             * Disables chart interaction and hides crosshair/tooltip.
             */
            function disableChartInteraction() {
                interactionEnabled = false;
                resetChartHeader();
                hideChartInteraction();
                lastActiveIndex = null;
            }

            const chartCanvas = ctx.canvas;

            // Remove all previous listeners (Chart.js re-creates canvas, so this is safe)
            chartCanvas.onmousedown = null;
            chartCanvas.onmousemove = null;
            chartCanvas.onmouseup = null;
            chartCanvas.onmouseleave = null;
            chartCanvas.onclick = null;
            chartCanvas.ontouchstart = null;
            chartCanvas.ontouchmove = null;
            chartCanvas.ontouchend = null;
            chartCanvas.ontouchcancel = null;

            // Mouse events: require 1-second long press before enabling drag
            chartCanvas.addEventListener('mousedown', function(e) {
                if (longPressTimeout) clearTimeout(longPressTimeout);
                longPressTimeout = setTimeout(() => {
                    const x = e.clientX - chartCanvas.getBoundingClientRect().left;
                    enableChartInteraction(x);
                }, 200); // 1 second long press required
            });
            chartCanvas.addEventListener('mousemove', function(e) {
                if (!interactionEnabled) return;
                const x = e.clientX - chartCanvas.getBoundingClientRect().left;
                const index = getNearestIndex(x);
                if (index !== lastActiveIndex) {
                    updateChartHeader(index);
                    showChartInteraction(index);
                    lastActiveIndex = index;
                }
            });
            chartCanvas.addEventListener('mouseup', function() {
                if (longPressTimeout) clearTimeout(longPressTimeout);
                if (interactionEnabled) disableChartInteraction();
            });
            chartCanvas.addEventListener('mouseleave', function() {
                if (longPressTimeout) clearTimeout(longPressTimeout);
                if (interactionEnabled) disableChartInteraction();
            });

            // Touch events: require 1-second long press before enabling drag
            // Use initial touch position to detect direction
            let initialTouchY = 0;
            let initialTouchX = 0;
            let touchDirection = null; // 'vertical' or 'horizontal'
            
            chartCanvas.addEventListener('touchstart', function(e) {
                if (longPressTimeout) clearTimeout(longPressTimeout);
                if (!e.touches || e.touches.length === 0) return;
                
                // Store initial touch position
                initialTouchX = e.touches[0].clientX;
                initialTouchY = e.touches[0].clientY;
                touchDirection = null; // Reset direction on new touch
                
                longPressTimeout = setTimeout(() => {
                    const x = e.touches[0].clientX - chartCanvas.getBoundingClientRect().left;
                    enableChartInteraction(x);
                }, 200); // 1 second long press required
            });
            
            chartCanvas.addEventListener('touchmove', function(e) {
                if (!e.touches || e.touches.length === 0) return;
                
                // If we haven't determined direction yet, do so based on movement
                if (touchDirection === null) {
                    const deltaX = Math.abs(e.touches[0].clientX - initialTouchX);
                    const deltaY = Math.abs(e.touches[0].clientY - initialTouchY);
                    
                    // If moving more vertically than horizontally, allow normal scroll
                    if (deltaY > deltaX && deltaY > 10) {
                        touchDirection = 'vertical';
                        if (longPressTimeout) clearTimeout(longPressTimeout);
                        return;
                    } else if (deltaX > 10) {
                        touchDirection = 'horizontal';
                    }
                }
                
                // If scrolling vertically, allow normal browser behavior
                if (touchDirection === 'vertical') return;
                
                // Only prevent default for horizontal movements when interaction is enabled
                if (interactionEnabled) {
                    e.preventDefault(); // Prevent scrolling when interacting with chart
                    const x = e.touches[0].clientX - chartCanvas.getBoundingClientRect().left;
                    const index = getNearestIndex(x);
                    if (index !== lastActiveIndex) {
                        updateChartHeader(index);
                        showChartInteraction(index);
                        // Enhanced haptic feedback - try multiple methods
                        // First try our utility
                        if (window.Haptics) {
                            window.Haptics.impact('medium');
                        }
                        // Also directly try Capacitor haptics
                        if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.Haptics) {
                            window.Capacitor.Plugins.Haptics.impact({style: 'medium'});
                        }
                        // For iOS, make sure we trigger a click-like event that can engage haptics
                        const el = document.activeElement || document.body;
                        el.dispatchEvent(new CustomEvent('haptic', {bubbles: true}));
                        lastActiveIndex = index;
                    }
                }
            }, { passive: false }); // Need to set passive: false to call preventDefault
            chartCanvas.addEventListener('touchend', function() {
                if (longPressTimeout) clearTimeout(longPressTimeout);
                if (interactionEnabled) disableChartInteraction();
            });
            chartCanvas.addEventListener('touchcancel', function() {
                if (longPressTimeout) clearTimeout(longPressTimeout);
                if (interactionEnabled) disableChartInteraction();
            });

            // Helper functions to show/hide chart interaction effects
            function showChartInteraction(activeIndex) {
                if (!spendingChart || !spendingChart.data || !spendingChart.data.datasets) return;
                
                // Show only the active point with hollow shapes
                spendingChart.data.datasets.forEach((dataset, datasetIndex) => {
                    // Reset all point properties to ensure clean state
                    dataset.pointRadius = new Array(dataset.data.length).fill(0);
                    dataset.pointBackgroundColor = new Array(dataset.data.length).fill('transparent');
                    dataset.pointBorderColor = new Array(dataset.data.length).fill('transparent');
                    dataset.pointBorderWidth = new Array(dataset.data.length).fill(0);
                    dataset.pointStyle = new Array(dataset.data.length).fill('circle');
                    dataset.pointHoverRadius = new Array(dataset.data.length).fill(0);
                    dataset.pointHoverBackgroundColor = new Array(dataset.data.length).fill('transparent');
                    dataset.pointHoverBorderColor = new Array(dataset.data.length).fill('transparent');
                    dataset.pointHoverBorderWidth = new Array(dataset.data.length).fill(0);
                    
                    // Show only the active point with hollow shape
                    if (activeIndex >= 0 && activeIndex < dataset.data.length) {
                        if (datasetIndex === 0) {
                            // Savings dataset - hollow green circle
                            dataset.pointRadius[activeIndex] = 8;
                            dataset.pointBackgroundColor[activeIndex] = '#fff';
                            dataset.pointBorderColor[activeIndex] = 'rgb(16, 185, 129)';
                            dataset.pointBorderWidth[activeIndex] = 3;
                            dataset.pointStyle[activeIndex] = 'circle';
                            // Also set hover properties for the active point
                            dataset.pointHoverRadius[activeIndex] = 8;
                            dataset.pointHoverBackgroundColor[activeIndex] = '#fff';
                            dataset.pointHoverBorderColor[activeIndex] = 'rgb(16, 185, 129)';
                            dataset.pointHoverBorderWidth[activeIndex] = 3;
                        } else {
                            // Spending dataset - hollow gray square
                            dataset.pointRadius[activeIndex] = 7;
                            dataset.pointBackgroundColor[activeIndex] = '#fff';
                            dataset.pointBorderColor[activeIndex] = 'rgb(107, 114, 128)';
                            dataset.pointBorderWidth[activeIndex] = 2.5;
                            dataset.pointStyle[activeIndex] = 'rect';
                            // Also set hover properties for the active point
                            dataset.pointHoverRadius[activeIndex] = 7;
                            dataset.pointHoverBackgroundColor[activeIndex] = '#fff';
                            dataset.pointHoverBorderColor[activeIndex] = 'rgb(107, 114, 128)';
                            dataset.pointHoverBorderWidth[activeIndex] = 2.5;
                        }
                    }
                    // Keep normal line width
                    dataset.borderWidth = datasetIndex === 0 ? 3 : 2.5;
                });
                
                // Show and position the vertical crosshair line
                const chartOverlay = document.getElementById('chartOverlay');
                const chartCrosshair = document.getElementById('chartCrosshair');
                
                if (chartOverlay && chartCrosshair) {
                    const xScale = spendingChart.scales.x;
                    const pixelX = xScale.getPixelForValue(activeIndex);
                    
                    // Position the crosshair at the selected point
                    chartCrosshair.style.left = `${pixelX}px`;
                    // Ensure overlay is visible immediately on interaction
                    chartOverlay.classList.add('visible');
                }
                
                spendingChart.update('none'); // Update without animation for immediate response
            }

            /**
             * Hides chart interaction effects (crosshair, tooltip) with a delay for better UX.
             */
            function hideChartInteraction() {
                if (!spendingChart || !spendingChart.data || !spendingChart.data.datasets) return;
                
                // Completely reset all data points to ensure no sticky dots
                spendingChart.data.datasets.forEach((dataset, datasetIndex) => {
                    // Reset all point properties to clean state
                    dataset.pointRadius = 0; // Hide all points
                    dataset.pointBackgroundColor = 'transparent';
                    dataset.pointBorderColor = 'transparent';
                    dataset.pointBorderWidth = 0;
                    dataset.borderWidth = datasetIndex === 0 ? 3 : 2.5; // Keep normal line width
                });
                
                // Hide the vertical crosshair line with a delay
                const chartOverlay = document.getElementById('chartOverlay');
                if (chartOverlay) {
                    setTimeout(() => {
                        chartOverlay.classList.remove('visible');
                    }, 200); // 200ms delay for smoother UX
                }
                spendingChart.update('none'); // Update without animation for immediate response
            }
        }
        
        // Global variables
        currentPeriodMode = 'month'; // or 'month'
        savingsAccounts = [
            { id: 'checking', name: 'Checking' },
            { id: 'savings', name: 'Savings' },
            { id: 'emergency', name: 'Emergency Fund' }
        ];
        
        function getCurrentPeriodKey() {
            if (currentPeriodMode === 'today') {
                return getCurrentDate();
            } else {
                return `${selectedMonthDate.getFullYear()}-${String(selectedMonthDate.getMonth() + 1).padStart(2, '0')}`;
            }
        }
        
        function getCurrentMonth() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        }
        
        function getSelectedSaveMonthKey() {
            return `${selectedSaveMonthDate.getFullYear()}-${String(selectedSaveMonthDate.getMonth() + 1).padStart(2, '0')}`;
        }
        
        function isCurrentMonth() {
            const now = new Date();
            return selectedMonthDate.getMonth() === now.getMonth() && 
                   selectedMonthDate.getFullYear() === now.getFullYear();
        }
        
        function loadExpenses() {
            const stored = localStorage.getItem(EXPENSES_KEY);
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    if (parsed && typeof parsed === 'object' && !Array.isArray(parsed)) {
                        return parsed;
                    }
                } catch (e) {
                    // Ignore parse errors and fall through to return empty object
                }
            }
            return {};
        }
        
        function initializeMonthPicker() {
            initializeDateDropdowns();
        }
        
        function initializeDateDropdowns() {
            const yearDropdown = document.getElementById('yearDropdown');
            if (!yearDropdown) return;
            
            yearDropdown.innerHTML = '';
            
            // Generate years (2 years back to current year)
            const currentYear = new Date().getFullYear();
            for (let year = currentYear - 2; year <= currentYear; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === selectedMonthDate.getFullYear()) {
                    option.selected = true;
                }
                yearDropdown.appendChild(option);
            }
            
            // Set month dropdown
            const monthDropdown = document.getElementById('monthDropdown');
            if (monthDropdown) {
                monthDropdown.value = selectedMonthDate.getMonth();
            }
            
            // Add event listeners
            yearDropdown.addEventListener('change', (e) => {
                selectedMonthDate.setFullYear(parseInt(e.target.value));
                updatePeriodView();
            });
            
            monthDropdown.addEventListener('change', (e) => {
                selectedMonthDate.setMonth(parseInt(e.target.value));
                updatePeriodView();
            });
        }
        
        function selectMonth(date) {
            selectedMonthDate = new Date(date);
            
            // Update dropdowns
            const monthDropdown = document.getElementById('monthDropdown');
            const yearDropdown = document.getElementById('yearDropdown');
            if (monthDropdown) monthDropdown.value = date.getMonth();
            if (yearDropdown) yearDropdown.value = date.getFullYear();
            
            setDefaultDatePicker();
            setDefaultBalanceDate();
            updatePeriodView();
        }
        
        function scrollToSelectedMonth() {
            // Not needed for compressed design
        }
        
        function updateAccountSelector() {
            const balanceAccountSelect = document.getElementById('balanceAccount');
            
            if (balanceAccountSelect) {
                balanceAccountSelect.innerHTML = '';
                
                // Add account options for balance input
                savingsAccounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.id;
                    option.textContent = account.name;
                    balanceAccountSelect.appendChild(option);
                });
            }
            
            // Also update slide-out dropdown
            updateSlideOutAccountDropdown();
            
            updateTotalSavingsDisplay();
        }
        
        function updateSlideOutAccountDropdown() {
            const balanceAccountContent = document.getElementById('balanceAccountContent');
            const slideOutBalanceAccount = document.getElementById('slideOutBalanceAccount');
            
            if (balanceAccountContent && slideOutBalanceAccount) {
                // Clear existing options
                balanceAccountContent.innerHTML = '';
                slideOutBalanceAccount.innerHTML = '';
                
                // Ensure we have at least one account
                if (savingsAccounts.length === 0) {
                    savingsAccounts = [
                        { id: 'checking', name: 'Checking' },
                        { id: 'savings', name: 'Savings' },
                        { id: 'emergency', name: 'Emergency Fund' }
                    ];
                    saveSavingsAccounts(savingsAccounts);
                }
                
                // Add account options
                savingsAccounts.forEach((account, index) => {
                    // Add to custom dropdown
                    const item = document.createElement('div');
                    item.className = 'select-item';
                    if (index === 0) item.classList.add('selected');
                    item.setAttribute('data-value', account.id);
                    item.textContent = account.name;
                    
                    // Add click handler
                    item.addEventListener('click', function() {
                        selectSlideOutOption('balanceAccount', account.id, account.name);
                    });
                    
                    balanceAccountContent.appendChild(item);
                    
                    // Add to hidden select
                    const option = document.createElement('option');
                    option.value = account.id;
                    option.textContent = account.name;
                    if (index === 0) option.selected = true;
                    slideOutBalanceAccount.appendChild(option);
                });
                
                // Update displayed value
                const balanceAccountValue = document.getElementById('balanceAccountValue');
                if (balanceAccountValue && savingsAccounts.length > 0) {
                    balanceAccountValue.textContent = savingsAccounts[0].name;
                }
            }
        }

        
        function updateTotalSavingsDisplay() {
            const balances = loadAccountBalances();
            const periodKey = getCurrentPeriodKey();
            let totalBalance = 0;
            let accountsWithBalances = 0;
            
            console.log('updateTotalSavingsDisplay - currentPeriodMode:', currentPeriodMode);
            console.log('updateTotalSavingsDisplay - periodKey:', periodKey);
            
            // Calculate total balance across all accounts for current period
            Object.keys(balances).forEach(accountId => {
                const accountBalances = balances[accountId] || {};
                let periodBalances;
                
                if (currentPeriodMode === 'today') {
                    // For today mode, look for exact date match
                    periodBalances = Object.keys(accountBalances)
                        .filter(date => date === periodKey)
                        .sort()
                        .reverse();
                } else {
                    // For month mode, look for dates starting with month key
                    periodBalances = Object.keys(accountBalances)
                        .filter(date => date.startsWith(periodKey))
                        .sort()
                        .reverse();
                }
                
                console.log(`Account ${accountId} - periodBalances:`, periodBalances);
                
                if (periodBalances.length > 0) {
                    const accountBalance = accountBalances[periodBalances[0]];
                    totalBalance += accountBalance;
                    accountsWithBalances++;
                    console.log(`Account ${accountId} - balance: $${accountBalance}`);
                }
            });
            
            console.log('Total balance calculated:', totalBalance);
            console.log('Accounts with balances:', accountsWithBalances);
            
            // Update total balance display
            const totalBalanceElement = document.getElementById('totalAccountBalance');
            if (totalBalanceElement) {
                totalBalanceElement.textContent = formatCurrency(totalBalance);
            }
            
            const changeElement = document.getElementById('totalBalanceChange');
            if (changeElement) {
                const periodText = currentPeriodMode === 'today' ? 'today' : 'this month';
                changeElement.textContent = `Total across ${accountsWithBalances} account${accountsWithBalances !== 1 ? 's' : ''} ${periodText}`;
            }
            
            // Update balance history
            updateBalanceHistory();
        }
        
        function updateBalanceHistory() {
            const balances = loadAccountBalances();
            const periodKey = getCurrentPeriodKey();
            const periodBalances = [];
            // Get all balances for the selected period
            Object.keys(balances).forEach(accountId => {
                const accountBalances = balances[accountId] || {};
                Object.keys(accountBalances).forEach(date => {
                    let shouldInclude = false;
                    if (currentPeriodMode === 'today') {
                        // For today mode, include exact date match only
                        shouldInclude = date === periodKey;
                    } else {
                        // For month mode, include dates starting with month key
                        shouldInclude = date.startsWith(periodKey);
                    }
                    if (shouldInclude) {
                        periodBalances.push({
                            date: date,
                            accountId: accountId,
                            accountName: savingsAccounts.find(acc => acc.id === accountId)?.name || accountId,
                            balance: accountBalances[date]
                        });
                    }
                });
            });
            const historyContainer = document.getElementById('balanceHistory');
            if (!historyContainer) return;
            if (periodBalances.length === 0) {
                const periodText = currentPeriodMode === 'today' ? 'today' : 'this month';
                historyContainer.innerHTML = `<div style="text-align: center; color: #7f8c8d; padding: 20px;">No balance records ${periodText}</div>`;
            } else {
                if (currentPeriodMode === 'month') {
                    // ... existing month view code ...
                    const grouped = {};
                    periodBalances.forEach(item => {
                        if (!grouped[item.accountId]) grouped[item.accountId] = [];
                        grouped[item.accountId].push(item);
                    });
                    historyContainer.innerHTML = Object.keys(grouped).map(accountId => {
                        const accountName = grouped[accountId][0].accountName;
                        const balancesList = grouped[accountId]
                            .sort((a, b) => {
                                // Sort by date (desc), then by created (asc) for stability
                                const dateA = a.date.split('-').map(Number);
                                const dateB = b.date.split('-').map(Number);
                                const dateObjA = new Date(dateA[0], dateA[1] - 1, dateA[2]);
                                const dateObjB = new Date(dateB[0], dateB[1] - 1, dateB[2]);
                                
                                if (dateObjA.getTime() !== dateObjB.getTime()) {
                                    return dateObjB - dateObjA; // latest date first
                                }
                                
                                // If same date, sort by created timestamp for stability
                                const createdA = a.created || new Date(a.date).getTime();
                                const createdB = b.created || new Date(b.date).getTime();
                                return createdA - createdB;
                            })
                            .map((item, idx, arr) => {
                                const dateParts = item.date.split('-').map(Number);
                                const dateObj = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
                                const formattedDate = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                // Calculate percent change vs previous entry in this month
                                let percentChange = null;
                                let arrow = '';
                                if (idx > 0) {
                                    const prev = arr[idx - 1];
                                    if (prev && prev.balance !== 0) {
                                        percentChange = ((item.balance - prev.balance) / prev.balance) * 100;
                                        if (percentChange > 0.01) {
                                            arrow = '<i data-lucide="arrow-up-right" class="balance-arrow positive"></i>';
                                        } else if (percentChange < -0.01) {
                                            arrow = '<i data-lucide="arrow-down-right" class="balance-arrow negative"></i>';
                                        } else {
                                            arrow = '<i data-lucide="arrow-right" class="balance-arrow neutral"></i>';
                                        }
                                    }
                                }
                                return `
                                    <div class="swipe-container" data-type="balance" data-account-id="${item.accountId}" data-date="${item.date}">
                                        <div class="swipe-content">
                                            <div class="modern-balance-history-item">
                                                <div class="balance-history-date">${formattedDate}</div>
                                                <div class="balance-history-right">
                                                    <div class="balance-history-amount">${formatCurrency(item.balance)}</div>
                                                    ${percentChange !== null ? `<div class="balance-history-percent ${percentChange > 0 ? 'positive' : percentChange < 0 ? 'negative' : 'neutral'}">${arrow}${percentChange > 0 ? '+' : ''}${percentChange.toFixed(2)}%</div>` : ''}
                                                </div>
                                                <button class="delete-balance-btn" onclick="handleBalanceDelete(this); return false;"><i data-lucide="x" class="w-4 h-4"></i></button>
                                            </div>
                                        </div>
                                        <div class="swipe-action" onclick="handleBalanceDelete(this); event.stopPropagation(); return false;"><i data-lucide="x" class="w-4 h-4"></i></div>
                                    </div>
                                `;
                            }).join('');
                        return `<div style="margin-bottom:1.5rem;"><div style="font-weight:600;font-size:1rem;margin-bottom:0.5rem;">${accountName}</div>${balancesList}</div>`;
                    }).join('');
                } else {
                    // Today view: only show today's records
                    historyContainer.innerHTML = periodBalances.map(item => {
                        const dateParts = item.date.split('-').map(Number);
                        const dateObj = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
                        const formattedDate = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        return `
                            <div class="swipe-container" data-type="balance" data-account-id="${item.accountId}" data-date="${item.date}">
                                <div class="swipe-content">
                                    <div class="balance-item">
                                        <div class="balance-details">
                                            <div class="balance-date">${formattedDate}</div>
                                            <div class="balance-account">${item.accountName}</div>
                                        </div>
                                        <div class="balance-amount">${formatCurrency(item.balance)}</div>
                                        <button class="delete-balance-btn" onclick="handleBalanceDelete(this); return false;"><i data-lucide="x" class="w-4 h-4"></i></button>
                                    </div>
                                </div>
                                <div class="swipe-action" onclick="handleBalanceDelete(this); event.stopPropagation(); return false;"><i data-lucide="x" class="w-4 h-4"></i></div>
                            </div>
                        `;
                    }).join('');
                }
            }
        }
        
        function addBalance() {
            const amount = parseFloat(document.getElementById('balanceAmount').value);
            const targetDate = document.getElementById('balanceDate').value;
            const selectedAccount = document.getElementById('balanceAccount').value;
            
            if (!amount || amount < 0) {
                alert('Please enter a valid balance amount');
                return;
            }
            
            if (!targetDate) {
                alert('Please select a date');
                return;
            }
            
            if (!selectedAccount) {
                alert('Please select an account');
                return;
            }
            
            const balances = loadAccountBalances();
            
            if (!balances[selectedAccount]) {
                balances[selectedAccount] = {};
            }
            
            balances[selectedAccount][targetDate] = amount;
            saveAccountBalances(balances);
            
            // Clear form
            document.getElementById('balanceAmount').value = '';
            
            updateTotalSavingsDisplay();
            
            // Update chart if on reports screen
            if (currentScreen === 1) {
                updateChart();
            }
        }
        
        function deleteBalance(accountId, date) {
            console.log('Deleting balance:', accountId, date);
            const balances = loadAccountBalances();
            
            if (balances[accountId] && balances[accountId][date]) {
                // Find the swipe container that holds this balance
                const swipeContainer = document.querySelector(`.swipe-container[data-type="balance"][data-account-id="${accountId}"][data-date="${date}"]`);
                
                if (swipeContainer) {
                    // Save accordion state before deletion
                    const accordionId = `accordion-body-${accountId}`;
                    const accordionBody = document.getElementById(accordionId);
                    const wasExpanded = accordionBody ? accordionBody.classList.contains('expanded') : false;
                    
                    // Add deleting animation
                    swipeContainer.classList.add('deleting');
                    console.log('Adding deleting animation to container:', swipeContainer);
                    
                    // Wait for animation to complete before removing from storage
                    setTimeout(() => {
                        // Delete the balance entry
                        delete balances[accountId][date];
                        saveAccountBalances(balances);
                        updateTotalSavingsDisplay();
                        
                        // Update screens based on current view
                        if (document.getElementById('saveBalanceHistory')) {
                            updateSaveScreen();
                            
                            // Restore accordion state after update
                            setTimeout(() => {
                                const newAccordionBody = document.getElementById(accordionId);
                                if (newAccordionBody && wasExpanded && !newAccordionBody.classList.contains('expanded')) {
                                    toggleAccountAccordion(accountId);
                                }
                            }, 10);
                        } else {
                            updateBalanceHistory();
                        }
                        
                        // Update chart if on reports screen
                        if (currentScreen === 2) {
                            updateChart();
                        }
                    }, 300); // Match the CSS animation duration
                } else {
                    console.log('No swipe container found, deleting immediately');
                    // No swipe container found, just delete immediately
                    delete balances[accountId][date];
                    saveAccountBalances(balances);
                    updateTotalSavingsDisplay();
                    
                    // Update screens based on current view
                    if (document.getElementById('saveBalanceHistory')) {
                        updateSaveScreen();
                    } else {
                        updateBalanceHistory();
                    }
                    
                    // Update chart if on reports screen
                    if (currentScreen === 2) {
                        updateChart();
                    }
                }
            }
        }
        
        function showAccountManagementModal() {
            showAccountManagementSlideOut();
        }
        
        function showAccountManagementSlideOut() {
            document.getElementById('accountManagementSlideOut').classList.add('active');
            updateAccountManagementList();
        }
        
        function hideAccountManagementSlideOut() {
            document.getElementById('accountManagementSlideOut').classList.remove('active');
        }
        
        function hideAccountManagementModal() {
            hideAccountManagementSlideOut();
        }
        
        function updateAccountList() {
            updateAccountManagementList();
        }
        
        function updateAccountManagementList() {
            const listContainer = document.getElementById('accountManagementList');
            if (!listContainer) return;
            
            listContainer.innerHTML = savingsAccounts.map(account => `
                <div class="account-management-list-item">
                    <span class="account-management-name">${account.name}</span>
                    ${savingsAccounts.length > 1 ? `<button class="account-management-delete-btn" onclick="deleteAccountFromSlideOut('${account.id}')">Delete</button>` : ''}
                </div>
            `).join('');
        }
        
        function addNewAccount() {
            addNewAccountFromSlideOut();
        }
        
        function addNewAccountFromSlideOut() {
            const name = document.getElementById('newAccountNameSlideOut').value.trim();
            
            if (!name) {
                alert('Please enter an account name');
                return;
            }
            
            const id = name.toLowerCase().replace(/\s+/g, '-');
            
            if (savingsAccounts.find(acc => acc.id === id)) {
                alert('Account with this name already exists');
                return;
            }
            
            savingsAccounts.push({
                id: id,
                name: name,
                type: 'custom'
            });
            
            saveSavingsAccounts(savingsAccounts);
            document.getElementById('newAccountNameSlideOut').value = '';
            updateAccountManagementList();
            updateAccountSelector();
            updateSlideOutAccountDropdown();
        }
        
        function deleteAccount(accountId) {
            deleteAccountFromSlideOut(accountId);
        }
        
        function deleteAccountFromSlideOut(accountId) {
            if (savingsAccounts.length <= 1) {
                alert('You must have at least one account');
                return;
            }
            
            if (confirm('Are you sure you want to delete this account? All balance history will be lost.')) {
                // Remove from accounts
                savingsAccounts = savingsAccounts.filter(acc => acc.id !== accountId);
                saveSavingsAccounts(savingsAccounts);
                
                // Remove all balances for this account
                const balances = loadAccountBalances();
                delete balances[accountId];
                saveAccountBalances(balances);
                
                updateAccountManagementList();
                updateAccountSelector();
                updateSlideOutAccountDropdown();
            }
        }
        
        function setDefaultBalanceDate() {
            const dateInput = document.getElementById('balanceDate');
            if (dateInput) {
                const today = new Date();
                if (isCurrentMonth()) {
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    dateInput.value = `${year}-${month}-${day}`;
                } else {
                    const firstDay = new Date(selectedMonthDate.getFullYear(), selectedMonthDate.getMonth(), 1);
                    const year = firstDay.getFullYear();
                    const month = String(firstDay.getMonth() + 1).padStart(2, '0');
                    const day = String(firstDay.getDate()).padStart(2, '0');
                    dateInput.value = `${year}-${month}-${day}`;
                }
            }
        }
        
        function setDefaultDatePicker() {
            // For custom datepickers, set default date when in month mode
            if (currentPeriodMode === 'month') {
                const datepickerId = 'expenseCustomDatepicker';
                const state = datepickerStates[datepickerId];
                
                if (state) {
                    if (isCurrentMonth()) {
                        selectToday(datepickerId);
                    } else {
                        // Set to first day of selected month
                        const firstDay = new Date(selectedMonthDate.getFullYear(), selectedMonthDate.getMonth(), 1);
                        state.selectedDate = firstDay;
                        state.currentMonth = firstDay.getMonth();
                        state.currentYear = firstDay.getFullYear();
                        updateDatepickerValue(datepickerId);
                    }
                }
            }
        }
        
        // Period management functions
        function setPeriodMode(mode) {
            currentPeriodMode = mode;
            
            // Update compact button states
            const todayBtn = document.getElementById('todayBtnCompact');
            const monthBtn = document.getElementById('monthBtnCompact');
            if (todayBtn) todayBtn.classList.toggle('active', mode === 'today');
            if (monthBtn) monthBtn.classList.toggle('active', mode === 'month');
            
            // Update icon-only button states
            const todayBtnIcon = document.getElementById('todayBtnIcon');
            const monthBtnIcon = document.getElementById('monthBtnIcon');
            if (todayBtnIcon) todayBtnIcon.classList.toggle('active', mode === 'today');
            if (monthBtnIcon) monthBtnIcon.classList.toggle('active', mode === 'month');
            
            // Add/remove today-view class for styling
            const screen = document.querySelector('.screen');
            if (screen) {
                screen.classList.toggle('today-view', mode === 'today');
            }
            
            // Show/hide dropdowns
            const periodDropdowns = document.getElementById('periodDropdowns');
            if (periodDropdowns) {
                periodDropdowns.style.display = mode === 'month' ? 'flex' : 'none';
            }
            
            // Show/hide date picker in slide-out
            const slideOutDateGroup = document.getElementById('slideOutDatePickerGroup');
            if (slideOutDateGroup) {
                slideOutDateGroup.style.display = mode === 'month' ? 'block' : 'none';
            }
            
            // Show savings section in both modes
            // const savingsSection = document.getElementById('savingsSection');
            // if (savingsSection) {
            //     savingsSection.style.display = 'block';
            // }
            
            // Show balance action button in both modes
            const balanceActionBtn = document.getElementById('balanceActionBtn');
            if (balanceActionBtn) {
                balanceActionBtn.style.display = 'inline-flex';
            }
            
            if (mode === 'month') {
                // Initialize month/year dropdowns to current values
                updatePeriodDropdownValues();
                setupPeriodDropdownEventListeners();
                setDefaultDatePicker();
                setDefaultBalanceDate();
            }
            
            updatePeriodView();
            updateBalanceHistory();
        }
        
        function updatePeriodDropdownValues() {
            const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
            const btnText = document.getElementById('monthYearSelectorText');
            if (btnText) {
                btnText.textContent = `${monthNames[selectedMonthDate.getMonth()]} ${selectedMonthDate.getFullYear()}`;
            }
            // Also update the card title if needed (legacy support)
            const budgetPeriodLabel = document.getElementById('budgetPeriodLabel');
            if (budgetPeriodLabel) {
                budgetPeriodLabel.textContent = `${monthNames[selectedMonthDate.getMonth()]} ${selectedMonthDate.getFullYear()}`;
            }
        }
        
        // Slide-out functions
        function showExpenseSlideOut() {
            const overlay = document.getElementById('expenseSlideOut');
            overlay.classList.add('active');
            // Update date picker visibility in slide-out
            const slideOutDateGroup = document.getElementById('slideOutDatePickerGroup');
            if (slideOutDateGroup) {
                slideOutDateGroup.style.display = currentPeriodMode === 'month' ? 'block' : 'none';
            }
            // Initialize and set default date for custom datepicker if in month mode
            if (currentPeriodMode === 'month') {
                const datepickerId = 'expenseCustomDatepicker';
                if (!datepickerStates[datepickerId]) {
                    initializeDatepicker(datepickerId);
                }
                const now = new Date();
                let defaultDate;
                if (
                    selectedMonthDate.getFullYear() === now.getFullYear() &&
                    selectedMonthDate.getMonth() === now.getMonth()
                ) {
                    defaultDate = now;
                } else {
                    defaultDate = new Date(selectedMonthDate.getFullYear(), selectedMonthDate.getMonth(), 1);
                }
                const state = datepickerStates[datepickerId];
                state.selectedDate = defaultDate;
                state.currentMonth = defaultDate.getMonth();
                state.currentYear = defaultDate.getFullYear();
                updateDatepickerValue(datepickerId);
                renderCalendar(datepickerId);
            }
        }
        
        function showBalanceSlideOut() {
            const overlay = document.getElementById('balanceSlideOut');
            overlay.classList.add('active');
            // Initialize datepicker if not already done
            const datepickerId = 'balanceCustomDatepicker';
            if (!datepickerStates[datepickerId]) {
                initializeDatepicker(datepickerId);
            }
            // Set default date to today
            const now = new Date();
            const state = datepickerStates[datepickerId];
            state.selectedDate = now;
            state.currentMonth = now.getMonth();
            state.currentYear = now.getFullYear();
            updateDatepickerValue(datepickerId);
            renderCalendar(datepickerId);
            
            // Update account dropdown
            updateSlideOutAccountDropdown();
            
            // Pre-fill with last balance for default account
            const defaultAccountId = getDefaultAccountId();
            if (defaultAccountId) {
                const lastBalance = getLastBalanceForAccount(defaultAccountId);
                const balanceAmountInput = document.getElementById('slideOutBalanceAmount');
                if (balanceAmountInput && lastBalance > 0) {
                    balanceAmountInput.value = lastBalance.toFixed(2);
                }
            }
        }
        
        function hideExpenseSlideOut() {
            const overlay = document.getElementById('expenseSlideOut');
            overlay.classList.remove('active');
        }
        
        function hideBalanceSlideOut() {
            const overlay = document.getElementById('balanceSlideOut');
            overlay.classList.remove('active');
        }
        
        // Custom Datepicker Functions
        let datepickerStates = {};
        
        function initializeDatepicker(datepickerId) {
            if (!datepickerStates[datepickerId]) {
                datepickerStates[datepickerId] = {
                    currentMonth: new Date().getMonth(),
                    currentYear: new Date().getFullYear(),
                    selectedDate: null,
                    isOpen: false
                };
            }
            
            // Set default to today
            selectToday(datepickerId);
            renderCalendar(datepickerId);
        }
        
        function toggleDatepicker(datepickerId) {
            const popup = document.getElementById(datepickerId + 'Popup');
            const trigger = document.querySelector(`#${datepickerId} .datepicker-trigger`);
            const state = datepickerStates[datepickerId];
            
            if (!state) {
                initializeDatepicker(datepickerId);
                return;
            }
            
            // Close all other datepickers
            Object.keys(datepickerStates).forEach(id => {
                if (id !== datepickerId) {
                    const otherPopup = document.getElementById(id + 'Popup');
                    const otherTrigger = document.querySelector(`#${id} .datepicker-trigger`);
                    if (otherPopup) {
                        otherPopup.style.display = 'none';
                        datepickerStates[id].isOpen = false;
                    }
                    if (otherTrigger) {
                        otherTrigger.setAttribute('aria-expanded', 'false');
                    }
                }
            });
            
            if (state.isOpen) {
                popup.style.display = 'none';
                state.isOpen = false;
                if (trigger) {
                    trigger.setAttribute('aria-expanded', 'false');
                }
            } else {
                renderCalendar(datepickerId);
                popup.style.display = 'block';
                state.isOpen = true;
                if (trigger) {
                    trigger.setAttribute('aria-expanded', 'true');
                }
            }
        }
        
        function renderCalendar(datepickerId) {
            const state = datepickerStates[datepickerId];
            if (!state) return;
            
            const monthYearElement = document.getElementById(datepickerId + 'MonthYear');
            const gridElement = document.getElementById(datepickerId + 'Grid');
            
            // Update month/year display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            monthYearElement.textContent = `${monthNames[state.currentMonth]} ${state.currentYear}`;
            
            // Clear existing grid
            gridElement.innerHTML = '';
            
            // Add day headers
            const dayHeaders = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'datepicker-day-header';
                dayHeader.textContent = day;
                gridElement.appendChild(dayHeader);
            });
            
            // Get first day of month and number of days
            const firstDay = new Date(state.currentYear, state.currentMonth, 1);
            const lastDay = new Date(state.currentYear, state.currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            // Add empty cells for days before first day of month
            for (let i = 0; i < startingDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'datepicker-day datepicker-day-empty';
                gridElement.appendChild(emptyCell);
            }
            
            // Add days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'datepicker-day';
                dayElement.textContent = day;
                
                // Highlight selected date
                if (
                    state.selectedDate &&
                    state.selectedDate.getDate() === day &&
                    state.selectedDate.getMonth() === state.currentMonth &&
                    state.selectedDate.getFullYear() === state.currentYear
                ) {
                    dayElement.classList.add('selected');
                }
                
                // Check if this day is today
                const today = new Date();
                if (
                    today.getDate() === day &&
                    today.getMonth() === state.currentMonth &&
                    today.getFullYear() === state.currentYear
                ) {
                    dayElement.classList.add('datepicker-day-today');
                }
                
                dayElement.addEventListener('click', () => selectDate(datepickerId, day));
                gridElement.appendChild(dayElement);
            }
        }
        
        function selectDate(datepickerId, day) {
            const state = datepickerStates[datepickerId];
            if (!state) return;
            
            state.selectedDate = new Date(state.currentYear, state.currentMonth, day);
            updateDatepickerValue(datepickerId);
            closeDatepicker(datepickerId);
        }
        
        function updateDatepickerValue(datepickerId) {
            const state = datepickerStates[datepickerId];
            if (!state || !state.selectedDate) return;
            
            const valueElement = document.getElementById(datepickerId + 'Value');
            
            // More robust hidden input identification
            let hiddenInput;
            if (datepickerId.includes('expense')) {
                hiddenInput = document.getElementById('slideOutExpenseDate');
            } else if (datepickerId.includes('balance')) {
                hiddenInput = document.getElementById('slideOutBalanceDate');
            }
            
            // Create a new date to avoid timezone issues
            const selectedDate = new Date(state.selectedDate);
            
            // Format date as readable string for display (using local timezone)
            const displayDate = selectedDate.toLocaleDateString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            
            // Format date as YYYY-MM-DD for form submission (avoid timezone offset)
            const year = selectedDate.getFullYear();
            const month = String(selectedDate.getMonth() + 1).padStart(2, '0');
            const day = String(selectedDate.getDate()).padStart(2, '0');
            const formattedDate = `${year}-${month}-${day}`;
            
            if (valueElement) {
                valueElement.textContent = displayDate;
            }
            if (hiddenInput) {
                hiddenInput.value = formattedDate;
            }
        }
        
        function closeDatepicker(datepickerId) {
            const popup = document.getElementById(datepickerId + 'Popup');
            const trigger = document.querySelector(`#${datepickerId} .datepicker-trigger`);
            const state = datepickerStates[datepickerId];
            
            if (popup) {
                popup.style.display = 'none';
            }
            if (state) {
                state.isOpen = false;
            }
            if (trigger) {
                trigger.setAttribute('aria-expanded', 'false');
            }
        }
        
        function navigateMonth(datepickerId, direction) {
            const state = datepickerStates[datepickerId];
            if (!state) return;
            
            state.currentMonth += direction;
            
            if (state.currentMonth < 0) {
                state.currentMonth = 11;
                state.currentYear--;
            } else if (state.currentMonth > 11) {
                state.currentMonth = 0;
                state.currentYear++;
            }
            
            renderCalendar(datepickerId);
        }
        
        function selectToday(datepickerId) {
            const state = datepickerStates[datepickerId];
            if (!state) {
                initializeDatepicker(datepickerId);
                return;
            }
            
            const today = new Date();
            state.selectedDate = today;
            state.currentMonth = today.getMonth();
            state.currentYear = today.getFullYear();
            
            updateDatepickerValue(datepickerId);
            if (state.isOpen) {
                renderCalendar(datepickerId);
            }
        }
        
        function clearDate(datepickerId) {
            const state = datepickerStates[datepickerId];
            if (!state) return;
            
            state.selectedDate = null;
            
            const valueElement = document.getElementById(datepickerId + 'Value');
            
            // More robust hidden input identification
            let hiddenInput;
            if (datepickerId.includes('expense')) {
                hiddenInput = document.getElementById('slideOutExpenseDate');
            } else if (datepickerId.includes('balance')) {
                hiddenInput = document.getElementById('slideOutBalanceDate');
            }
            
            if (valueElement) {
                valueElement.textContent = 'Select date';
            }
            if (hiddenInput) {
                hiddenInput.value = '';
            }
            
            closeDatepicker(datepickerId);
        }
        
        // Close datepickers when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.custom-datepicker')) {
                Object.keys(datepickerStates).forEach(datepickerId => {
                    closeDatepicker(datepickerId);
                });
            }
        });
        
        // Add keyboard support for datepickers
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // Close all open datepickers
                Object.keys(datepickerStates).forEach(datepickerId => {
                    closeDatepicker(datepickerId);
                });
            }
        });
        
        // Initialize datepickers when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Migrate old expense data if it exists
            const oldExpenses = localStorage.getItem('expenses');
            const newExpenses = localStorage.getItem('dailyExpenses');
            if (oldExpenses && !newExpenses) {
                localStorage.setItem('dailyExpenses', oldExpenses);
                console.log('Migrated expense data from old storage key');
            }
            
            // Initialize datepickers
            initializeDatepicker('expenseCustomDatepicker');
            initializeDatepicker('balanceCustomDatepicker');
            
            // Initialize savings accounts
            initializeSavingsAccounts();
            
            // Initialize dropdown event listeners
            setupDropdownEventListeners();
            setupPeriodDropdownEventListeners();
            
            // Initialize click-outside-to-close functionality for slide-out menus
            initializeSlideOutClickOutside();
            
            // Initialize period mode
            setPeriodMode('month');
            
            // Set chart period to ALL by default to show all balance data
            currentChartPeriod = 'ALL';
            
            // Initialize slide-out account dropdown
            updateSlideOutAccountDropdown();
            
            // Force initialize Lucide icons with multiple attempts
            function initializeLucideIcons() {
                if (typeof lucide !== 'undefined') {
                    try {
                        lucide.createIcons();
                        console.log('Lucide icons initialized successfully');
                    } catch (error) {
                        console.error('Error initializing Lucide icons:', error);
                    }
                } else {
                    console.warn('Lucide not loaded yet, retrying...');
                }
            }
            
            // Try immediately
            initializeLucideIcons();
            
            // Try again after short delays
            setTimeout(initializeLucideIcons, 100);
            setTimeout(initializeLucideIcons, 500);
            setTimeout(initializeLucideIcons, 1000);
            
            // Update current date display
            updateCurrentDateDisplay();
            
            // Initial update of displays
            updatePeriodView();
            updateSaveScreen(); // Initialize save screen
            
            // Initialize the chart with empty data
            if (document.getElementById('spendingChart')) {
                // Set default period
                currentChartPeriod = 'YTD';
                document.querySelectorAll('.chart-period-btn-wealthsimple').forEach(btn => {
                    btn.classList.toggle('active', btn.id === 'periodYTD');
                });
            }
            
            // Set initial today-view class
            const screen = document.querySelector('.screen');
            if (screen) {
                screen.classList.add('today-view');
            }
            
            // Add test data button for development/testing
            // addTestDataButton();
        });
        
        function setupDropdownEventListeners() {
            // Setup expense category dropdown
            const expenseCategoryItems = document.querySelectorAll('#expenseCategoryContent .select-item');
            expenseCategoryItems.forEach(item => {
                item.addEventListener('click', function() {
                    const value = this.getAttribute('data-value');
                    const text = this.textContent;
                    selectSlideOutOption('expenseCategory', value, text);
                });
            });
            
            // Balance account dropdown will be set up when accounts are loaded
        }
        
        function setupPeriodDropdownEventListeners() {
            // Setup month selector
            const monthSelectItems = document.querySelectorAll('#monthSelectContent .period-select-item');
            monthSelectItems.forEach(item => {
                item.addEventListener('click', function() {
                    const monthIndex = parseInt(this.getAttribute('data-value'));
                    selectedMonthDate.setMonth(monthIndex);
                    
                    // Update display
                    document.getElementById('monthSelectValue').textContent = this.textContent;
                    
                    // Update selected state
                    document.querySelectorAll('#monthSelectContent .period-select-item').forEach(i => {
                        i.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    
                    // Close dropdown
                    document.getElementById('monthSelectContent').classList.remove('open');
                    document.getElementById('monthSelectTrigger').removeAttribute('aria-expanded');
                    
                    updatePeriodView();
                });
            });
            
            // Setup year selector
            const yearSelectItems = document.querySelectorAll('#yearSelectContent .period-select-item');
            yearSelectItems.forEach(item => {
                item.addEventListener('click', function() {
                    const year = parseInt(this.getAttribute('data-value'));
                    selectedMonthDate.setFullYear(year);
                    
                    // Update display
                    document.getElementById('yearSelectValue').textContent = this.textContent;
                    
                    // Update selected state
                    document.querySelectorAll('#yearSelectContent .period-select-item').forEach(i => {
                        i.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    
                    // Close dropdown
                    document.getElementById('yearSelectContent').classList.remove('open');
                    document.getElementById('yearSelectTrigger').removeAttribute('aria-expanded');
                    
                    updatePeriodView();
                });
            });
        }
        
        function updateCurrentDateDisplay() {
            const dateElement = document.getElementById('currentDate');
            if (dateElement) {
                const now = new Date();
                const options = { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                };
                dateElement.textContent = now.toLocaleDateString('en-US', options);
            }
        }
        
        function addExpenseFromSlideOut() {
            const amount = parseFloat(document.getElementById('slideOutExpenseAmount').value);
            const category = document.getElementById('slideOutExpenseCategory').value;
            const description = document.getElementById('slideOutExpenseDescription').value;
            
            let targetDate;
            if (currentPeriodMode === 'month') {
                targetDate = document.getElementById('slideOutExpenseDate').value;
                if (!targetDate) {
                    alert('Please select a date');
                    return;
                }
            } else {
                targetDate = getCurrentDate();
            }
            
            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            if (!category) {
                alert('Please select a category');
                return;
            }
            
            const expenses = loadExpenses();
            
            if (!expenses[targetDate]) {
                expenses[targetDate] = [];
            }
            
            const now = Date.now();
            const newExpense = {
                amount: amount,
                category: category,
                description: description || '',
                timestamp: now, // legacy
                created: now,
                updated: now
            };
            
            expenses[targetDate].push(newExpense);
            
            saveExpenses(expenses);
            
            // Clear form
            document.getElementById('slideOutExpenseAmount').value = '';
            document.getElementById('slideOutExpenseDescription').value = '';
            
            // Reset category to default using the dropdown function
            selectSlideOutOption('expenseCategory', 'groceries', 'Groceries');
            
            // Clear custom datepicker
            if (currentPeriodMode === 'month') {
                clearDate('expenseCustomDatepicker');
            }
            
            // Close slide-out
            hideExpenseSlideOut();
            
            // Update display
            updatePeriodView();
            updateChart();
            console.log('Expense added:', newExpense);
        }
        
        function addBalanceFromSlideOut() {
            const amount = parseFloat(document.getElementById('slideOutBalanceAmount').value);
            const targetDate = document.getElementById('slideOutBalanceDate').value;
            const selectedAccount = document.getElementById('slideOutBalanceAccount').value;
            
            if (!amount || amount < 0) {
                alert('Please enter a valid balance amount');
                return;
            }
            
            if (!targetDate) {
                alert('Please select a date');
                return;
            }
            
            if (!selectedAccount) {
                alert('Please select an account');
                return;
            }
            
            const balances = loadAccountBalances();
            
            if (!balances[selectedAccount]) {
                balances[selectedAccount] = {};
            }
            
            if (!balances[selectedAccount][targetDate]) {
                balances[selectedAccount][targetDate] = {
                    amount: amount,
                    created: Date.now(),
                    updated: Date.now()
                };
            } else {
                // If already exists, treat as update
                const old = balances[selectedAccount][targetDate];
                balances[selectedAccount][targetDate] = {
                    amount: amount,
                    created: old.created || Date.now(),
                    updated: Date.now()
                };
            }
            
            saveAccountBalances(balances);
            
            // Clear form
            document.getElementById('slideOutBalanceAmount').value = '';
            clearDate('balanceCustomDatepicker');
            
            // Close slide-out
            hideBalanceSlideOut();
            
            // Update display
            updateTotalSavingsDisplay();
            updateSaveScreen(); // Update save screen when balance is added
            updateChart();
        }
        
        function togglePeriodSelect(selectType) {
            const content = document.getElementById(selectType + 'SelectContent');
            const trigger = document.getElementById(selectType + 'SelectTrigger');
            const isOpen = content.classList.contains('open');
            
            // Close all other period dropdowns
            document.querySelectorAll('.period-select-content').forEach(dropdown => {
                dropdown.classList.remove('open');
            });
            document.querySelectorAll('.period-select-trigger').forEach(triggerEl => {
                triggerEl.removeAttribute('aria-expanded');
            });
            
            // Toggle current dropdown
            if (!isOpen) {
                content.classList.add('open');
                trigger.setAttribute('aria-expanded', 'true');
            }
        }
        
        function toggleSlideOutSelect(selectType) {
            const content = document.getElementById(selectType + 'Content');
            const trigger = document.getElementById(selectType + 'Trigger');
            const isOpen = content.classList.contains('open');
            
            // Close all other dropdowns
            document.querySelectorAll('.select-content').forEach(dropdown => {
                dropdown.classList.remove('open');
            });
            document.querySelectorAll('.select-trigger').forEach(triggerEl => {
                triggerEl.removeAttribute('aria-expanded');
            });
            
            // Toggle current dropdown
            if (!isOpen) {
                content.classList.add('open');
                trigger.setAttribute('aria-expanded', 'true');
            }
        }
        
        function selectSlideOutOption(selectType, value, text) {
            const trigger = document.getElementById(selectType + 'Trigger');
            const valueSpan = document.getElementById(selectType + 'Value');
            const content = document.getElementById(selectType + 'Content');
            const hiddenSelect = document.getElementById('slideOut' + selectType.charAt(0).toUpperCase() + selectType.slice(1));
            
            // Handle month/year slideout selections
            if (selectType === 'monthSelect') {
                tempSelectedMonth = parseInt(value);
                const monthInput = document.getElementById('monthInput');
                if (monthInput) {
                    monthInput.value = value;
                }
            } else if (selectType === 'monthYear') {
                tempSelectedYear = parseInt(value);
                const yearInput = document.getElementById('yearInput');
                if (yearInput) {
                    yearInput.value = value;
                }
            } else if (selectType === 'balanceAccount') {
                // Prepopulate balance amount with last balance for selected account
                const lastBalance = getLastBalanceForAccount(value);
                const balanceAmountInput = document.getElementById('slideOutBalanceAmount');
                if (balanceAmountInput && lastBalance > 0) {
                    balanceAmountInput.value = lastBalance.toFixed(2);
                }
            } else if (selectType === 'budgetProvince') {
                // Handle budget province selection
                const provinceValue = document.getElementById('budgetProvinceValue');
                if (provinceValue) {
                    provinceValue.textContent = text;
                }
            }
            
            // Update display
            if (valueSpan) {
                valueSpan.textContent = text;
            }
            
            // Update hidden select
            if (hiddenSelect) {
                hiddenSelect.value = value;
            }
            
            // Update selected state
            content.querySelectorAll('.select-item').forEach(item => {
                item.classList.remove('selected');
            });
            const selectedItem = content.querySelector(`[data-value="${value}"]`);
            if (selectedItem) {
                selectedItem.classList.add('selected');
            }
            
            // Close dropdown
            content.classList.remove('open');
            trigger.removeAttribute('aria-expanded');
        }
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.select-container')) {
                document.querySelectorAll('.select-content').forEach(dropdown => {
                    dropdown.classList.remove('open');
                });
                document.querySelectorAll('.select-trigger').forEach(trigger => {
                    trigger.removeAttribute('aria-expanded');
                });
            }
            
            if (!e.target.closest('.period-select-container')) {
                document.querySelectorAll('.period-select-content').forEach(dropdown => {
                    dropdown.classList.remove('open');
                });
                document.querySelectorAll('.period-select-trigger').forEach(trigger => {
                    trigger.removeAttribute('aria-expanded');
                });
            }
        });
        

        /**
         * Loads savings accounts from localStorage or sets defaults if not present.
         */
        function initializeSavingsAccounts() {
            const stored = localStorage.getItem('savingsAccounts');
            if (stored) {
                try {
                    savingsAccounts = JSON.parse(stored);
                    // Validate loaded data is an array of objects with id and name
                    if (!Array.isArray(savingsAccounts) || !savingsAccounts.every(acc => acc && typeof acc.id === 'string' && typeof acc.name === 'string')) {
                        throw new Error('Invalid savingsAccounts data');
                    }
                } catch (e) {
                    // If parsing fails, fall back to defaults
                    savingsAccounts = [
                        { id: 'checking', name: 'Checking' },
                        { id: 'savings', name: 'Savings' },
                        { id: 'emergency', name: 'Emergency Fund' }
                    ];
                }
            } else {
                savingsAccounts = [
                    { id: 'checking', name: 'Checking' },
                    { id: 'savings', name: 'Savings' },
                    { id: 'emergency', name: 'Emergency Fund' }
                ];
            }
        }

        /**
         * Saves the current savingsAccounts array to localStorage.
         * @param {Array<{id: string, name: string}>} accounts
         */
        function saveSavingsAccounts(accounts) {
            if (!Array.isArray(accounts)) return;
            localStorage.setItem('savingsAccounts', JSON.stringify(accounts));
        }

        /**
         * Saves the expenses object to localStorage.
         * @param {Record<string, Array<{amount: number, category: string, description: string, timestamp: number}>>} expenses
         */
        function saveExpenses(expenses) {
            if (!expenses || typeof expenses !== 'object' || Array.isArray(expenses)) {
                console.error('Invalid expenses object:', expenses);
                return;
            }
            
            console.log('Saving expenses to localStorage');
            try {
                localStorage.setItem(EXPENSES_KEY, JSON.stringify(expenses));
                
                // Verify what was saved
                setTimeout(() => {
                    const savedData = localStorage.getItem(EXPENSES_KEY);
                    console.log('Verified localStorage after save - item exists:', !!savedData);
                    
                    // Check if the specific expense was removed
                    try {
                        const parsedData = JSON.parse(savedData);
                        console.log('Parsed saved data has keys:', Object.keys(parsedData));
                    } catch (e) {
                        console.error('Could not parse saved data');
                    }
                }, 10);
            } catch (error) {
                console.error('Error saving expenses to localStorage:', error);
            }
        }

        // Remove old period-date-dropdowns from sticky selector
        // Remove all code related to old dropdowns and their event listeners
        // Add new month/year slide-out logic
        function showMonthYearSlideOut() {
            // Determine if this is for save screen based on current screen
            isSaveScreenSelection = (currentScreen === 1);
            
            // Set temp values based on which screen we're on
            if (isSaveScreenSelection) {
                tempSelectedMonth = selectedSaveMonthDate.getMonth();
                tempSelectedYear = selectedSaveMonthDate.getFullYear();
            } else {
                tempSelectedMonth = selectedMonthDate.getMonth();
                tempSelectedYear = selectedMonthDate.getFullYear();
            }
            
            populateMonthYearInputs();
            document.getElementById('monthYearSlideOut').classList.add('active');
        }
        function hideMonthYearSlideOut() {
            document.getElementById('monthYearSlideOut').classList.remove('active');
        }
        let tempSelectedMonth = selectedMonthDate.getMonth();
        let tempSelectedYear = selectedMonthDate.getFullYear();
        let isSaveScreenSelection = false; // Track if we're selecting for save screen
        function populateMonthYearInputs() {
            // Set current values in the input fields
            const monthInput = document.getElementById('monthInput');
            const yearInput = document.getElementById('yearInput');
            const monthYearValue = document.getElementById('monthYearValue');
            const monthYearContent = document.getElementById('monthYearContent');
            const monthSelectValue = document.getElementById('monthSelectValue');
            const monthSelectContent = document.getElementById('monthSelectContent');
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            
            // Update month display and selection
            if (monthSelectValue) {
                monthSelectValue.textContent = monthNames[tempSelectedMonth];
            }
            
            // Update month dropdown selection
            if (monthSelectContent) {
                monthSelectContent.querySelectorAll('.select-item').forEach((item, index) => {
                    item.classList.remove('selected');
                    if (index === tempSelectedMonth) {
                        item.classList.add('selected');
                    }
                    // Add click handler if not already added
                    if (!item.onclick) {
                        item.onclick = () => selectSlideOutOption('monthSelect', index.toString(), monthNames[index]);
                    }
                });
            }
            
            if (monthInput) {
                monthInput.value = tempSelectedMonth;
            }
            
            // Populate year dropdown with current year back 15 years
            if (monthYearContent) {
                const currentYear = new Date().getFullYear();
                monthYearContent.innerHTML = '';
                
                for (let year = currentYear; year >= currentYear - 15; year--) {
                    const yearItem = document.createElement('div');
                    yearItem.className = 'select-item';
                    yearItem.setAttribute('data-value', year.toString());
                    yearItem.textContent = year.toString();
                    yearItem.onclick = () => selectSlideOutOption('monthYear', year.toString(), year.toString());
                    
                    // Mark current selected year
                    if (year === tempSelectedYear) {
                        yearItem.classList.add('selected');
                    }
                    
                    monthYearContent.appendChild(yearItem);
                }
            }
            
            // Update year display
            if (monthYearValue) {
                monthYearValue.textContent = tempSelectedYear.toString();
            }
            
            // Update hidden select
            if (yearInput) {
                yearInput.value = tempSelectedYear;
            }
        }
        document.getElementById('applyMonthYearBtn').onclick = function() {
            // Use the temp variables directly
            if (typeof tempSelectedMonth === 'number' && typeof tempSelectedYear === 'number' && !isNaN(tempSelectedMonth) && !isNaN(tempSelectedYear)) {
                if (isSaveScreenSelection) {
                    selectedSaveMonthDate = new Date(tempSelectedYear, tempSelectedMonth, 1);
                    updateSaveScreen();
                } else {
                    selectedMonthDate = new Date(tempSelectedYear, tempSelectedMonth, 1);
                    updatePeriodDropdownValues();
                    updatePeriodView();
                }
            }
            hideMonthYearSlideOut();
        };
        function getMonthYearString(date) {
            const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
            if (!date || typeof date.getMonth !== 'function' || isNaN(date.getMonth()) || isNaN(date.getFullYear())) {
                return 'Select a month';
            }
            return `${monthNames[date.getMonth()]} ${date.getFullYear()}`;
        }
        // Update the button text in the card
        function updatePeriodDropdownValues() {
            const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
            const btnText = document.getElementById('monthYearSelectorText');
            if (btnText) {
                btnText.textContent = `${monthNames[selectedMonthDate.getMonth()]} ${selectedMonthDate.getFullYear()}`;
            }
            // Also update the card title if needed (legacy support)
            const budgetPeriodLabel = document.getElementById('budgetPeriodLabel');
            if (budgetPeriodLabel) {
                budgetPeriodLabel.textContent = `${monthNames[selectedMonthDate.getMonth()]} ${selectedMonthDate.getFullYear()}`;
            }
            
            // Also update save screen selector if it exists
            updateSaveMonthYearSelector();
        }
        // Remove old period dropdowns from DOM
        document.addEventListener('DOMContentLoaded', function() {
            const oldDropdowns = document.getElementById('periodDropdowns');
            if (oldDropdowns) oldDropdowns.remove();
            updatePeriodDropdownValues();
        });

        /**
         * Renders the budget card title area depending on period mode.
         * In month mode: shows a large, centered, clickable month/year with chevron below.
         * In today mode: shows a static title (e.g., 'Today' or the date).
         */
        function renderBudgetTitle() {
            const container = document.getElementById('budgetTitleContainer');
            if (!container) return;
            container.innerHTML = '';
            if (currentPeriodMode === 'month') {
                // Month view: clickable, large, left-aligned, Lucide chevron to the right
                const btn = document.createElement('button');
                btn.id = 'monthYearSelectorBtn';
                btn.onclick = showMonthYearSlideOut;
                btn.style.background = 'none';
                btn.style.border = 'none'; // Remove border
                btn.style.borderRadius = '14px';
                btn.style.display = 'inline-flex';
                btn.style.alignItems = 'center';
                btn.style.justifyContent = 'flex-start';
                btn.style.fontSize = '1.5rem';
                btn.style.fontWeight = '700';
                btn.style.color = 'inherit';
                btn.style.cursor = 'pointer';
                btn.style.padding = '0'; // Remove padding
                btn.style.outline = 'none';
                btn.style.width = 'auto';
                // Month/year text
                const span = document.createElement('span');
                span.id = 'monthYearSelectorText';
                span.textContent = getMonthYearString(selectedMonthDate);
                // Lucide chevron icon
                const icon = document.createElement('i');
                icon.setAttribute('data-lucide', 'chevron-down');
                icon.className = 'w-7 h-7';
                icon.style.marginLeft = '0.5rem';
                icon.style.color = 'hsl(var(--muted-foreground))';
                btn.appendChild(span);
                btn.appendChild(icon);
                container.appendChild(btn);
                // Ensure Lucide icons are rendered
                if (window.lucide && typeof window.lucide.createIcons === 'function') {
                    window.lucide.createIcons();
                } else {
                    setTimeout(() => {
                        if (window.lucide && typeof window.lucide.createIcons === 'function') {
                            window.lucide.createIcons();
                        }
                    }, 100);
                }
            } else {
                // Today view: static, left-aligned title
                const h3 = document.createElement('h3');
                h3.className = 'card-title';
                h3.id = 'budgetPeriodLabel';
                h3.style.fontSize = '1.5rem';
                h3.style.fontWeight = '700';
                h3.style.margin = '0';
                h3.style.textAlign = 'left';
                h3.textContent = 'Today';
                container.appendChild(h3);
            }
        }
        function getMonthYearString(date) {
            const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
            return `${monthNames[date.getMonth()]} ${date.getFullYear()}`;
        }
        // Patch updatePeriodDropdownValues to update the title
        const _oldUpdatePeriodDropdownValues = updatePeriodDropdownValues;
        updatePeriodDropdownValues = function() {
            if (_oldUpdatePeriodDropdownValues) _oldUpdatePeriodDropdownValues();
            renderBudgetTitle();
        };
        // Patch setPeriodMode to update the title
        const _oldSetPeriodMode = setPeriodMode;
        setPeriodMode = function(mode) {
            _oldSetPeriodMode(mode);
            renderBudgetTitle();
        };
        // Initial render on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            renderBudgetTitle();
            renderSaveTitle();
        });

        // Swipe to Delete Functionality
        function initializeSwipeToDelete() {
            let startX = 0;
            let currentX = 0;
            let isDragging = false;
            let currentSwipeContainer = null;
            let isSwipeAction = false; // Flag to track if swipe is active
            
            console.log('Initializing simplified swipe-to-delete functionality');

            function handleTouchStart(e) {
                const touch = e.touches ? e.touches[0] : e;
                startX = touch.clientX;
                currentX = startX;
                
                // Don't start a swipe if we clicked on the delete button
                if (e.target.closest('.swipe-action')) {
                    return;
                }
                
                const swipeContainer = e.target.closest('.swipe-container');
                if (swipeContainer) {
                    isDragging = true;
                    isSwipeAction = false; // Reset swipe action flag
                    currentSwipeContainer = swipeContainer;
                    
                    // Remove transition during drag
                    const swipeContent = swipeContainer.querySelector('.swipe-content');
                    if (swipeContent) {
                        swipeContent.style.transition = 'none';
                    }
                }
            }

            function handleTouchMove(e) {
                if (!isDragging || !currentSwipeContainer) return;
                
                const touch = e.touches ? e.touches[0] : e;
                currentX = touch.clientX;
                
                const deltaX = currentX - startX;
                
                // Only allow left swipe (negative deltaX)
                if (deltaX < 0) {
                    isSwipeAction = true; // Mark as a swipe action
                    const translateX = Math.max(deltaX, -80);
                    const swipeContent = currentSwipeContainer.querySelector('.swipe-content');
                    if (swipeContent) {
                        swipeContent.style.transform = `translateX(${translateX}px)`;
                        
                        // Prevent page scrolling when swiping horizontally
                        if (Math.abs(deltaX) > 10 && e.cancelable) {
                            e.preventDefault();
                        }
                    }
                }
            }

            function handleTouchEnd(e) {
                if (!isDragging || !currentSwipeContainer) return;
                
                isDragging = false;
                const deltaX = currentX - startX;
                const swipeContent = currentSwipeContainer.querySelector('.swipe-content');
                
                if (swipeContent) {
                    swipeContent.style.transition = 'transform 0.2s ease';
                    
                    // If swiped more than 30px to the left, show delete action
                    if (deltaX < -30) {
                        currentSwipeContainer.classList.add('swiped');
                        swipeContent.style.transform = 'translateX(-80px)';
                    } else {
                        // Reset to original position
                        currentSwipeContainer.classList.remove('swiped');
                        swipeContent.style.transform = 'translateX(0)';
                    }
                }
                
                currentSwipeContainer = null;
            }

            // Helper function to reset any swiped items when tapping elsewhere
            function handleDocumentClick(e) {
                // Don't reset if clicking on swipe action (delete button)
                if (e.target.closest('.swipe-action')) {
                    return;
                }
                
                // Reset all swiped items when clicking outside
                if (!e.target.closest('.swipe-container')) {
                    document.querySelectorAll('.swipe-container.swiped').forEach(container => {
                        container.classList.remove('swiped');
                        const content = container.querySelector('.swipe-content');
                        if (content) content.style.transform = 'translateX(0)';
                    });
                }
            }
            
            // Add custom click handler for swipe containers to handle edit functionality
            function handleContainerClick(e) {
                // If we're in a swipe action, don't trigger edit
                if (isSwipeAction) {
                    isSwipeAction = false;
                    return;
                }
                
                // Don't trigger edit if we're clicking on the delete button
                if (e.target.closest('.swipe-action')) {
                    console.log('Click on swipe action, ignoring for edit');
                    return;
                }
                
                const container = e.target.closest('.swipe-container');
                if (container) {
                    const type = container.dataset.type;
                    console.log('Container click detected for type:', type);
                    
                    // Handle expense edit
                    if (type === 'expense') {
                        const date = container.dataset.date;
                        const timestamp = container.dataset.timestamp;
                        if (date && timestamp) {
                            console.log('Calling editExpense with:', { date, timestamp });
                            // Only call editExpense if this was a tap, not a swipe
                            editExpense(date, timestamp);
                        }
                    }
                    // Handle balance edit (if needed)
                    // else if (type === 'balance') { ... }
                }
            }

            // Add event listeners to the document
            document.addEventListener('touchstart', handleTouchStart, { passive: false });
            document.addEventListener('touchmove', handleTouchMove, { passive: false });
            document.addEventListener('touchend', handleTouchEnd, { passive: true });
            document.addEventListener('click', handleDocumentClick);
            document.addEventListener('click', handleContainerClick);

            // Also handle mouse events for desktop testing
            document.addEventListener('mousedown', handleTouchStart);
            document.addEventListener('mousemove', (e) => {
                if (isDragging) handleTouchMove(e);
            });
            document.addEventListener('mouseup', handleTouchEnd);
        }

        // Initialize swipe functionality when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeSwipeToDelete();
        });

        /**
         * Update the visibility of balance-related UI elements
         */
        function updateBalanceUIVisibility(showBalance) {
            const balanceBtn = document.getElementById('balanceActionBtn');
            const fabBalanceOption = document.getElementById('fabBalanceOption');
            const balanceActionCard = document.getElementById('balanceActionCard');
            
            if (balanceBtn) {
                balanceBtn.style.display = showBalance ? 'flex' : 'none';
            }
            
            if (fabBalanceOption) {
                fabBalanceOption.style.display = showBalance ? 'flex' : 'none';
            }
            
            if (balanceActionCard) {
                balanceActionCard.style.display = showBalance ? 'block' : 'none';
            }
        }

        /**
         * Loads comprehensive test data for both balances and expenses from January to today.
         * This function creates realistic financial data for testing the chart and reports.
         */
        function loadTestData() {
            console.log('Loading comprehensive test data...');
            
            // Get current date and calculate January 1st of current year
            const today = new Date();
            const januaryFirst = new Date(today.getFullYear(), 0, 1);
            
            // Initialize test data structures
            const testBalances = {
                checking: {},
                savings: {},
                emergency: {}
            };
            
            const testExpenses = {};
            
            // Generate balance data with realistic growth patterns
            let currentDate = new Date(januaryFirst);
            let checkingBalance = 2500; // Starting balance
            let savingsBalance = 8000; // Starting balance
            let emergencyBalance = 3000; // Starting balance
            
            while (currentDate <= today) {
                const dateKey = currentDate.toISOString().split('T')[0]; // YYYY-MM-DD format
                
                // Add some random balance updates (not every day)
                if (Math.random() < 0.1) { // 10% chance of balance update
                    // Simulate salary deposits and transfers
                    if (Math.random() < 0.3) {
                        checkingBalance += 2500 + Math.random() * 500; // Salary deposit
                    }
                    if (Math.random() < 0.2) {
                        const transfer = 500 + Math.random() * 1000;
                        checkingBalance -= transfer;
                        savingsBalance += transfer;
                    }
                    if (Math.random() < 0.15) {
                        const emergencyTransfer = 200 + Math.random() * 300;
                        savingsBalance -= emergencyTransfer;
                        emergencyBalance += emergencyTransfer;
                    }
                    
                    // Add some spending from checking
                    checkingBalance -= Math.random() * 200;
                    
                    // Add some interest to savings
                    savingsBalance += savingsBalance * 0.001; // 0.1% monthly interest
                    emergencyBalance += emergencyBalance * 0.0005; // 0.05% monthly interest
                }
                
                // Record balances for this date
                testBalances.checking[dateKey] = Math.round(checkingBalance);
                testBalances.savings[dateKey] = Math.round(savingsBalance);
                testBalances.emergency[dateKey] = Math.round(emergencyBalance);
                
                // Generate expense data (not every day)
                if (Math.random() < 0.7) { // 70% chance of expenses
                    const expenseCategories = ['groceries', 'transportation', 'dining', 'entertainment', 'personal', 'clothing', 'health', 'subscriptions', 'other'];
                    const numExpenses = Math.floor(Math.random() * 3) + 1; // 1-3 expenses per day
                    
                    testExpenses[dateKey] = [];
                    
                    for (let i = 0; i < numExpenses; i++) {
                        const category = expenseCategories[Math.floor(Math.random() * expenseCategories.length)];
                        let amount = 0;
                        
                        // Generate realistic amounts based on category
                        switch (category) {
                            case 'groceries':
                                amount = 15 + Math.random() * 85; // $15-100
                                break;
                            case 'transportation':
                                amount = 5 + Math.random() * 45; // $5-50
                                break;
                            case 'dining':
                                amount = 12 + Math.random() * 38; // $12-50
                                break;
                            case 'entertainment':
                                amount = 8 + Math.random() * 42; // $8-50
                                break;
                            case 'personal':
                                amount = 10 + Math.random() * 40; // $10-50
                                break;
                            case 'clothing':
                                amount = 25 + Math.random() * 75; // $25-100
                                break;
                            case 'health':
                                amount = 15 + Math.random() * 35; // $15-50
                                break;
                            case 'subscriptions':
                                amount = 5 + Math.random() * 25; // $5-30
                                break;
                            case 'other':
                                amount = 5 + Math.random() * 45; // $5-50
                                break;
                        }
                        
                        testExpenses[dateKey].push({
                            amount: Math.round(amount * 100) / 100, // Round to 2 decimal places
                            category: category,
                            description: `${category.charAt(0).toUpperCase() + category.slice(1)} expense`,
                            timestamp: Date.now() + i, // Ensure unique timestamps
                            created: Date.now() + i,
                            updated: Date.now() + i
                        });
                    }
                }
                
                // Move to next day
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Save test data to localStorage
            localStorage.setItem('accountBalances', JSON.stringify(testBalances));
            localStorage.setItem('dailyExpenses', JSON.stringify(testExpenses));
            
            // Initialize savings accounts if not already set
            const existingAccounts = localStorage.getItem('savingsAccounts');
            if (!existingAccounts) {
                const defaultAccounts = [
                    { id: 'checking', name: 'Checking', type: 'checking' },
                    { id: 'savings', name: 'Savings', type: 'savings' },
                    { id: 'emergency', name: 'Emergency Fund', type: 'emergency' }
                ];
                localStorage.setItem('savingsAccounts', JSON.stringify(defaultAccounts));
            }
            
            console.log('Test data loaded successfully!');
            console.log('Balance data:', testBalances);
            console.log('Expense data sample:', Object.keys(testExpenses).slice(0, 5).map(date => ({ date, expenses: testExpenses[date] })));
            
            // Refresh the display
            updatePeriodView();
            if (currentScreen === 1) {
                updateChart();
            }
            
            // Show success message
            alert('Test data loaded successfully! Check the Reports screen to see the chart with comprehensive data from January to today.');
        }
        
        // Add button to load test data (for development/testing purposes)
        function addTestDataButton() {
            const button = document.createElement('button');
            button.textContent = 'Load Test Data';
            button.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                z-index: 9999;
                background: #10B981;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 6px;
                font-size: 12px;
                cursor: pointer;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            `;
            button.onclick = loadTestData;
            document.body.appendChild(button);
        }

        /**
         * Formats a number as a currency string with proper commas and 2 decimal places.
         * @param {number} amount - The amount to format.
         * @returns {string} Formatted currency string (e.g., "$1,234.56").
         */
        function formatCurrency(amount) {
            if (typeof amount !== 'number' || isNaN(amount)) {
                return '$0.00';
            }
            return '$' + amount.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        /**
         * Formats a number as a currency string without decimal places for whole amounts.
         * @param {number} amount - The amount to format.
         * @returns {string} Formatted currency string (e.g., "$1,234").
         */
        function formatCurrencyWhole(amount) {
            if (typeof amount !== 'number' || isNaN(amount)) {
                return '$0';
            }
            return '$' + amount.toLocaleString('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }

        // Update save target display
        function updateSaveTargetDisplay() {
            const today = new Date();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            const dayOfMonth = today.getDate();
            
            let targetAmount = 0;
            let progressAmount = 0;
            let progressPercentage = 0;
            let lastBalanceDate = '';
            let periodLabel = '';
            let description = '';
            
            if (currentSavePeriodMode === 'today') {
                // Daily saving target (monthly target divided by days in month)
                targetAmount = getMonthlySavingsTarget() / daysInMonth;
                periodLabel = 'Daily Saving Target';
                description = 'daily saving target';
                
                const progressLabel = document.getElementById('saveProgressLabel');
                if (progressLabel) {
                    progressLabel.textContent = 'Progress Today';
                }
            } else {
                // Monthly saving target
                targetAmount = getMonthlySavingsTarget();
                periodLabel = `${selectedSaveMonthDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })} Saving Target`;
                description = 'monthly saving target';
                
                const progressLabel = document.getElementById('saveProgressLabel');
                if (progressLabel) {
                    progressLabel.textContent = 'Progress This Month';
                }
            }
            
            // Calculate progress based on balance differences
            const { currentTotal, previousTotal, lastDate } = getSaveBalanceComparison();
            progressAmount = currentTotal - previousTotal;
            progressPercentage = previousTotal > 0 ? ((currentTotal - previousTotal) / previousTotal) * 100 : 0;
            lastBalanceDate = lastDate;
            
            // Update display elements
            const saveTargetDescription = document.getElementById('saveTargetDescription');
            const saveTargetAmount = document.getElementById('saveTargetAmount');
            const saveProgressAmount = document.getElementById('saveProgressAmount');
            
            // Update the month/year selector text
            updateSaveMonthYearSelector();
            if (saveTargetDescription) {
                saveTargetDescription.textContent = description;
            }
            if (saveTargetAmount) {
                saveTargetAmount.textContent = formatCurrency(targetAmount);
            }
            if (saveProgressAmount) {
                const sign = progressAmount >= 0 ? '+' : '';
                const percentageText = progressPercentage !== 0 ? ` (${sign}${progressPercentage.toFixed(1)}%)` : '';
                saveProgressAmount.textContent = `${sign}${formatCurrency(progressAmount)}${percentageText}`;
            }
            
            // Update save status
            if (document.getElementById('saveStatusText')) {
                const percentProgress = targetAmount > 0 ? (progressAmount / targetAmount) * 100 : 0;
                let statusText = '';
                let statusColor = '';
                let cardBackgroundColor = '';
                let amountColor = '';
                
                if (percentProgress >= 100) {
                    statusText = 'Target Met!';
                    statusColor = 'hsl(156.06deg 40% 40%)'; // Green
                    cardBackgroundColor = 'hsl(156.06deg 40% 96%)'; // Light green background
                    amountColor = 'hsl(156.06deg 40% 20%)'; // Dark green text
                } else if (percentProgress >= 75) {
                    statusText = 'On Track';
                    statusColor = 'hsl(156.06deg 40% 40%)'; // Green
                    cardBackgroundColor = 'hsl(156.06deg 40% 96%)'; // Light green background
                    amountColor = 'hsl(156.06deg 40% 20%)'; // Dark green text
                } else if (percentProgress >= 50) {
                    statusText = 'Good Progress';
                    statusColor = 'hsl(38deg 92% 50%)'; // Orange
                    cardBackgroundColor = 'hsl(38deg 92% 96%)'; // Light orange background
                    amountColor = 'hsl(38deg 92% 20%)'; // Dark orange text
                } else {
                    statusText = 'Behind Target';
                    statusColor = 'hsl(0deg 84% 60%)'; // Red
                    cardBackgroundColor = 'hsl(0deg 84% 96%)'; // Light red background
                    amountColor = 'hsl(0deg 84% 20%)'; // Dark red text
                }
                
                document.getElementById('saveStatusText').textContent = statusText;
                document.getElementById('saveStatusText').style.backgroundColor = statusColor;
                
                // Update progress card background and text color
                const progressContainer = document.querySelector('#saveTargetDisplay .remaining-budget-section');
                const progressAmountEl = document.getElementById('saveProgressAmount');
                
                if (progressContainer && progressAmountEl) {
                    progressContainer.style.backgroundColor = cardBackgroundColor;
                    progressAmountEl.style.color = amountColor;
                }
            }
            
            // Update progress label with last balance date context
            const progressLabel = document.getElementById('saveProgressLabel');
            if (progressLabel && lastBalanceDate) {
                if (currentSavePeriodMode === 'today') {
                    const lastDateObj = new Date(lastBalanceDate);
                    const lastDateFormatted = lastDateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    progressLabel.textContent = `Today vs ${lastDateFormatted}`;
                } else {
                    const selectedMonthName = selectedSaveMonthDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                    progressLabel.textContent = `${selectedMonthName} vs previous month`;
                }
            }
        }
        
        // Get balance comparison for progress calculation
        function getBalanceComparison() {
            const balances = loadAccountBalances();
            const today = getCurrentDate();
            
            // Get current total balance (sum of all accounts)
            const currentTotal = getTotalBalanceForDate(balances, today);
            
            if (currentSavePeriodMode === 'today') {
                // For daily: compare to yesterday or last available balance
                const yesterday = getPreviousDate(today);
                let previousTotal = getTotalBalanceForDate(balances, yesterday);
                let lastDate = yesterday;
                
                // If no balance for yesterday, find the closest available balance
                if (previousTotal === 0) {
                    const availableDates = getAllAvailableDates(balances);
                    const lastAvailableDate = availableDates.find(date => date < yesterday);
                    if (lastAvailableDate) {
                        previousTotal = getTotalBalanceForDate(balances, lastAvailableDate);
                        lastDate = lastAvailableDate;
                    }
                }
                
                return { currentTotal, previousTotal, lastDate };
            } else {
                // For monthly: compare to same day last month or last available balance
                const sameDayLastMonth = getSameDayLastMonth(today);
                let previousTotal = getTotalBalanceForDate(balances, sameDayLastMonth);
                let lastDate = sameDayLastMonth;
                
                // If no balance for same day last month, find the closest available balance
                if (previousTotal === 0) {
                    const availableDates = getAllAvailableDates(balances);
                    const lastAvailableDate = availableDates.find(date => date < sameDayLastMonth);
                    if (lastAvailableDate) {
                        previousTotal = getTotalBalanceForDate(balances, lastAvailableDate);
                        lastDate = lastAvailableDate;
                    }
                }
                
                return { currentTotal, previousTotal, lastDate };
            }
        }
        
        // Get balance comparison for save screen (uses selected month)
        function getSaveBalanceComparison() {
            const balances = loadAccountBalances();
            
            if (currentSavePeriodMode === 'today') {
                // For daily mode, use the same logic as regular comparison
                return getBalanceComparison();
            } else {
                // For monthly mode, get the latest balance for the selected month
                const selectedMonthKey = getSelectedSaveMonthKey();
                let currentTotal = 0;
                let lastDate = '';
                
                // Get the latest balance for the selected month
                Object.keys(balances).forEach(accountId => {
                    const accountBalances = balances[accountId] || {};
                    const monthBalances = Object.keys(accountBalances)
                        .filter(date => date.startsWith(selectedMonthKey))
                        .sort()
                        .reverse();
                    
                    if (monthBalances.length > 0) {
                        const latestBalance = accountBalances[monthBalances[0]];
                        // Handle both old format (direct number) and new format (object with amount)
                        const amount = latestBalance && typeof latestBalance === 'object' ? 
                            latestBalance.amount : latestBalance;
                            
                        if (typeof amount === 'number' && !isNaN(amount)) {
                            currentTotal += amount;
                        }
                        
                        if (!lastDate || monthBalances[0] > lastDate) {
                            lastDate = monthBalances[0];
                        }
                    }
                });
                
                // Get the previous month's balance for comparison
                const previousMonth = new Date(selectedSaveMonthDate);
                previousMonth.setMonth(previousMonth.getMonth() - 1);
                const previousMonthKey = `${previousMonth.getFullYear()}-${String(previousMonth.getMonth() + 1).padStart(2, '0')}`;
                
                let previousTotal = 0;
                let previousLastDate = '';
                
                Object.keys(balances).forEach(accountId => {
                    const accountBalances = balances[accountId] || {};
                    const previousMonthBalances = Object.keys(accountBalances)
                        .filter(date => date.startsWith(previousMonthKey))
                        .sort()
                        .reverse();
                    
                    if (previousMonthBalances.length > 0) {
                        const latestBalance = accountBalances[previousMonthBalances[0]];
                        // Handle both old format (direct number) and new format (object with amount)
                        const amount = latestBalance && typeof latestBalance === 'object' ? 
                            latestBalance.amount : latestBalance;
                            
                        if (typeof amount === 'number' && !isNaN(amount)) {
                            previousTotal += amount;
                        }
                        
                        if (!previousLastDate || previousMonthBalances[0] > previousLastDate) {
                            previousLastDate = previousMonthBalances[0];
                        }
                    }
                });
                
                return { currentTotal, previousTotal, lastDate: previousLastDate };
            }
        }
        
        // Get total balance for a specific date
        function getTotalBalanceForDate(balances, date) {
            let totalBalance = 0;
            
            // Sum up all account balances for the given date
            Object.keys(balances).forEach(accountId => {
                const accountBalances = balances[accountId] || {};
                if (accountBalances[date]) {
                    const balance = accountBalances[date];
                    // Handle both old format (direct number) and new format (object with amount)
                    const amount = balance && typeof balance === 'object' ? balance.amount : balance;
                    
                    if (typeof amount === 'number' && !isNaN(amount)) {
                        totalBalance += amount;
                    }
                }
            });
            
            return totalBalance;
        }
        
        // Get previous date (yesterday)
        function getPreviousDate(dateString) {
            const date = new Date(dateString);
            date.setDate(date.getDate() - 1);
            return date.toISOString().split('T')[0];
        }
        
        // Get same day last month
        function getSameDayLastMonth(dateString) {
            const date = new Date(dateString);
            date.setMonth(date.getMonth() - 1);
            
            // Handle edge case: if current day doesn't exist in previous month
            // (e.g., Jan 31 -> Feb 28/29), use the last day of previous month
            const lastDayOfPrevMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
            if (date.getDate() > lastDayOfPrevMonth) {
                date.setDate(lastDayOfPrevMonth);
            }
            
            return date.toISOString().split('T')[0];
        }

        // Update save screen total savings display
        function updateSaveTotalSavingsDisplay() {
            const balances = loadAccountBalances();
            
            if (currentSavePeriodMode === 'today') {
                // For today mode, use current date
                const today = getCurrentDate();
                const currentTotal = getTotalBalanceForDate(balances, today);
                const { previousTotal, lastDate } = getBalanceComparison();
                const balanceChange = currentTotal - previousTotal;
                const balanceChangePercentage = previousTotal > 0 ? (balanceChange / previousTotal) * 100 : 0;
                
                // Update save screen balance display
                const saveTotalAccountBalance = document.getElementById('saveTotalAccountBalance');
                const saveTotalBalanceChange = document.getElementById('saveTotalBalanceChange');
                
                if (saveTotalAccountBalance) {
                    saveTotalAccountBalance.textContent = formatCurrency(currentTotal);
                }
                if (saveTotalBalanceChange) {
                    saveTotalBalanceChange.textContent = 'Total Balance';
                    saveTotalBalanceChange.className = 'balance-change-modern';
                }
                
                // Update the date display
                const saveBalanceDate = document.getElementById('saveBalanceDate');
                if (saveBalanceDate) {
                    const today = new Date();
                    saveBalanceDate.textContent = today.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                }
            } else {
                // For monthly mode, use selected month data
                const { currentTotal, previousTotal, lastDate } = getSaveBalanceComparison();
                const balanceChange = currentTotal - previousTotal;
                
                // Only calculate percentage if we have valid previous data
                let balanceChangePercentage = 0;
                let percentageText = '';
                
                if (previousTotal > 0 && !isNaN(previousTotal)) {
                    balanceChangePercentage = (balanceChange / previousTotal) * 100;
                    const sign = balanceChange >= 0 ? '+' : '';
                    percentageText = ` (${sign}${balanceChangePercentage.toFixed(1)}%)`;
                }
                
                // Update save screen balance display
                const saveTotalAccountBalance = document.getElementById('saveTotalAccountBalance');
                const saveTotalBalanceChange = document.getElementById('saveTotalBalanceChange');
                
                if (saveTotalAccountBalance) {
                    saveTotalAccountBalance.textContent = formatCurrency(currentTotal);
                }
                
                if (saveTotalBalanceChange) {
                    saveTotalBalanceChange.textContent = 'Total Balance';
                    saveTotalBalanceChange.className = 'balance-change-modern';
                }
                
                // Update the date display
                const saveBalanceDate = document.getElementById('saveBalanceDate');
                if (saveBalanceDate) {
                    const selectedMonthName = selectedSaveMonthDate.toLocaleDateString('en-US', { month: 'long' });
                    saveBalanceDate.textContent = selectedMonthName;
                }
            }
            
            // Update save screen balance history
            updateSaveBalanceHistory();
        }
        
        // Update save screen balance history
        function updateSaveBalanceHistory() {
            const balances = loadAccountBalances();
            const historyContainer = document.getElementById('saveBalanceHistory');
            
            if (!historyContainer) return;
            
            // Group balance records by account for the selected month
            const selectedMonthKey = getSelectedSaveMonthKey();
            const previousMonth = new Date(selectedSaveMonthDate);
            previousMonth.setMonth(previousMonth.getMonth() - 1);
            const previousMonthKey = `${previousMonth.getFullYear()}-${String(previousMonth.getMonth() + 1).padStart(2, '0')}`;

            // Prepare grouped data
            const grouped = {};
            savingsAccounts.forEach(account => {
                const accountBalances = balances[account.id] || {};
                // Get all updates for the selected month, sort by created
                const monthUpdates = Object.keys(accountBalances)
                    .filter(date => date.startsWith(selectedMonthKey))
                    .map(date => {
                        const entry = accountBalances[date];
                        return {
                            date,
                            amount: entry.amount !== undefined ? entry.amount : entry,
                            created: entry.created || new Date(date).getTime(),
                            updated: entry.updated || entry.created || new Date(date).getTime()
                        };
                    })
                    .sort((a, b) => {
                        const createdA = a.created || new Date(a.date).getTime();
                        const createdB = b.created || new Date(b.date).getTime();
                        if (createdA !== createdB) {
                            return createdB - createdA; // Most recent first
                        }
                        // If created timestamps are the same, use date for stable ordering (descending)
                        return b.date.localeCompare(a.date);
                    });
                // Get last value from previous month
                const prevMonthDates = Object.keys(accountBalances)
                    .filter(date => date.startsWith(previousMonthKey))
                    .sort();
                const prevMonthLastDate = prevMonthDates.length > 0 ? prevMonthDates[prevMonthDates.length - 1] : null;
                const prevMonthLastValue = prevMonthLastDate ? (accountBalances[prevMonthLastDate].amount !== undefined ? accountBalances[prevMonthLastDate].amount : accountBalances[prevMonthLastDate]) : 0;
                grouped[account.id] = {
                    name: account.name,
                    monthUpdates,
                    prevMonthLastValue
                };
            });

            // Render modern accordions
            let html = '';
            let anyData = false;
            Object.keys(grouped).forEach(accountId => {
                const { name, monthUpdates, prevMonthLastValue } = grouped[accountId];
                if (monthUpdates.length === 0) return; // Only show accounts with data
                anyData = true;
                // Latest value for the selected month
                const latest = monthUpdates[monthUpdates.length - 1];
                // Calculate all-time percent (from first ever value)
                const accountBalances = balances[accountId] || {};
                const allDates = Object.keys(accountBalances).sort();
                const firstValue = allDates.length > 0 ? accountBalances[allDates[0]] : 0;
                const allTimePercent = firstValue && latest.amount ? ((latest.amount - firstValue) / firstValue) * 100 : 0;
                // Accordion header: account name, latest value
                html += `<div class="modern-account-accordion" data-account-id="${accountId}">
                    <div class="modern-account-accordion-header" onclick="toggleAccountAccordion('${accountId}')">
                        <div class="modern-account-header-left">
                            <div class="modern-account-title">${name}</div>
                        </div>
                        <div class="modern-account-header-right">
                            <div class="modern-account-balance">${formatCurrency(latest.amount)}</div>
                        </div>
                        <div class="account-chevron"><i data-lucide="chevron-down" class="modern-account-chevron" id="chevron-${accountId}"></i></div>
                    </div>
                    <div class="modern-account-accordion-body" id="accordion-body-${accountId}">
                        <div class="modern-account-updates">
                `;
                // Sort updates by date in descending order (newest first)
                const sortedUpdates = [...monthUpdates].sort((a, b) => {
                    return new Date(b.date) - new Date(a.date);
                });
                
                // Process updates in chronological order for display
                let prevValue = null;
                let prevDate = null;
                
                // First pass to determine previous values
                const updatesWithPercents = sortedUpdates.map((update, index) => {
                    // Calculate percent change from previous value (next in array)
                    let percent = null;
                    let arrow = '';
                    
                    // If we have a next item (which is the previous date's value)
                    const nextItem = sortedUpdates[index + 1];
                    if (nextItem) {
                        const previousAmount = nextItem.amount;
                        if (previousAmount !== null && previousAmount !== 0) {
                            percent = ((update.amount - previousAmount) / Math.abs(previousAmount)) * 100;
                            if (percent > 0.01) {
                                arrow = '<i data-lucide="arrow-up-right" class="balance-arrow positive"></i>';
                            } else if (percent < -0.01) {
                                arrow = '<i data-lucide="arrow-down-right" class="balance-arrow negative"></i>';
                            } else {
                                arrow = '<i data-lucide="arrow-right" class="balance-arrow neutral"></i>';
                            }
                        }
                    }
                    
                    const percentClass = percent > 0 ? 'positive' : percent < 0 ? 'negative' : 'neutral';
                    
                    const [year, month, day] = update.date.split('-').map(Number);
                    const dateObj = new Date(year, month - 1, day);
                    const displayDate = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    
                    return {
                        ...update,
                        displayDate,
                        percent,
                        percentClass,
                        arrow
                    };
                });
                
                // Render updates
                updatesWithPercents.forEach(update => {
                    html += `<div class="swipe-container" data-type="balance" data-account-id="${accountId}" data-date="${update.date}">
                        <div class="swipe-content">
                            <div class="modern-account-update-row">
                                <div class="modern-update-date">${update.displayDate}</div>
                                <div class="modern-update-amount-stack">
                                <div class="modern-update-diff">${formatCurrency(update.amount)}</div>
                                <div class="modern-update-percent ${update.percentClass}">${update.percent !== null ? `${update.arrow}${update.percent >= 0 ? '+' : ''}${update.percent.toFixed(2)}%` : '--'}</div>
                                </div>
                            </div>
                        </div>
                        <div class="swipe-action" onclick="handleBalanceDelete(this); event.stopPropagation(); return false;"><i data-lucide="x" class="w-4 h-4"></i></div>
                    </div>`;
                });
                html += `</div></div></div>`;
            });
            if (!anyData) {
                const selectedMonthName = selectedSaveMonthDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                html = `<div style="text-align: center; color: #7f8c8d; padding: 20px;">No balance records for ${selectedMonthName}</div>`;
            }
            historyContainer.innerHTML = html;
            // Ensure Lucide icons are rendered
            if (window.lucide && typeof window.lucide.createIcons === 'function') {
                window.lucide.createIcons();
            }
        }

        // Accordion toggle function
        function toggleAccountAccordion(accountId) {
            const body = document.getElementById(`accordion-body-${accountId}`);
            const chevron = document.getElementById(`chevron-${accountId}`);
            const header = document.querySelector(`.modern-account-accordion[data-account-id='${accountId}'] .modern-account-accordion-header`);
            // Remove any inline styles that might have been set
            if (body) {
                body.style.display = '';
                body.style.maxHeight = '';
                body.style.opacity = '';
            }
            if (body.classList.contains('expanded')) {
                body.classList.remove('expanded');
                if (header) header.classList.remove('expanded');
            } else {
                body.classList.add('expanded');
                if (header) header.classList.add('expanded');
            }
        }

        // Get all available dates from balance data
        function getAllAvailableDates(balances) {
            const allDates = new Set();
            
            Object.keys(balances).forEach(accountId => {
                const accountBalances = balances[accountId] || {};
                Object.keys(accountBalances).forEach(date => {
                    allDates.add(date);
                });
            });
            
            return Array.from(allDates).sort();
        }

        // Get the last balance for a specific account
        function getLastBalanceForAccount(accountId) {
            const balances = loadAccountBalances();
            const accountBalances = balances[accountId] || {};
            
            if (Object.keys(accountBalances).length === 0) {
                return { amount: 0 }; // No balance records for this account
            }
            
            // Get all dates for this account and sort them (newest first)
            const dates = Object.keys(accountBalances).sort().reverse();
            const lastBalance = accountBalances[dates[0]];
            
            // Handle both old format (direct number) and new format (object with amount)
            if (lastBalance === null || lastBalance === undefined) {
                return { amount: 0 };
            } else if (typeof lastBalance === 'object') {
                return lastBalance;
            } else {
                return { amount: lastBalance };
            }
        }

        // Update save screen display
        function updateSaveScreen() {
            renderSaveTitle();
            updateSaveTargetDisplay();
            updateSaveTotalSavingsDisplay();
        }

        /**
         * Renders the save screen title area with month/year selector.
         * Shows a large, centered, clickable month/year with chevron.
         */
        function renderSaveTitle() {
            const container = document.getElementById('saveTargetTitleContainer');
            if (!container) return;
            container.innerHTML = '';
            
            // Create month/year selector button
            const btn = document.createElement('button');
            btn.id = 'saveMonthYearSelectorBtn';
            btn.onclick = showSaveMonthYearSlideOut;
            btn.style.background = 'none';
            btn.style.border = 'none';
            btn.style.borderRadius = '14px';
            btn.style.display = 'inline-flex';
            btn.style.alignItems = 'center';
            btn.style.justifyContent = 'flex-start';
            btn.style.fontSize = '1.5rem';
            btn.style.fontWeight = '700';
            btn.style.color = 'inherit';
            btn.style.cursor = 'pointer';
            btn.style.padding = '0';
            btn.style.outline = 'none';
            btn.style.width = 'auto';
            
            // Month/year text
            const span = document.createElement('span');
            span.id = 'saveMonthYearSelectorText';
            span.textContent = getMonthYearString(selectedSaveMonthDate);
            
            // Lucide chevron icon
            const icon = document.createElement('i');
            icon.setAttribute('data-lucide', 'chevron-down');
            icon.className = 'w-7 h-7';
            icon.style.marginLeft = '0.5rem';
            icon.style.color = 'hsl(var(--muted-foreground))';
            
            btn.appendChild(span);
            btn.appendChild(icon);
            container.appendChild(btn);
            
            // Ensure Lucide icons are rendered
            if (window.lucide && typeof window.lucide.createIcons === 'function') {
                window.lucide.createIcons();
            } else {
                setTimeout(() => {
                    if (window.lucide && typeof window.lucide.createIcons === 'function') {
                        window.lucide.createIcons();
                    }
                }, 100);
            }
        }

        /**
         * Shows the save month/year selection slide-out
         */
        function showSaveMonthYearSlideOut() {
            showMonthYearSlideOut();
        }

        /**
         * Updates the save month/year selector text
         */
        function updateSaveMonthYearSelector() {
            const btnText = document.getElementById('saveMonthYearSelectorText');
            if (btnText) {
                btnText.textContent = getMonthYearString(selectedSaveMonthDate);
            }
        }

        // Set save period mode (today/month)
        function setSavePeriodMode(mode) {
            currentSavePeriodMode = mode;
            
            // Update compact button states
            const saveTodayBtn = document.getElementById('saveTodayBtnCompact');
            const saveMonthBtn = document.getElementById('saveMonthBtnCompact');
            if (saveTodayBtn) saveTodayBtn.classList.toggle('active', mode === 'today');
            if (saveMonthBtn) saveMonthBtn.classList.toggle('active', mode === 'month');
            
            // Update icon-only button states
            const saveTodayBtnIcon = document.getElementById('saveTodayBtnIcon');
            const saveMonthBtnIcon = document.getElementById('saveMonthBtnIcon');
            if (saveTodayBtnIcon) saveTodayBtnIcon.classList.toggle('active', mode === 'today');
            if (saveMonthBtnIcon) saveMonthBtnIcon.classList.toggle('active', mode === 'month');
            
            // Update save screen display
            updateSaveScreen();
        }

        /**
         * Initialize click-outside-to-close functionality for all slide-out menus
         * This function sets up event listeners on the overlay backgrounds to close menus when clicked
         */
        function initializeSlideOutClickOutside() {
            // Get all slide-out overlays
            const slideOutOverlays = document.querySelectorAll('.slide-out-overlay, .account-management-slide-out');
            
            slideOutOverlays.forEach(overlay => {
                overlay.addEventListener('click', function(event) {
                    // Check if the click was on the overlay background (not on the content)
                    if (event.target === overlay) {
                        // Close the specific slide-out based on its ID
                        const slideOutId = overlay.id;
                        switch (slideOutId) {
                            case 'expenseSlideOut':
                                hideExpenseSlideOut();
                                break;
                            case 'balanceSlideOut':
                                hideBalanceSlideOut();
                                break;
                            case 'monthYearSlideOut':
                                hideMonthYearSlideOut();
                                break;
                            case 'accountManagementSlideOut':
                                hideAccountManagementSlideOut();
                                break;
                            default:
                                // Generic fallback - remove active class
                                overlay.classList.remove('active');
                                break;
                        }
                    }
                });
            });
        }

        /**
         * Updates the header title based on the current screen.
         */
        function updateHeaderTitle() {
            const headerTitle = document.getElementById('headerTitle');
            const settingsButton = document.getElementById('settingsButton');
            
            if (!headerTitle) return;
            
            switch (currentScreen) {
                case 0:
                    headerTitle.textContent = 'Spend';
                    settingsButton.style.display = 'block';
                    break;
                case 1:
                    headerTitle.textContent = 'Save';
                    settingsButton.style.display = 'block';
                    break;
                case 2:
                    headerTitle.textContent = 'Reports';
                    settingsButton.style.display = 'block';
                    break;
                default:
                    headerTitle.textContent = '';
                    settingsButton.style.display = 'block';
            }
        }

        // Update goToScreen to call updateHeaderTitle
        const originalGoToScreen = goToScreen;
        goToScreen = function(screenIndex) {
            currentScreen = screenIndex;
            const wrapper = document.getElementById('screensWrapper');
            wrapper.style.transform = `translateX(-${screenIndex * 100}vw)`;
            document.querySelectorAll('.nav-item').forEach((item, index) => {
                item.classList.toggle('active', index === screenIndex);
            });
            updateHeaderTitle();
            // ... existing code for updating screens ...
            if (screenIndex === 2) {
                updateReports();
                setTimeout(updateChart, 300);
            } else if (screenIndex === 0) {
                setPeriodMode('today');
            } else if (screenIndex === 1) {
                // Set month mode as default for save screen
                setSavePeriodMode('month');
                updateSaveScreen();
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            updateHeaderTitle();
        });

        // Settings Slide-out Functions
        function openSettings() {
            const overlay = document.getElementById('settingsOverlay');
            const panel = document.getElementById('settingsPanel');
            const appContainer = document.querySelector('.app-container');
            
            // Load settings data
            loadSettings();
            
            // Show overlay and panel
            overlay.classList.add('active');
            panel.classList.add('active');
            
            // Add slide transition to main content
            appContainer.classList.add('settings-open');
            
            // Hide bottom navigation
            document.querySelector('.bottom-nav').style.display = 'none';
        }

        function closeSettings() {
            const overlay = document.getElementById('settingsOverlay');
            const panel = document.getElementById('settingsPanel');
            const appContainer = document.querySelector('.app-container');
            
            // Hide overlay and panel
            overlay.classList.remove('active');
            panel.classList.remove('active');
            
            // Remove slide transition from main content
            appContainer.classList.remove('settings-open');
            
            // Show bottom navigation
            document.querySelector('.bottom-nav').style.display = 'flex';
        }

        // Close settings when clicking overlay
        document.addEventListener('DOMContentLoaded', function() {
            const overlay = document.getElementById('settingsOverlay');
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    closeSettings();
                }
            });
            
            // Close budget setup when clicking overlay
            const budgetOverlay = document.getElementById('budgetOverlay');
            budgetOverlay.addEventListener('click', function(e) {
                if (e.target === budgetOverlay) {
                    closeBudgetSetup();
                }
            });
        });

        // Settings Functions
        function loadSettings() {
            // Budget settings are now loaded in the budget slide-out
            // No need to load them here since the settings slide-out no longer contains budget forms
        }

        function updateSimpleBudgetSummary() {
            // Get values from inputs
            const grossIncome = parseFloat(document.getElementById('grossIncome').value) || 0;
            const federalTax = parseFloat(document.getElementById('federalTax').value) || 0;
            const provincialTax = parseFloat(document.getElementById('provincialTax').value) || 0;
            const cppEi = parseFloat(document.getElementById('cppEi').value) || 0;
            let netIncome = parseFloat(document.getElementById('netIncome').value) || 0;
            const annualSavingsGoal = parseFloat(document.getElementById('annualSavingsGoal').value) || 0;
            let monthlySavingsTarget = parseFloat(document.getElementById('monthlySavingsTarget').value) || 0;
            const fixedExpenses = parseFloat(document.getElementById('fixedExpenses').value) || 0;
            const essentialExpenses = parseFloat(document.getElementById('essentialExpenses').value) || 0;
            const discretionaryExpenses = parseFloat(document.getElementById('discretionaryExpenses').value) || 0;

            // Auto-calculate net income if not manually overridden
            const calculatedNet = grossIncome - federalTax - provincialTax - cppEi;
            if (!document.getElementById('netIncome').dataset.manual) {
                document.getElementById('netIncome').value = calculatedNet > 0 ? calculatedNet.toFixed(2) : '';
                netIncome = calculatedNet;
            }

            // Auto-calculate monthly savings target (now always calculated from annual goal)
            const calculatedMonthlySavings = annualSavingsGoal / 12;
            document.getElementById('monthlySavingsTarget').value = calculatedMonthlySavings > 0 ? calculatedMonthlySavings.toFixed(2) : '';
            monthlySavingsTarget = calculatedMonthlySavings;

            // Calculate remaining budget
            const totalExpenses = fixedExpenses + essentialExpenses + discretionaryExpenses;
            const remainingBudget = netIncome - monthlySavingsTarget - totalExpenses;
            document.getElementById('remainingBudgetSummary').textContent = '$' + remainingBudget.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});

            // Calculate savings rate
            const savingsRate = netIncome > 0 ? (monthlySavingsTarget / netIncome) * 100 : 0;
            document.getElementById('savingsRateSummary').textContent = savingsRate.toFixed(1) + '%';

            // Validation
            let validation = '-';
            if (remainingBudget >= -10 && remainingBudget <= 10) {
                validation = 'âœ… Tight but feasible';
            } else if (remainingBudget > 10) {
                validation = 'âœ… Feasible';
            } else {
                validation = 'âš ï¸ Over budget';
            }
            document.getElementById('budgetValidationSummary').textContent = validation;
        }

        function loadSimpleBudgetSettings() {
            const savedSettings = localStorage.getItem('simpleBudgetSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                
                // Populate form fields with saved values
                document.getElementById('grossIncome').value = settings.grossIncome || '';
                document.getElementById('federalTax').value = settings.federalTax || '';
                document.getElementById('provincialTax').value = settings.provincialTax || '';
                document.getElementById('cppEi').value = settings.cppEi || '';
                document.getElementById('netIncome').value = settings.netIncome || '';
                document.getElementById('annualSavingsGoal').value = settings.annualSavingsGoal || '';
                document.getElementById('monthlySavingsTarget').value = settings.monthlySavingsTarget || '';
                document.getElementById('fixedExpenses').value = settings.fixedExpenses || '';
                document.getElementById('essentialExpenses').value = settings.essentialExpenses || '';
                document.getElementById('discretionaryExpenses').value = settings.discretionaryExpenses || '';
            } else {
                // Set default values based on your budget breakdown
                document.getElementById('grossIncome').value = '11667';
                document.getElementById('federalTax').value = '2500';
                document.getElementById('provincialTax').value = '750';
                document.getElementById('cppEi').value = '333';
                document.getElementById('netIncome').value = '8084';
                document.getElementById('annualSavingsGoal').value = '52000';
                document.getElementById('monthlySavingsTarget').value = '4333';
                document.getElementById('fixedExpenses').value = '2450';
                document.getElementById('essentialExpenses').value = '750';
                document.getElementById('discretionaryExpenses').value = '501';
            }
        }

        function saveSimpleBudgetSettings() {
            const settings = {
                grossIncome: parseFloat(document.getElementById('grossIncome').value) || 0,
                federalTax: parseFloat(document.getElementById('federalTax').value) || 0,
                provincialTax: parseFloat(document.getElementById('provincialTax').value) || 0,
                cppEi: parseFloat(document.getElementById('cppEi').value) || 0,
                netIncome: parseFloat(document.getElementById('netIncome').value) || 0,
                annualSavingsGoal: parseFloat(document.getElementById('annualSavingsGoal').value) || 0,
                monthlySavingsTarget: parseFloat(document.getElementById('monthlySavingsTarget').value) || 0,
                fixedExpenses: parseFloat(document.getElementById('fixedExpenses').value) || 0,
                essentialExpenses: parseFloat(document.getElementById('essentialExpenses').value) || 0,
                discretionaryExpenses: parseFloat(document.getElementById('discretionaryExpenses').value) || 0
            };
            
            console.log('Saving settings:', settings);
            localStorage.setItem('simpleBudgetSettings', JSON.stringify(settings));
            
            // Update all displays to reflect new settings
            updatePeriodView();
            updateReports();
            updateSaveScreen();
            
            // Update chart if on reports screen
            if (currentScreen === 2) {
                setTimeout(updateChart, 100);
            }
            
            alert('Settings saved! All budgets and targets have been updated.');
            closeSettings();
        }

        // Tax Calculator Functions
        const TAX_BRACKETS_2024 = {
            federal: [
                { min: 0, max: 55967, rate: 0.15 },
                { min: 55967, max: 111733, rate: 0.205 },
                { min: 111733, max: 173205, rate: 0.26 },
                { min: 173205, max: 246752, rate: 0.29 },
                { min: 246752, max: Infinity, rate: 0.33 }
            ],
            provinces: {
                ON: [ // Ontario
                    { min: 0, max: 51446, rate: 0.0505 },
                    { min: 51446, max: 102894, rate: 0.0915 },
                    { min: 102894, max: 150000, rate: 0.1116 },
                    { min: 150000, max: 220000, rate: 0.1216 },
                    { min: 220000, max: Infinity, rate: 0.1316 }
                ],
                BC: [ // British Columbia
                    { min: 0, max: 45654, rate: 0.0506 },
                    { min: 45654, max: 91310, rate: 0.077 },
                    { min: 91310, max: 104835, rate: 0.105 },
                    { min: 104835, max: 127299, rate: 0.1229 },
                    { min: 127299, max: 172602, rate: 0.147 },
                    { min: 172602, max: 240716, rate: 0.168 },
                    { min: 240716, max: Infinity, rate: 0.205 }
                ],
                AB: [ // Alberta
                    { min: 0, max: 148269, rate: 0.10 },
                    { min: 148269, max: 177922, rate: 0.12 },
                    { min: 177922, max: 237230, rate: 0.13 },
                    { min: 237230, max: 355845, rate: 0.14 },
                    { min: 355845, max: Infinity, rate: 0.15 }
                ],
                SK: [ // Saskatchewan
                    { min: 0, max: 52057, rate: 0.105 },
                    { min: 52057, max: 148734, rate: 0.125 },
                    { min: 148734, max: Infinity, rate: 0.145 }
                ],
                MB: [ // Manitoba
                    { min: 0, max: 36842, rate: 0.108 },
                    { min: 36842, max: 79625, rate: 0.1275 },
                    { min: 79625, max: Infinity, rate: 0.174 }
                ],
                QC: [ // Quebec
                    { min: 0, max: 49275, rate: 0.14 },
                    { min: 49275, max: 98540, rate: 0.19 },
                    { min: 98540, max: 119910, rate: 0.24 },
                    { min: 119910, max: Infinity, rate: 0.2575 }
                ],
                NB: [ // New Brunswick
                    { min: 0, max: 47715, rate: 0.0968 },
                    { min: 47715, max: 95431, rate: 0.1482 },
                    { min: 95431, max: 176756, rate: 0.1652 },
                    { min: 176756, max: Infinity, rate: 0.195 }
                ],
                NS: [ // Nova Scotia
                    { min: 0, max: 29590, rate: 0.0879 },
                    { min: 29590, max: 59180, rate: 0.1495 },
                    { min: 59180, max: 93000, rate: 0.1667 },
                    { min: 93000, max: 150000, rate: 0.175 },
                    { min: 150000, max: Infinity, rate: 0.21 }
                ],
                PE: [ // Prince Edward Island
                    { min: 0, max: 31984, rate: 0.098 },
                    { min: 31984, max: 63969, rate: 0.138 },
                    { min: 63969, max: Infinity, rate: 0.167 }
                ],
                NL: [ // Newfoundland and Labrador
                    { min: 0, max: 43198, rate: 0.087 },
                    { min: 43198, max: 86395, rate: 0.145 },
                    { min: 86395, max: 154244, rate: 0.158 },
                    { min: 154244, max: 215943, rate: 0.173 },
                    { min: 215943, max: 275870, rate: 0.183 },
                    { min: 275870, max: 551739, rate: 0.198 },
                    { min: 551739, max: 1103478, rate: 0.208 },
                    { min: 1103478, max: Infinity, rate: 0.218 }
                ],
                NT: [ // Northwest Territories
                    { min: 0, max: 50877, rate: 0.059 },
                    { min: 50877, max: 101754, rate: 0.086 },
                    { min: 101754, max: 165429, rate: 0.122 },
                    { min: 165429, max: Infinity, rate: 0.1405 }
                ],
                NU: [ // Nunavut
                    { min: 0, max: 50877, rate: 0.04 },
                    { min: 50877, max: 101754, rate: 0.07 },
                    { min: 101754, max: 165429, rate: 0.09 },
                    { min: 165429, max: Infinity, rate: 0.115 }
                ],
                YT: [ // Yukon
                    { min: 0, max: 55967, rate: 0.064 },
                    { min: 55967, max: 111733, rate: 0.09 },
                    { min: 111733, max: 173205, rate: 0.109 },
                    { min: 173205, max: 500000, rate: 0.128 },
                    { min: 500000, max: Infinity, rate: 0.15 }
                ]
            }
        };

        function calculateTaxes() {
            const yearlyIncome = parseFloat(document.getElementById('grossYearlyIncome').value) || 0;
            const province = document.getElementById('provinceValue').textContent;
            const provinceCode = getProvinceCode(province);
            
            if (yearlyIncome <= 0) {
                alert('Please enter a valid yearly income');
                return;
            }
            
            // Calculate federal tax
            const federalTax = calculateTax(yearlyIncome, TAX_BRACKETS_2024.federal);
            
            // Calculate provincial tax
            const provincialTax = calculateTax(yearlyIncome, TAX_BRACKETS_2024.provinces[provinceCode]);
            
            // Calculate CPP/EI (2024 rates)
            const cppContribution = Math.min(yearlyIncome, 68500) * 0.0595; // 5.95% up to $68,500
            const eiContribution = Math.min(yearlyIncome, 63100) * 0.0163; // 1.63% up to $63,100
            const totalCppEi = cppContribution + eiContribution;
            
            // Calculate monthly amounts
            const monthlyGross = yearlyIncome / 12;
            const monthlyFederalTax = federalTax / 12;
            const monthlyProvincialTax = provincialTax / 12;
            const monthlyCppEi = totalCppEi / 12;
            const monthlyNet = monthlyGross - monthlyFederalTax - monthlyProvincialTax - monthlyCppEi;
            
            // Display results
            document.getElementById('monthlyGrossResult').textContent = formatCurrency(monthlyGross);
            document.getElementById('federalTaxResult').textContent = formatCurrency(monthlyFederalTax);
            document.getElementById('provincialTaxResult').textContent = formatCurrency(monthlyProvincialTax);
            document.getElementById('cppEiResult').textContent = formatCurrency(monthlyCppEi);
            document.getElementById('netIncomeResult').textContent = formatCurrency(monthlyNet);
            
            // Show results section
            document.getElementById('taxResults').style.display = 'block';
            
            // Auto-populate manual override fields
            document.getElementById('grossIncome').value = monthlyGross.toFixed(2);
            document.getElementById('federalTax').value = monthlyFederalTax.toFixed(2);
            document.getElementById('provincialTax').value = monthlyProvincialTax.toFixed(2);
            document.getElementById('cppEi').value = monthlyCppEi.toFixed(2);
            document.getElementById('netIncome').value = monthlyNet.toFixed(2);
            
            // Update budget summary - this function is now deprecated since budget is in its own slide-out
            // updateSimpleBudgetSummary();
        }

        function calculateTax(income, brackets) {
            let totalTax = 0;
            
            for (let bracket of brackets) {
                if (income > bracket.min) {
                    const taxableInBracket = Math.min(income - bracket.min, bracket.max - bracket.min);
                    totalTax += taxableInBracket * bracket.rate;
                }
            }
            
            return totalTax;
        }

        function getProvinceCode(provinceName) {
            const provinceMap = {
                'Ontario': 'ON',
                'British Columbia': 'BC',
                'Alberta': 'AB',
                'Saskatchewan': 'SK',
                'Manitoba': 'MB',
                'Quebec': 'QC',
                'New Brunswick': 'NB',
                'Nova Scotia': 'NS',
                'Prince Edward Island': 'PE',
                'Newfoundland and Labrador': 'NL',
                'Northwest Territories': 'NT',
                'Nunavut': 'NU',
                'Yukon': 'YT'
            };
            return provinceMap[provinceName] || 'ON';
        }

        function toggleAccordion(id) {
            const header = document.querySelector(`[onclick="toggleAccordion('${id}')"]`);
            const content = document.getElementById(`${id}Content`);
            const icon = document.getElementById(`${id}Icon`);
            
            const isExpanded = header.classList.contains('expanded');
            
            if (isExpanded) {
                // Collapse
                header.classList.remove('expanded');
                content.classList.remove('expanded');
            } else {
                // Expand
                header.classList.add('expanded');
                content.classList.add('expanded');
            }
        }

        // Add event listeners for settings inputs
        document.addEventListener('DOMContentLoaded', function() {
            // Budget form event listeners are now handled in the budget slide-out
            // The old settings form elements no longer exist

            // Setup province dropdown
            const provinceItems = document.querySelectorAll('#provinceContent .select-item');
            provinceItems.forEach(item => {
                item.addEventListener('click', function() {
                    const value = this.getAttribute('data-value');
                    const text = this.textContent;
                    selectSlideOutOption('province', value, text);
                });
            });
            
            // Setup budget province dropdown
            const budgetProvinceItems = document.querySelectorAll('#budgetProvinceContent .select-item');
            budgetProvinceItems.forEach(item => {
                item.addEventListener('click', function() {
                    const value = this.getAttribute('data-value');
                    const text = this.textContent;
                    selectSlideOutOption('budgetProvince', value, text);
                });
            });
            
            // Add event listeners for budget form inputs
            ['budgetGrossYearlyIncome','budgetGrossIncome','budgetFederalTax','budgetProvincialTax','budgetCppEi','budgetNetIncome','budgetAnnualSavingsGoal','budgetFixedExpenses','budgetEssentialExpenses','budgetDiscretionaryExpenses'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', function() {
                        updateBudgetSummary();
                    });
                }
            });
        });

        function openBudgetSetup() {
            // Don't close settings, just slide to budget setup
            const budgetOverlay = document.getElementById('budgetOverlay');
            const budgetPanel = document.getElementById('budgetPanel');
            const settingsPanel = document.getElementById('settingsPanel');
            
            // Show budget overlay and panel
            budgetOverlay.classList.add('active');
            budgetPanel.classList.add('active');
            
            // Slide settings panel left
            settingsPanel.classList.add('budget-open');
            
            // Load existing settings into budget form
            loadBudgetSettings();
        }
        
        function closeBudgetSetup() {
            const budgetOverlay = document.getElementById('budgetOverlay');
            const budgetPanel = document.getElementById('budgetPanel');
            const settingsPanel = document.getElementById('settingsPanel');
            
            // Hide budget overlay and panel
            budgetOverlay.classList.remove('active');
            budgetPanel.classList.remove('active');
            
            // Slide settings panel back to center
            settingsPanel.classList.remove('budget-open');
        }
        
        function loadBudgetSettings() {
            const settings = getSimpleBudgetSettings();
            
            // Populate form fields with existing settings
            document.getElementById('budgetGrossYearlyIncome').value = settings.grossYearlyIncome || '';
            document.getElementById('budgetProvinceValue').textContent = settings.province || 'Ontario';
            document.getElementById('budgetGrossIncome').value = settings.grossIncome || '';
            document.getElementById('budgetFederalTax').value = settings.federalTax || '';
            document.getElementById('budgetProvincialTax').value = settings.provincialTax || '';
            document.getElementById('budgetCppEi').value = settings.cppEi || '';
            document.getElementById('budgetNetIncome').value = settings.netIncome || '';
            document.getElementById('budgetAnnualSavingsGoal').value = settings.annualSavingsGoal || '';
            document.getElementById('budgetFixedExpenses').value = settings.fixedExpenses || '';
            document.getElementById('budgetEssentialExpenses').value = settings.essentialExpenses || '';
            document.getElementById('budgetDiscretionaryExpenses').value = settings.discretionaryExpenses || '';
            
            // Update budget summary
            updateBudgetSummary();
        }
        
        function calculateBudgetTaxes() {
            const yearlyIncome = parseFloat(document.getElementById('budgetGrossYearlyIncome').value) || 0;
            const province = document.getElementById('budgetProvinceValue').textContent;
            const provinceCode = getProvinceCode(province);
            
            if (yearlyIncome <= 0) {
                alert('Please enter a valid yearly income');
                return;
            }
            
            // Calculate federal tax
            const federalTax = calculateTax(yearlyIncome, TAX_BRACKETS_2024.federal);
            
            // Calculate provincial tax
            const provincialTax = calculateTax(yearlyIncome, TAX_BRACKETS_2024.provinces[provinceCode]);
            
            // Calculate CPP/EI (2024 rates)
            const cppContribution = Math.min(yearlyIncome, 68500) * 0.0595; // 5.95% up to $68,500
            const eiContribution = Math.min(yearlyIncome, 63100) * 0.0163; // 1.63% up to $63,100
            const totalCppEi = cppContribution + eiContribution;
            
            // Calculate monthly amounts
            const monthlyGross = yearlyIncome / 12;
            const monthlyFederalTax = federalTax / 12;
            const monthlyProvincialTax = provincialTax / 12;
            const monthlyCppEi = totalCppEi / 12;
            const monthlyNet = monthlyGross - monthlyFederalTax - monthlyProvincialTax - monthlyCppEi;
            
            // Display results
            document.getElementById('budgetMonthlyGrossResult').textContent = formatCurrency(monthlyGross);
            document.getElementById('budgetFederalTaxResult').textContent = formatCurrency(monthlyFederalTax);
            document.getElementById('budgetProvincialTaxResult').textContent = formatCurrency(monthlyProvincialTax);
            document.getElementById('budgetCppEiResult').textContent = formatCurrency(monthlyCppEi);
            document.getElementById('budgetNetIncomeResult').textContent = formatCurrency(monthlyNet);
            
            // Show results section
            document.getElementById('budgetTaxResults').style.display = 'block';
            
            // Auto-populate manual override fields
            document.getElementById('budgetGrossIncome').value = monthlyGross.toFixed(2);
            document.getElementById('budgetFederalTax').value = monthlyFederalTax.toFixed(2);
            document.getElementById('budgetProvincialTax').value = monthlyProvincialTax.toFixed(2);
            document.getElementById('budgetCppEi').value = monthlyCppEi.toFixed(2);
            document.getElementById('budgetNetIncome').value = monthlyNet.toFixed(2);
            
            // Update budget summary
            updateBudgetSummary();
        }
        
        function updateBudgetSummary() {
            const grossIncome = parseFloat(document.getElementById('budgetGrossIncome').value) || 0;
            const federalTax = parseFloat(document.getElementById('budgetFederalTax').value) || 0;
            const provincialTax = parseFloat(document.getElementById('budgetProvincialTax').value) || 0;
            const cppEi = parseFloat(document.getElementById('budgetCppEi').value) || 0;
            const netIncome = parseFloat(document.getElementById('budgetNetIncome').value) || 0;
            const annualSavingsGoal = parseFloat(document.getElementById('budgetAnnualSavingsGoal').value) || 0;
            const fixedExpenses = parseFloat(document.getElementById('budgetFixedExpenses').value) || 0;
            const essentialExpenses = parseFloat(document.getElementById('budgetEssentialExpenses').value) || 0;
            const discretionaryExpenses = parseFloat(document.getElementById('budgetDiscretionaryExpenses').value) || 0;
            
            // Calculate monthly savings target
            const monthlySavingsTarget = annualSavingsGoal / 12;
            document.getElementById('budgetMonthlySavingsTarget').value = monthlySavingsTarget.toFixed(2);
            
            // Calculate remaining budget
            const totalExpenses = fixedExpenses + essentialExpenses + discretionaryExpenses + monthlySavingsTarget;
            const remainingBudget = netIncome - totalExpenses;
            
            // Calculate savings rate
            const savingsRate = netIncome > 0 ? (monthlySavingsTarget / netIncome) * 100 : 0;
            
            // Update summary display
            document.getElementById('budgetRemainingBudgetSummary').textContent = formatCurrency(remainingBudget);
            document.getElementById('budgetSavingsRateSummary').textContent = savingsRate.toFixed(1) + '%';
            
            // Validation
            let validationText = '-';
            let validationClass = '';
            
            if (remainingBudget < 0) {
                validationText = 'Over Budget';
                validationClass = 'negative';
            } else if (remainingBudget < 100) {
                validationText = 'Tight Budget';
                validationClass = 'warning';
            } else {
                validationText = 'Good Budget';
                validationClass = 'positive';
            }
            
            const validationElement = document.getElementById('budgetValidationSummary');
            validationElement.textContent = validationText;
            validationElement.className = 'budget-value ' + validationClass;
        }
        
        function saveBudgetSettings() {
            const settings = {
                grossYearlyIncome: parseFloat(document.getElementById('budgetGrossYearlyIncome').value) || 0,
                province: document.getElementById('budgetProvinceValue').textContent,
                grossIncome: parseFloat(document.getElementById('budgetGrossIncome').value) || 0,
                federalTax: parseFloat(document.getElementById('budgetFederalTax').value) || 0,
                provincialTax: parseFloat(document.getElementById('budgetProvincialTax').value) || 0,
                cppEi: parseFloat(document.getElementById('budgetCppEi').value) || 0,
                netIncome: parseFloat(document.getElementById('budgetNetIncome').value) || 0,
                annualSavingsGoal: parseFloat(document.getElementById('budgetAnnualSavingsGoal').value) || 0,
                fixedExpenses: parseFloat(document.getElementById('budgetFixedExpenses').value) || 0,
                essentialExpenses: parseFloat(document.getElementById('budgetEssentialExpenses').value) || 0,
                discretionaryExpenses: parseFloat(document.getElementById('budgetDiscretionaryExpenses').value) || 0
            };
            
            localStorage.setItem('simpleBudgetSettings', JSON.stringify(settings));
            
            // Update the main app's budget display
            updateBudgetDisplay();
            
            // Close the budget setup
            closeBudgetSetup();
            
            // Show success message
            alert('Budget settings saved successfully!');
        }
        function loadSampleBudget() {
            loadTestData();
        }
        
        function clearAllData() {
            // Confirm before clearing all data
            if (confirm("Are you sure you want to clear all data? This action cannot be undone.")) {
                try {
                    // Clear all application-related data from localStorage
                    const keysToRemove = [
                        'accountBalances',
                        'dailyExpenses',
                        'expenses',
                        'simpleBudgetSettings',
                        'savingsAccounts',
                        'budgetSettings'
                    ];
                    
                    // Clear each key
                    keysToRemove.forEach(key => {
                        console.log(`Removing localStorage key: ${key}`);
                        localStorage.removeItem(key);
                    });
                    
                    // For additional safety, clear all localStorage
                    console.log('Clearing all localStorage');
                    localStorage.clear();
                    
                    // Reload the page to reflect changes
                    alert("All data has been cleared successfully.");
                    window.location.reload();
                } catch (error) {
                    console.error('Error clearing data:', error);
                    alert("An error occurred while clearing data.");
                }
            }
        }
        
        function openSupport() {
            // Don't close settings, just slide to support page
            const supportOverlay = document.getElementById('supportOverlay');
            const supportPanel = document.getElementById('supportPanel');
            const settingsPanel = document.getElementById('settingsPanel');
            
            // Show support overlay and panel
            supportOverlay.classList.add('active');
            supportPanel.classList.add('active');
            
            // Slide settings panel left
            settingsPanel.classList.add('budget-open');
        }
        
        function closeSupport() {
            const supportOverlay = document.getElementById('supportOverlay');
            const supportPanel = document.getElementById('supportPanel');
            const settingsPanel = document.getElementById('settingsPanel');
            
            // Hide support overlay and panel
            supportOverlay.classList.remove('active');
            supportPanel.classList.remove('active');
            
            // Slide settings panel back to center
            settingsPanel.classList.remove('budget-open');
            
            // Clear form fields
            document.getElementById('supportTitle').value = '';
            document.getElementById('supportDescription').value = '';
        }
        
        function sendSupportEmail() {
            const title = document.getElementById('supportTitle').value.trim();
            const description = document.getElementById('supportDescription').value.trim();
            
            if (!title || !description) {
                alert('Please fill in both subject and message fields.');
                return;
            }
            
            // Create mailto link
            const subject = encodeURIComponent(`Expense Tracker Support: ${title}`);
            const body = encodeURIComponent(`Subject: ${title}\n\nMessage:\n${description}\n\n---\nSent from Expense Tracker App`);
            const mailtoLink = `mailto:wdean.francis@gmail.com?subject=${subject}&body=${body}`;
            
            // Open email client
            window.location.href = mailtoLink;
            
            // Close support page
            closeSupport();
            
            // Show success message
            alert('Email client opened! Please send the email to complete your support request.');
        }
        function backToSettingsMenu() {
            document.getElementById('settingsForm').style.display = 'none';
            document.getElementById('settingsMenu').style.display = '';
        }


        // --- Expense Editing Support ---
        let editingExpense = null;
        function editExpense(date, timestamp) {
            const expenses = loadExpenses();
            const expenseList = expenses[date] || [];
            const expense = expenseList.find(e => e.timestamp === Number(timestamp));
            if (!expense) return;
            editingExpense = { date, timestamp: Number(timestamp) };
            showExpenseSlideOut();
            // Set date (for month mode)
            if (currentPeriodMode === 'month') {
                const datepickerId = 'expenseCustomDatepicker';
                if (!datepickerStates[datepickerId]) {
                    initializeDatepicker(datepickerId);
                }
                const state = datepickerStates[datepickerId];
                // Parse date properly to avoid timezone issues
                const dateParts = date.split('-').map(Number);
                state.selectedDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
                updateDatepickerValue(datepickerId);
                renderCalendar(datepickerId);
            }
            document.getElementById('slideOutExpenseAmount').value = expense.amount;
            selectSlideOutOption('expenseCategory', expense.category, capitalizeFirstLetter(expense.category));
            document.getElementById('slideOutExpenseDescription').value = expense.description || '';
            // Change CTA text and handler
            const ctaBtn = document.querySelector('.slide-out-form .add-btn');
            if (ctaBtn) {
                ctaBtn.textContent = 'Save Expense';
                ctaBtn.onclick = saveEditedExpense;
            }
        }
        function saveEditedExpense() {
            if (!editingExpense) return;
            const amount = parseFloat(document.getElementById('slideOutExpenseAmount').value);
            const category = document.getElementById('slideOutExpenseCategory').value;
            const description = document.getElementById('slideOutExpenseDescription').value;
            let targetDate = currentPeriodMode === 'month'
                ? document.getElementById('slideOutExpenseDate').value
                : getCurrentDate();
            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            if (!category) {
                alert('Please select a category');
                return;
            }
            const expenses = loadExpenses();
            // Remove the old expense and get its index
            let oldList = expenses[editingExpense.date] || [];
            const oldIndex = oldList.findIndex(e => e.timestamp === editingExpense.timestamp);
            const oldExpense = oldList.find(e => e.timestamp === editingExpense.timestamp);
            
            // Preserve the original created timestamp
            const created = oldExpense && oldExpense.created ? oldExpense.created : editingExpense.timestamp;
            
            // Remove the old expense
            oldList = oldList.filter(e => e.timestamp !== editingExpense.timestamp);
            expenses[editingExpense.date] = oldList;
            
            // Create the updated expense
            const updatedExpense = {
                amount,
                category,
                description: description || '',
                timestamp: editingExpense.timestamp,
                created: created, // Preserve original created timestamp
                updated: Date.now()
            };
            
            // Add the updated expense at the same index if date is unchanged, else push to new date
            if (!expenses[targetDate]) expenses[targetDate] = [];
            
            if (editingExpense.date === targetDate && oldIndex !== -1) {
                // Insert at the same position to maintain order
                expenses[targetDate].splice(oldIndex, 0, updatedExpense);
            } else {
                // If date changed, add to the end of the new date's list
                expenses[targetDate].push(updatedExpense);
            }
            saveExpenses(expenses);
            // Reset form and editing state
            document.getElementById('slideOutExpenseAmount').value = '';
            document.getElementById('slideOutExpenseDescription').value = '';
            selectSlideOutOption('expenseCategory', 'groceries', 'Groceries');
            if (currentPeriodMode === 'month') clearDate('expenseCustomDatepicker');
            editingExpense = null;
            // Restore CTA
            const ctaBtn = document.querySelector('.slide-out-form .add-btn');
            if (ctaBtn) {
                ctaBtn.textContent = 'Add Expense';
                ctaBtn.onclick = addExpenseFromSlideOut;
            }
            hideExpenseSlideOut();
            updatePeriodView();
            updateChart();
        }
        function capitalizeFirstLetter(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
        function handleExpenseDelete(element, e) {
            // Use the provided event or the global event
            const evt = e || window.event;
            
            // Stop propagation immediately to prevent any click events from bubbling
            if (evt) {
                evt.preventDefault();
                evt.stopPropagation();
            }
            
            console.log('handleExpenseDelete called');
            
            // Find the parent swipe-container and get its data attributes
            const container = element.closest('.swipe-container');
            if (!container) {
                console.error('Could not find parent swipe container');
                return;
            }
            
            // Get expense data from the container
            const date = container.dataset.date;
            const timestamp = container.dataset.timestamp;
            
            console.log('Expense data from container:', { date, timestamp });
            
            if (!date || !timestamp) {
                console.error('Missing date or timestamp for expense deletion');
                return;
            }
            
            // Add visual feedback - mark container as deleting
            container.classList.add('deleting');
            
            // Call deleteExpense with the data after a short delay to allow animation
            setTimeout(() => {
                deleteExpense(date, timestamp);
            }, 10); // Short timeout to ensure animation starts
}

        function handleBalanceDelete(element, e) {
            // Use the provided event or the global event
            const evt = e || window.event;
            
            // Stop propagation immediately to prevent any click events from bubbling
            if (evt) {
                evt.preventDefault();
                evt.stopPropagation();
            }
            
            console.log('handleBalanceDelete called');
            
            // Find the parent swipe-container and get its data attributes
            const container = element.closest('.swipe-container');
            if (!container) {
                console.error('Could not find parent swipe container');
                return;
            }
            
            // Get balance data from the container
            const accountId = container.dataset.accountId;
            const date = container.dataset.date;
            
            console.log('Balance data from container:', { accountId, date });
            
            if (!accountId || !date) {
                console.error('Missing accountId or date for balance deletion');
                return;
            }
            
            // Add visual feedback - mark container as deleting
            container.classList.add('deleting');
            
            // Call deleteBalance with the data
            setTimeout(() => {
                deleteBalance(accountId, date);
            }, 10); // Short timeout to ensure animation starts
        }


    </script>
</body>
</html>
</html>